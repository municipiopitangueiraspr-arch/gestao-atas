<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìã Gest√£o de Atas - Pedido com Lote + CRUD √ìrg√£os + PEDIDO_REALIZADO</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- SUPABASE JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* ========================================= */
        /* SISTEMA DE GEST√ÉO DE ATAS - UI OTIMIZADA */
        /* ========================================= */

        /* Vari√°veis CSS - Paleta Moderna */
        :root {
            --primary-50: #eef2ff;
            --primary-100: #e0e7ff;
            --primary-200: #c7d2fe;
            --primary-300: #a5b4fc;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;
            --primary-800: #3730a3;
            --primary-900: #312e81;

            --success-50: #ecfdf5;
            --success-100: #d1fae5;
            --success-200: #a7f3d0;
            --success-300: #6ee7b7;
            --success-400: #34d399;
            --success-500: #10b981;
            --success-600: #059669;
            --success-700: #047857;
            --success-800: #065f46;
            --success-900: #064e3b;

            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-200: #fde68a;
            --warning-300: #fcd34d;
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;
            --warning-800: #92400e;
            --warning-900: #78350f;

            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-200: #fecaca;
            --error-300: #fca5a5;
            --error-400: #f87171;
            --error-500: #ef4444;
            --error-600: #dc2626;
            --error-700: #b91c1c;
            --error-800: #991b1b;
            --error-900: #7f1d1d;

            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius-sm: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            --border-radius-2xl: 1.25rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f1f5f9 0%, #e6edf5 100%);
            color: var(--neutral-900);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
        }

        .app {
            max-width: 1440px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Anima√ß√µes Globais */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== TELA DE LOGIN ===== */
        .login-container {
            max-width: 400px;
            margin: 60px auto;
            background: white;
            border-radius: var(--border-radius-2xl);
            padding: 36px 32px;
            box-shadow: var(--shadow-xl);
            animation: fadeIn 0.5s ease-out;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-size: 1.8rem;
            color: var(--primary-700);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-header i {
            font-size: 3.5rem;
            color: var(--primary-600);
            margin-bottom: 16px;
        }

        .login-header p {
            color: var(--neutral-500);
            font-size: 0.95rem;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 6px;
        }

        .login-form input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-lg);
            font-size: 0.95rem;
            transition: var(--transition-base);
            background: var(--neutral-50);
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
            background: white;
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border: none;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .login-error {
            color: var(--error-700);
            margin-top: 16px;
            text-align: center;
            padding: 10px;
            background: var(--error-50);
            border-radius: var(--border-radius-lg);
            display: none;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--neutral-900), var(--neutral-800));
            color: white;
            padding: 20px 28px;
            border-radius: var(--border-radius-2xl);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: var(--shadow-xl);
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .header h1 i {
            color: var(--warning-400);
            margin-right: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 60px;
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--warning-400), var(--warning-500));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--neutral-900);
            font-weight: 700;
            font-size: 0.9rem;
        }

        .user-name {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--neutral-300);
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 18px;
            border-radius: 40px;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== TABS PRINCIPAIS ===== */
        .tabs-principais {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: var(--border-radius-2xl);
            box-shadow: var(--shadow-lg);
        }

        .tab-principal {
            padding: 10px 14px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition-base);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--neutral-600);
            font-size: 0.9rem;
        }

        .tab-principal:hover {
            color: var(--primary-700);
            background: var(--neutral-50);
        }

        .tab-principal.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
        }

        /* ===== GEST√ÉO DE USU√ÅRIOS E √ìRG√ÉOS ===== */
        .usuarios-container,
        .orgaos-container {
            background: white;
            border-radius: var(--border-radius-2xl);
            padding: 24px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 24px;
        }

        .usuarios-header,
        .orgaos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .btn-novo-usuario,
        .btn-novo-orgao {
            background: linear-gradient(135deg, var(--success-600), var(--success-700));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition-base);
        }

        .btn-novo-usuario:hover,
        .btn-novo-orgao:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-editar-usuario,
        .btn-editar-orgao,
        .btn-desativar-usuario,
        .btn-desativar-orgao {
            background: none;
            border: none;
            cursor: pointer;
            margin: 0 4px;
            padding: 6px;
            border-radius: var(--border-radius-md);
            transition: var(--transition-base);
        }

        .btn-editar-usuario,
        .btn-editar-orgao {
            color: var(--primary-600);
        }

        .btn-editar-usuario:hover,
        .btn-editar-orgao:hover {
            background: var(--primary-50);
            color: var(--primary-700);
        }

        .btn-desativar-usuario,
        .btn-desativar-orgao {
            color: var(--error-600);
        }

        .btn-desativar-usuario:hover,
        .btn-desativar-orgao:hover {
            background: var(--error-50);
            color: var(--error-700);
        }

        .tabela-usuarios,
        .tabela-orgaos {
            width: 100%;
            border-collapse: collapse;
        }

        .tabela-usuarios th,
        .tabela-orgaos th {
            background: var(--neutral-50);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--neutral-700);
            border-bottom: 2px solid var(--neutral-200);
            font-size: 0.85rem;
        }

        .tabela-usuarios td,
        .tabela-orgaos td {
            padding: 12px;
            border-bottom: 1px solid var(--neutral-200);
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .badge-perfil {
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
        }

        .perfil-admin {
            background: linear-gradient(135deg, var(--error-100), var(--error-200));
            color: var(--error-800);
        }

        .perfil-secretario {
            background: linear-gradient(135deg, var(--success-100), var(--success-200));
            color: var(--success-800);
        }

        .perfil-solicitante {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
            color: var(--primary-800);
        }

        .perfil-estagiario {
            background: linear-gradient(135deg, var(--warning-100), var(--warning-200));
            color: var(--warning-800);
        }

        .status-ativo {
            background: linear-gradient(135deg, var(--success-100), var(--success-200));
            color: var(--success-800);
        }

        .status-inativo {
            background: linear-gradient(135deg, var(--error-100), var(--error-200));
            color: var(--error-800);
        }

        /* ===== FILTROS ===== */
        .filtros-container {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius-2xl);
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .filtro-grupo {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filtro-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--neutral-700);
            text-transform: uppercase;
        }

        .filtro-input,
        .filtro-select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-lg);
            font-size: 0.9rem;
            transition: var(--transition-base);
            background: var(--neutral-50);
        }

        .filtro-input:focus,
        .filtro-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        /* ===== LISTA DE ATAS ===== */
        .atas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .ata-card {
            background: white;
            border-radius: var(--border-radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition-base);
            border: 1px solid var(--neutral-200);
            cursor: pointer;
        }

        .ata-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
        }

        .ata-header {
            padding: 18px;
            border-bottom: 1px solid var(--neutral-200);
            background: linear-gradient(135deg, white, var(--neutral-50));
        }

        .ata-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 40px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-ativa {
            background: linear-gradient(135deg, var(--success-100), var(--success-200));
            color: var(--success-800);
        }

        .status-proxima {
            background: linear-gradient(135deg, var(--warning-100), var(--warning-200));
            color: var(--warning-800);
        }

        .status-vencida {
            background: linear-gradient(135deg, var(--error-100), var(--error-200));
            color: var(--error-800);
        }

        .ata-numero {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: 8px;
        }

        .ata-fornecedor {
            color: var(--neutral-600);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .ata-footer {
            padding: 16px 18px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-visualizar {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-visualizar:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius-2xl);
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--neutral-200);
        }

        .modal-titulo {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--neutral-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--neutral-500);
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition-base);
        }

        .modal-close:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }

        /* ===== DETALHES DA ATA ===== */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            background: linear-gradient(135deg, var(--neutral-50), white);
            padding: 20px;
            border-radius: var(--border-radius-xl);
            margin-bottom: 24px;
            border: 1px solid var(--neutral-200);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--neutral-500);
            font-weight: 600;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--neutral-900);
        }

        /* ===== TABELA DE ITENS ===== */
        .tabela-container {
            overflow-x: auto;
            margin-bottom: 24px;
            width: 100%;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--neutral-200);
            background: white;
        }

        .tabela-itens {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .tabela-itens th {
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: white;
        }

        .tabela-itens td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--neutral-200);
            vertical-align: middle;
            background: white;
        }

        .numeric {
            text-align: right;
        }

        .saldo-alto {
            color: var(--success-700);
            font-weight: 600;
        }

        .saldo-baixo {
            color: var(--warning-700);
            font-weight: 600;
        }

        .saldo-zerado {
            color: var(--error-700);
            font-weight: 600;
        }

        .progresso-container {
            width: 80px;
            height: 6px;
            background: var(--neutral-200);
            border-radius: 20px;
            overflow: hidden;
        }

        .progresso-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            border-radius: 20px;
            transition: width 0.3s;
        }

        /* ===== LOTE TAG ===== */
        .lote-tag {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
            color: var(--primary-800);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }

        /* ===== A√á√ïES ===== */
        .acoes-item {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-consumo,
        .btn-pedido,
        .btn-lancar-rapido {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-consumo,
        .btn-lancar-rapido {
            background: var(--warning-600);
            color: white;
        }

        .btn-consumo:hover,
        .btn-lancar-rapido:hover {
            background: var(--warning-700);
        }

        .btn-pedido {
            background: var(--primary-600);
            color: white;
        }

        .btn-pedido:hover {
            background: var(--primary-700);
        }

        /* ===== CARRINHO ===== */
        .carrinho-indicator {
            background: linear-gradient(135deg, var(--warning-50), var(--warning-100));
            padding: 12px 20px;
            border-radius: 60px;
            color: var(--warning-800);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            border: 1px solid var(--warning-200);
            font-size: 0.9rem;
        }

        .btn-gerar-pedido {
            padding: 10px 20px;
            background: var(--success-600);
            color: white;
            border: none;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .btn-gerar-pedido:hover {
            background: var(--success-700);
            transform: translateY(-2px);
        }

        /* ===== GEST√ÉO DE ITENS ===== */
        .gestao-container {
            width: 100%;
            background: white;
            border-radius: var(--border-radius-2xl);
            padding: 24px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 24px;
        }

        .gestao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .gestao-titulo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--neutral-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gestao-filtros {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .gestao-select {
            min-width: 280px;
            padding: 10px 16px;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-lg);
            font-size: 0.9rem;
            background: white;
            transition: var(--transition-base);
        }

        .gestao-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .gestao-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--border-radius-xl);
            border: 1px solid var(--neutral-200);
            flex-wrap: wrap;
        }

        .gestao-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--neutral-500);
            font-weight: 600;
        }

        .gestao-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--neutral-900);
        }

        .gestao-tabela-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--neutral-200);
            margin-top: 20px;
        }

        .gestao-tabela {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 800px;
        }

        .gestao-tabela th {
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: white;
        }

        .gestao-tabela td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--neutral-200);
            background: white;
        }

        .gestao-tabela tr:hover td {
            background: var(--neutral-50);
        }

        /* ===== FILTROS DA GEST√ÉO ===== */
        .filtros-gestao {
            background: var(--neutral-50);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--neutral-200);
        }

        .filtros-gestao .filtro-row {
            margin-bottom: 12px;
        }

        .filtros-gestao .filtro-busca {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-lg);
            padding: 0 14px;
        }

        .filtros-gestao .filtro-busca i {
            color: var(--neutral-400);
        }

        .filtros-gestao .filtro-busca input {
            flex: 1;
            padding: 10px 0;
            border: none;
            outline: none;
            font-size: 0.9rem;
        }

        .filtros-gestao .filtro-grid-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .filtros-gestao .filtro-checkboxes {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 16px;
        }

        .filtros-gestao .filtro-checkboxes label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--neutral-700);
            font-weight: 500;
            font-size: 0.85rem;
        }

        .filtros-gestao .filtro-checkboxes input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary-600);
        }

        .filtros-gestao .filtro-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-aplicar,
        .btn-limpar,
        .btn-exportar {
            padding: 8px 18px;
            border: none;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .btn-aplicar {
            background: var(--primary-600);
            color: white;
        }

        .btn-aplicar:hover {
            background: var(--primary-700);
            transform: translateY(-2px);
        }

        .btn-limpar {
            background: var(--neutral-200);
            color: var(--neutral-700);
        }

        .btn-limpar:hover {
            background: var(--neutral-300);
        }

        .btn-exportar {
            background: var(--success-600);
            color: white;
        }

        .btn-exportar:hover {
            background: var(--success-700);
            transform: translateY(-2px);
        }

        /* Status Editor na Gest√£o */
        .status-editor {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--neutral-50);
            padding: 12px 16px;
            border-radius: var(--border-radius-lg);
            margin-top: 12px;
            border: 1px solid var(--neutral-200);
        }

        .status-editor span {
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.85rem;
        }

        .status-select {
            padding: 6px 12px;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            outline: none;
            font-size: 0.85rem;
        }

        .status-select option[value="ATIVA"] {
            background-color: var(--success-100);
            color: var(--success-800);
        }

        .status-select option[value="PROXIMA"] {
            background-color: var(--warning-100);
            color: var(--warning-800);
        }

        .status-select option[value="VENCIDA"] {
            background-color: var(--error-100);
            color: var(--error-800);
        }

        .btn-status {
            background: var(--primary-600);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .btn-status:hover {
            background: var(--primary-700);
        }

        .btn-status:disabled {
            background: var(--neutral-400);
            cursor: not-allowed;
        }

        /* ===== CADASTRO DE ATA ===== */
        .cadastro-container {
            background: white;
            border-radius: var(--border-radius-2xl);
            padding: 28px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 24px;
        }

        .cadastro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--neutral-200);
        }

        .cadastro-titulo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--neutral-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-extracao {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition-base);
        }

        .btn-extracao:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .cadastro-secao {
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--neutral-200);
        }

        .secao-titulo {
            font-size: 1rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--neutral-300);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 18px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--neutral-700);
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 14px;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-lg);
            font-size: 0.9rem;
            width: 100%;
            transition: var(--transition-base);
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px var(--primary-100);
        }

        .itens-cadastro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .btn-adicionar-item {
            background: linear-gradient(135deg, var(--success-600), var(--success-700));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition-base);
        }

        .btn-adicionar-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .tabela-itens-cadastro {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .tabela-itens-cadastro th {
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: white;
        }

        .tabela-itens-cadastro td {
            padding: 10px;
            border-bottom: 1px solid var(--neutral-200);
            background: white;
        }

        .btn-remover-item {
            background: none;
            border: none;
            color: var(--error-600);
            cursor: pointer;
            padding: 6px;
            border-radius: var(--border-radius-md);
            transition: var(--transition-base);
        }

        .btn-remover-item:hover {
            background: var(--error-50);
            color: var(--error-700);
        }

        .btn-salvar-ata {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            font-size: 1rem;
            transition: var(--transition-base);
        }

        .btn-salvar-ata:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ===== PEDIDO ===== */
        .pedido-container {
            background: white;
            border-radius: var(--border-radius-2xl);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid var(--neutral-200);
            box-shadow: var(--shadow-xl);
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 3px dashed var(--primary-500);
        }

        .pedido-titulo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--neutral-900);
        }

        .pedido-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--border-radius-xl);
        }

        .btn-pdf {
            background: var(--error-600);
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition-base);
        }

        .btn-pdf:hover {
            background: var(--error-700);
            transform: translateY(-2px);
        }

        /* ===== PDF VISUALIZADOR ===== */
        .pdf-visualizador {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .pdf-visualizador.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .pdf-content {
            background: white;
            border-radius: var(--border-radius-2xl);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px;
            box-shadow: var(--shadow-xl);
        }

        .pdf-pagina {
            background: white;
            border: 1px solid var(--neutral-200);
            margin-bottom: 16px;
            padding: 28px;
            border-radius: var(--border-radius-lg);
        }

        /* ===== LOADING ===== */
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: var(--primary-600);
            font-size: 1rem;
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 1200px) {
            .tabs-principais {
                grid-template-columns: repeat(3, 1fr);
            }
            .filtros-gestao .filtro-grid-3col {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .app { padding: 10px; }
            .tabs-principais { grid-template-columns: repeat(2, 1fr); }
            .atas-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 20px; }
            .gestao-filtros { flex-direction: column; width: 100%; }
            .gestao-select { width: 100%; min-width: auto; }
            .filtros-gestao .filtro-grid-3col { grid-template-columns: 1fr; }
            .filtros-gestao .filtro-checkboxes { flex-direction: column; align-items: flex-start; gap: 10px; }
            .filtros-gestao .filtro-actions { flex-direction: column; }
            .status-editor { flex-direction: column; align-items: flex-start; }
        }

        @media (max-width: 480px) {
            .tabs-principais { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.3rem; }
            .pedido-header { flex-direction: column; gap: 12px; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <i class="fas fa-file-contract"></i>
            <h1>Gest√£o de Atas</h1>
            <p>Fa√ßa login com seu e-mail institucional</p>
        </div>
        <div class="login-form">
            <div class="form-group">
                <label><i class="fas fa-envelope"></i> E-mail</label>
                <input type="email" id="loginEmail" class="filtro-input" placeholder="seu@email.com" autocomplete="email" required />
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> Senha</label>
                <input type="password" id="loginSenha" class="filtro-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />
            </div>
            <button class="btn-login" onclick="sistema.fazerLogin()">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div id="mainSystem" class="app" style="display: none">
        <!-- HEADER -->
        <header class="header">
            <div>
                <h1><i class="fas fa-file-contract"></i> Gest√£o de Atas</h1>
                <p style="color: #cbd5e1; font-size: 0.85rem;">Controle com LOTE, √ìrg√£os e Pedidos</p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">SC</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Carregando...</div>
                        <div class="user-role" id="userRole">...</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="sistema.fazerLogout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </header>

        <!-- TABS PRINCIPAIS -->
        <div class="tabs-principais" id="mainTabs">
            <div id="tabConsulta" class="tab-principal active" onclick="sistema.ativarTab('consulta')">
                <i class="fas fa-search"></i> Consulta
            </div>
            <div id="tabGestao" class="tab-principal" onclick="sistema.ativarTab('gestao')">
                <i class="fas fa-boxes"></i> Gest√£o
            </div>
            <div id="tabCadastro" class="tab-principal" onclick="sistema.ativarTab('cadastro')">
                <i class="fas fa-plus-circle"></i> Cadastrar Ata
            </div>
            <div id="tabPedidos" class="tab-principal" onclick="sistema.ativarTab('pedidos')">
                <i class="fas fa-file-invoice"></i> Pedidos
            </div>
            <div id="tabOrgaos" class="tab-principal" style="display: none" onclick="sistema.ativarTab('orgaos')">
                <i class="fas fa-university"></i> √ìrg√£os
            </div>
            <div id="tabUsuarios" class="tab-principal" style="display: none" onclick="sistema.ativarTab('usuarios')">
                <i class="fas fa-users-cog"></i> Usu√°rios
            </div>
        </div>

        <!-- INDICADOR DE CARRINHO -->
        <div id="carrinhoIndicator" class="carrinho-indicator" style="display: none">
            <i class="fas fa-shopping-cart"></i>
            <span id="carrinhoCount">0</span> itens no carrinho
            <button onclick="sistema.abrirCarrinho()" style="margin-left: auto; background: none; border: none; color: #92400e; cursor: pointer;">
                <i class="fas fa-eye"></i> Ver Carrinho
            </button>
        </div>

        <!-- CONSULTA -->
        <div id="consultaContent">
            <div class="filtros-container">
                <div class="filtros-grid">
                    <div class="filtro-grupo">
                        <label class="filtro-label"><i class="fas fa-search"></i> Buscar</label>
                        <input type="text" id="buscaInput" class="filtro-input" placeholder="Buscar por descri√ß√£o..." onkeyup="sistema.debounceFiltrarAtas()" />
                    </div>
                    <div class="filtro-grupo">
                        <label class="filtro-label"><i class="fas fa-building"></i> Fornecedor</label>
                        <select id="filtroFornecedor" class="filtro-select" onchange="sistema.filtrarAtas()">
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label class="filtro-label"><i class="fas fa-university"></i> √ìrg√£o</label>
                        <select id="filtroOrgao" class="filtro-select" onchange="sistema.filtrarAtas()">
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label class="filtro-label"><i class="fas fa-tag"></i> Status</label>
                        <select id="filtroStatus" class="filtro-select" onchange="sistema.filtrarAtas()">
                            <option value="todos">Todos</option>
                            <option value="ATIVA">Ativa</option>
                            <option value="PROXIMA">Pr√≥xima</option>
                            <option value="VENCIDA">Vencida</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="atasLista" class="atas-grid"></div>
        </div>

        <!-- GEST√ÉO -->
        <div id="gestaoContent" style="display: none">
            <div class="gestao-container">
                <div class="gestao-header">
                    <div class="gestao-titulo">
                        <i class="fas fa-boxes"></i> Lan√ßamento R√°pido
                    </div>
                    <div class="gestao-filtros">
                        <select id="selectAtaGestao" class="gestao-select" onchange="sistema.carregarItensGestao()">
                            <option value="">üîç Selecione uma ata...</option>
                        </select>
                        <select id="filtroStatusGestao" class="gestao-select" onchange="sistema.filtrarItensGestao()">
                            <option value="todos">üì¶ Todos</option>
                            <option value="disponivel">‚úÖ Com saldo</option>
                            <option value="critico">‚ö†Ô∏è Cr√≠tico</option>
                            <option value="esgotado">‚ùå Esgotados</option>
                        </select>
                    </div>
                </div>

                <!-- FILTROS DA GEST√ÉO -->
                <div class="filtros-gestao">
                    <div class="filtro-row">
                        <div class="filtro-busca">
                            <i class="fas fa-search"></i>
                            <input type="text" id="buscaGestao" placeholder="Buscar por n¬∫ da ata ou descri√ß√£o do item..." onkeyup="sistema.filtrarGestao()" />
                        </div>
                    </div>

                    <div class="filtro-grid-3col">
                        <select id="filtroGestaoFornecedor" class="filtro-select" onchange="sistema.filtrarGestao()">
                            <option value="todos">Todos os fornecedores</option>
                        </select>
                        <select id="filtroGestaoOrgao" class="filtro-select" onchange="sistema.filtrarGestao()">
                            <option value="todos">Todos os √≥rg√£os</option>
                        </select>
                        <select id="filtroGestaoStatusAta" class="filtro-select" onchange="sistema.filtrarGestao()">
                            <option value="todos">Todas as atas</option>
                            <option value="ATIVA">Ativas</option>
                            <option value="PROXIMA">Pr√≥ximas</option>
                            <option value="VENCIDA">Vencidas</option>
                        </select>
                    </div>

                    <div class="filtro-row">
                        <select id="filtroGestaoSaldo" class="filtro-select" style="width: 220px;" onchange="sistema.filtrarGestao()">
                            <option value="todos">Todos os itens</option>
                            <option value="disponivel">Com saldo dispon√≠vel</option>
                            <option value="critico">Saldo cr√≠tico (<10%)</option>
                            <option value="zerado">Saldo zerado</option>
                        </select>
                    </div>

                    <div class="filtro-checkboxes">
                        <label>
                            <input type="checkbox" id="ocultarZerados" onchange="sistema.filtrarGestao()" />
                            <span>Ocultar itens com saldo zerado</span>
                        </label>
                        <label>
                            <input type="checkbox" id="apenas30dias" onchange="sistema.filtrarGestao()" />
                            <span>Apenas itens com consumo nos √∫ltimos 30 dias</span>
                        </label>
                    </div>

                    <div class="filtro-actions">
                        <button class="btn-aplicar" onclick="sistema.aplicarFiltrosGestao()">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button class="btn-limpar" onclick="sistema.limparFiltrosGestao()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn-exportar" onclick="sistema.exportarListaGestao()">
                            <i class="fas fa-download"></i> Exportar Lista
                        </button>
                    </div>
                </div>

                <!-- EDITOR DE STATUS DA ATA -->
                <div id="statusEditorContainer" class="status-editor" style="display: none">
                    <span><i class="fas fa-tag"></i> Status da Ata:</span>
                    <select id="statusAtaSelect" class="status-select">
                        <option value="ATIVA">üü¢ ATIVA</option>
                        <option value="PROXIMA">üü° PR√ìXIMA</option>
                        <option value="VENCIDA">üî¥ VENCIDA</option>
                    </select>
                    <button class="btn-status" onclick="sistema.alterarStatusAta()">
                        <i class="fas fa-save"></i> Salvar Altera√ß√£o
                    </button>
                </div>

                <div id="gestaoStats" class="gestao-stats">
                    <div>
                        <span class="gestao-stat-label">Ata:</span>
                        <span id="gestaoAtaNome">Nenhuma</span>
                    </div>
                    <div>
                        <span class="gestao-stat-label">Total itens:</span>
                        <span id="gestaoTotalItens">0</span>
                    </div>
                    <div>
                        <span class="gestao-stat-label">Com saldo:</span>
                        <span id="gestaoItensComSaldo">0</span>
                    </div>
                    <div>
                        <span class="gestao-stat-label">Cr√≠ticos:</span>
                        <span id="gestaoItensCriticos">0</span>
                    </div>
                </div>

                <div id="itensGestaoContainer" class="gestao-tabela-wrapper"></div>
            </div>
        </div>

        <!-- CADASTRO DE ATA -->
        <div id="cadastroContent" style="display: none">
            <div class="cadastro-container">
                <div class="cadastro-header">
                    <div class="cadastro-titulo">
                        <i class="fas fa-file-signature"></i> Cadastrar Ata
                    </div>
                    <button id="btnExtracao" class="btn-extracao" onclick="sistema.executarExtracaoPDF()">
                        <i class="fas fa-file-pdf"></i> Extrair PDF
                    </button>
                </div>
                <form id="formCadastroAta" onsubmit="event.preventDefault(); sistema.salvarAta();">
                    <div class="cadastro-secao">
                        <div class="secao-titulo">
                            <i class="fas fa-gavel"></i> Processo
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>N¬∫ Processo</label>
                                <input type="text" id="processoNumero" required />
                            </div>
                            <div class="form-group">
                                <label>N¬∫ Preg√£o</label>
                                <input type="text" id="pregaoNumero" required />
                            </div>
                            <div class="form-group">
                                <label>N¬∫ Ata</label>
                                <input type="text" id="ataNumero" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Assinatura</label>
                                <input type="date" id="dataAssinatura" required />
                            </div>
                            <div class="form-group">
                                <label>In√≠cio Vig√™ncia</label>
                                <input type="date" id="vigenciaInicio" required />
                            </div>
                            <div class="form-group">
                                <label>Fim Vig√™ncia</label>
                                <input type="date" id="vigenciaFim" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Objeto</label>
                                <textarea id="objeto" rows="2" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="cadastro-secao">
                        <div class="secao-titulo">
                            <i class="fas fa-building"></i> Fornecedor
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Raz√£o Social</label>
                                <input type="text" id="fornecedorRazao" required />
                            </div>
                            <div class="form-group">
                                <label>CNPJ</label>
                                <input type="text" id="fornecedorCnpj" required />
                            </div>
                        </div>
                    </div>
                    <div class="cadastro-secao">
                        <div class="secao-titulo"><i class="fas fa-boxes"></i> Itens</div>
                        <div class="itens-cadastro-header">
                            <span>Total: <span id="totalItensCadastro">0</span></span>
                            <button type="button" class="btn-adicionar-item" onclick="sistema.adicionarItemCadastro()">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                        <div class="tabela-container">
                            <table class="tabela-itens-cadastro" id="tabelaItensCadastro">
                                <thead>
                                    <tr>
                                        <th>N¬∫</th>
                                        <th>Lote</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd</th>
                                        <th>Valor Unit.</th>
                                        <th>Valor Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="itensCadastroBody"></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" style="text-align: right; font-weight: 700">VALOR TOTAL:</td>
                                        <td id="valorTotalAta" style="text-align: right; color: var(--success-600)">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <button type="submit" class="btn-salvar-ata">
                        <i class="fas fa-save"></i> Salvar Ata
                    </button>
                </form>
            </div>
        </div>

        <!-- PEDIDOS -->
        <div id="pedidosContent" style="display: none">
            <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: var(--neutral-900); font-size: 1.2rem;">
                    <i class="fas fa-file-invoice"></i> Meus Pedidos
                </h2>
                <span style="background: var(--success-100); padding: 6px 12px; border-radius: 40px; color: var(--success-800); font-size: 0.8rem;">
                    <i class="fas fa-check-circle"></i> Status: PEDIDO_REALIZADO
                </span>
            </div>
            <div id="pedidosLista" class="atas-grid"></div>
        </div>

        <!-- √ìRG√ÉOS -->
        <div id="orgaosContent" style="display: none">
            <div class="orgaos-container">
                <div class="orgaos-header">
                    <h3 style="font-size: 1.1rem;"><i class="fas fa-university"></i> Gest√£o de √ìrg√£os / Autarquias</h3>
                    <button class="btn-novo-orgao" onclick="sistema.abrirModalOrgao()">
                        <i class="fas fa-plus-circle"></i> Novo √ìrg√£o
                    </button>
                </div>
                <div class="tabela-container">
                    <table class="tabela-orgaos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Sigla</th>
                                <th>CNPJ</th>
                                <th>Contato</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaOrgaosBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- USU√ÅRIOS -->
        <div id="usuariosContent" style="display: none">
            <div class="usuarios-container">
                <div class="usuarios-header">
                    <h3 style="font-size: 1.1rem;"><i class="fas fa-users-cog"></i> Gest√£o de Usu√°rios</h3>
                    <button class="btn-novo-usuario" onclick="sistema.abrirModalUsuario()">
                        <i class="fas fa-user-plus"></i> Novo Usu√°rio
                    </button>
                </div>
                <div class="tabela-container">
                    <table class="tabela-usuarios">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>√ìrg√£o</th>
                                <th>Perfil</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaUsuariosBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MODAIS -->
        <div id="modalDetalhes" class="modal" onclick="if(event.target === this) sistema.fecharModal()">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-titulo" id="modalTituloAta"></h2>
                    <button class="modal-close" onclick="sistema.fecharModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalConteudo"></div>
            </div>
        </div>

        <div id="modalConsumo" class="modal" onclick="if(event.target === this) sistema.fecharModalConsumo()">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2 class="modal-titulo">
                        <i class="fas fa-pen"></i> Lan√ßar Consumo
                    </h2>
                    <button class="modal-close" onclick="sistema.fecharModalConsumo()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalConsumoConteudo"></div>
            </div>
        </div>

        <div id="modalCarrinho" class="modal" onclick="if(event.target === this) sistema.fecharModalCarrinho()">
            <div class="modal-content" style="max-width: 950px;">
                <div class="modal-header">
                    <h2 class="modal-titulo">
                        <i class="fas fa-shopping-cart"></i> Carrinho
                    </h2>
                    <button class="modal-close" onclick="sistema.fecharModalCarrinho()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalCarrinhoConteudo"></div>
            </div>
        </div>

        <div id="modalVisualizarPedido" class="modal" onclick="if(event.target === this) sistema.fecharModalVisualizarPedido()">
            <div class="modal-content" style="max-width: 950px;">
                <div class="modal-header">
                    <h2 class="modal-titulo">
                        <i class="fas fa-file-invoice"></i> Detalhes do Pedido
                    </h2>
                    <button class="modal-close" onclick="sistema.fecharModalVisualizarPedido()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalVisualizarPedidoConteudo"></div>
            </div>
        </div>

        <div id="modalOrgao" class="modal" onclick="if(event.target === this) sistema.fecharModalOrgao()">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-titulo" id="modalOrgaoTitulo">
                        <i class="fas fa-university"></i> Novo √ìrg√£o
                    </h2>
                    <button class="modal-close" onclick="sistema.fecharModalOrgao()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="formOrgao" onsubmit="event.preventDefault(); sistema.salvarOrgao();">
                    <input type="hidden" id="orgaoId" />
                    <div class="form-group">
                        <label>Nome do √ìrg√£o</label>
                        <input type="text" id="orgaoNome" class="filtro-input" placeholder="Ex: Prefeitura Municipal" required />
                    </div>
                    <div class="form-group">
                        <label>Sigla</label>
                        <input type="text" id="orgaoSigla" class="filtro-input" placeholder="Ex: PM" required />
                    </div>
                    <div class="form-group">
                        <label>CNPJ</label>
                        <input type="text" id="orgaoCnpj" class="filtro-input" placeholder="00.000.000/0001-00" />
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo</label>
                        <input type="text" id="orgaoEndereco" class="filtro-input" placeholder="Endere√ßo completo" />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="text" id="orgaoTelefone" class="filtro-input" placeholder="(00) 0000-0000" />
                        </div>
                        <div class="form-group">
                            <label>E-mail</label>
                            <input type="email" id="orgaoEmail" class="filtro-input" placeholder="contato@orgao.gov.br" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="orgaoStatus" class="filtro-select">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" onclick="sistema.fecharModalOrgao()" style="background: var(--neutral-200); padding: 8px 16px; border: none; border-radius: var(--border-radius-md);">Cancelar</button>
                        <button type="submit" style="background: var(--primary-600); color: white; padding: 8px 16px; border: none; border-radius: var(--border-radius-md);">
                            <i class="fas fa-save"></i> Salvar √ìrg√£o
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL DE USU√ÅRIO -->
        <div id="modalUsuario" class="modal" onclick="if(event.target === this) sistema.fecharModalUsuario()">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-titulo" id="modalUsuarioTitulo">
                        <i class="fas fa-user-plus"></i> Novo Usu√°rio
                    </h2>
                    <button class="modal-close" onclick="sistema.fecharModalUsuario()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="formUsuario" onsubmit="event.preventDefault(); sistema.salvarUsuario();">
                    <input type="hidden" id="usuarioId" />
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="usuarioNome" class="filtro-input" required />
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="usuarioEmail" class="filtro-input" required />
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="usuarioSenha" class="filtro-input" placeholder="M√≠nimo 6" required />
                    </div>
                    <div class="form-group">
                        <label>√ìrg√£o</label>
                        <select id="usuarioOrgao" class="filtro-select" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Perfil</label>
                        <select id="usuarioPerfil" class="filtro-select">
                            <option value="ADMIN">Administrador</option>
                            <option value="SECRETARIO">Secret√°rio</option>
                            <option value="SOLICITANTE">Solicitante</option>
                            <option value="ESTAGIARIO">Estagi√°rio</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" onclick="sistema.fecharModalUsuario()" style="background: var(--neutral-200); padding: 8px 16px; border: none; border-radius: var(--border-radius-md);">Cancelar</button>
                        <button type="submit" style="background: var(--primary-600); color: white; padding: 8px 16px; border: none; border-radius: var(--border-radius-md);">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modalPedido" class="modal" onclick="if(event.target === this) sistema.fecharModalPedido()">
            <div class="modal-content" style="max-width: 950px;">
                <div class="modal-header">
                    <h2 class="modal-titulo">
                        <i class="fas fa-file-invoice"></i> Pedido de Compra Gerado
                    </h2>
                    <button class="modal-close" onclick="sistema.fecharModalPedido()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalPedidoConteudo"></div>
            </div>
        </div>

        <div id="pdfVisualizador" class="pdf-visualizador" onclick="if(event.target === this) sistema.fecharPdfVisualizador()">
            <div class="pdf-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 1.2rem;"><i class="fas fa-file-pdf"></i> Visualiza√ß√£o do Pedido</h2>
                    <button onclick="sistema.fecharPdfVisualizador()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                </div>
                <div id="pdfConteudo" class="tabela-container"></div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px;">
                    <button onclick="sistema.fecharPdfVisualizador()" style="background: var(--neutral-200); padding: 8px 16px; border: none; border-radius: var(--border-radius-md);">Fechar</button>
                    <button class="btn-pdf" onclick="sistema.baixarPDF()">
                        <i class="fas fa-download"></i> Baixar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // SUPABASE - CREDENCIAIS
        // =====================================================
        const SUPABASE_URL = "https://qgkjnzcqjhhqdgxmvtew.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_gbXPIpkbYvf3YKITplkjpg_eKrPHhYw";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================
        // CLASSE PRINCIPAL (MANTIDA IGUAL)
        // =====================================================
        class SistemaGestaoAtas {
            constructor() {
                this.usuarioAtual = null;
                this.ataSelecionada = null;
                this.carrinho = [];
                this.pdfData = null;
                this.itensCadastroTemp = [];
                this.filtroTimer = null;
                this.orgaos = [];
                this.filtrosGestaoAtivos = {
                    busca: "",
                    fornecedor: "todos",
                    orgao: "todos",
                    statusAta: "todos",
                    saldo: "todos",
                    ocultarZerados: false,
                    apenas30dias: false,
                };
                this.init();
            }

            async init() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) await this.carregarUsuario(session.user.id);
                this.carregarCarrinhoStorage();
            }

            // ===== LOGIN/LOGOUT =====
            async fazerLogin() {
                const errorDiv = document.getElementById("loginError");
                errorDiv.style.display = "none";
                const email = document.getElementById("loginEmail").value;
                const senha = document.getElementById("loginSenha").value;

                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password: senha,
                    });
                    if (error) throw error;
                    await this.carregarUsuario(data.user.id);
                } catch (error) {
                    errorDiv.style.display = "block";
                    errorDiv.innerHTML = "‚ùå " + error.message;
                }
            }

            async carregarUsuario(uuid) {
                const { data: usuario, error } = await supabaseClient
                    .from("usuarios")
                    .select("*, orgao:orgaos(*)")
                    .eq("uuid", uuid)
                    .single();

                if (error || !usuario) {
                    console.error("Usu√°rio n√£o encontrado");
                    return;
                }

                this.usuarioAtual = usuario;
                document.getElementById("userName").innerHTML = usuario.nome;
                document.getElementById("userRole").innerHTML = usuario.perfil;

                const iniciais = usuario.nome.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase() || "U";
                document.getElementById("userAvatar").innerHTML = iniciais;

                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("mainSystem").style.display = "block";

                await this.carregarOrgaos();
                await this.carregarFiltros();
                await this.carregarAtas();
                await this.carregarSelectsGestao();
                await this.carregarTabelaUsuarios();
                await this.carregarTabelaOrgaos();
                await this.carregarPedidos();
                this.configurarPermissoes();
                this.atualizarCarrinhoUI();
                this.ativarTab("consulta");
            }

            async fazerLogout() {
                await supabaseClient.auth.signOut();
                this.usuarioAtual = null;
                document.getElementById("loginScreen").style.display = "block";
                document.getElementById("mainSystem").style.display = "none";
            }

            configurarPermissoes() {
                const perfil = this.usuarioAtual?.perfil;
                document.getElementById("tabUsuarios").style.display = perfil === "ADMIN" ? "block" : "none";
                document.getElementById("tabOrgaos").style.display = perfil === "ADMIN" ? "block" : "none";
                document.getElementById("tabGestao").style.display = perfil === "ADMIN" || perfil === "ESTAGIARIO" ? "block" : "none";
                document.getElementById("tabCadastro").style.display = perfil === "ADMIN" || perfil === "ESTAGIARIO" ? "block" : "none";
                document.getElementById("btnExtracao").style.display = perfil === "ADMIN" || perfil === "ESTAGIARIO" ? "flex" : "none";
            }

            ativarTab(tab) {
                if (!this.verificarPermissaoTab(tab)) {
                    alert("Acesso negado");
                    return;
                }

                document.querySelectorAll(".tab-principal").forEach(t => t.classList.remove("active"));
                document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add("active");

                document.getElementById("consultaContent").style.display = tab === "consulta" ? "block" : "none";
                document.getElementById("gestaoContent").style.display = tab === "gestao" ? "block" : "none";
                document.getElementById("cadastroContent").style.display = tab === "cadastro" ? "block" : "none";
                document.getElementById("pedidosContent").style.display = tab === "pedidos" ? "block" : "none";
                document.getElementById("orgaosContent").style.display = tab === "orgaos" ? "block" : "none";
                document.getElementById("usuariosContent").style.display = tab === "usuarios" ? "block" : "none";

                if (tab === "consulta") this.carregarAtas();
                if (tab === "gestao") this.carregarSelectsGestao();
                if (tab === "pedidos") this.carregarPedidos();
                if (tab === "orgaos") this.carregarTabelaOrgaos();
                if (tab === "usuarios") this.carregarTabelaUsuarios();
            }

            verificarPermissaoTab(tab) {
                const perfil = this.usuarioAtual?.perfil;
                if (tab === "usuarios" && perfil !== "ADMIN") return false;
                if (tab === "orgaos" && perfil !== "ADMIN") return false;
                if ((tab === "gestao" || tab === "cadastro") && !(perfil === "ADMIN" || perfil === "ESTAGIARIO")) return false;
                return true;
            }

            debounceFiltrarAtas() {
                clearTimeout(this.filtroTimer);
                this.filtroTimer = setTimeout(() => this.filtrarAtas(), 400);
            }

            // ===== CRUD DE √ìRG√ÉOS =====
            async carregarOrgaos() {
                const { data: orgaos, error } = await supabaseClient
                    .from("orgaos")
                    .select("*")
                    .order("nome");

                if (!error) {
                    this.orgaos = orgaos || [];
                }
                return this.orgaos;
            }

            async carregarTabelaOrgaos() {
                const tbody = document.getElementById("tabelaOrgaosBody");
                if (!tbody) return;

                const { data: orgaos } = await supabaseClient
                    .from("orgaos")
                    .select("*")
                    .order("nome");

                if (!orgaos?.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Nenhum √≥rg√£o cadastrado</td></tr>';
                    return;
                }

                tbody.innerHTML = orgaos.map(orgao => `
                    <tr>
                        <td>${orgao.id}</td>
                        <td><strong>${orgao.nome}</strong></td>
                        <td><span class="badge-perfil" style="background: var(--primary-100);">${orgao.sigla || "-"}</span></td>
                        <td>${orgao.cnpj || "-"}</td>
                        <td>
                            ${orgao.telefone ? `<i class="fas fa-phone"></i> ${orgao.telefone}<br>` : ""}
                            ${orgao.email ? `<i class="fas fa-envelope"></i> ${orgao.email}` : ""}
                        </td>
                        <td>
                            <span class="badge-perfil ${orgao.ativo ? "status-ativo" : "status-inativo"}">
                                ${orgao.ativo ? "ATIVO" : "INATIVO"}
                            </span>
                        </td>
                        <td>
                            <button class="btn-editar-orgao" onclick="sistema.editarOrgao(${orgao.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-desativar-orgao" onclick="sistema.toggleStatusOrgao(${orgao.id})">
                                <i class="fas ${orgao.ativo ? "fa-times-circle" : "fa-check-circle"}"></i>
                            </button>
                        </td>
                    </tr>
                `).join("");
            }

            async carregarSelectOrgaos(selectId, selectedId = null) {
                const select = document.getElementById(selectId);
                if (!select) return;

                const orgaos = await this.carregarOrgaos();
                select.innerHTML = '<option value="">Selecione um √≥rg√£o...</option>';

                orgaos.filter(o => o.ativo !== false).forEach(orgao => {
                    const option = document.createElement("option");
                    option.value = orgao.id;
                    option.textContent = `${orgao.nome}${orgao.sigla ? ` (${orgao.sigla})` : ""}`;
                    if (selectedId && orgao.id == selectedId) option.selected = true;
                    select.appendChild(option);
                });
            }

            abrirModalOrgao(orgaoId = null) {
                if (this.usuarioAtual?.perfil !== "ADMIN") {
                    alert("Apenas administradores podem gerenciar √≥rg√£os.");
                    return;
                }

                document.getElementById("modalOrgaoTitulo").innerHTML = orgaoId 
                    ? '<i class="fas fa-edit"></i> Editar √ìrg√£o' 
                    : '<i class="fas fa-plus-circle"></i> Novo √ìrg√£o';

                if (orgaoId) {
                    this.editarOrgao(orgaoId);
                } else {
                    document.getElementById("orgaoId").value = "";
                    document.getElementById("orgaoNome").value = "";
                    document.getElementById("orgaoSigla").value = "";
                    document.getElementById("orgaoCnpj").value = "";
                    document.getElementById("orgaoEndereco").value = "";
                    document.getElementById("orgaoTelefone").value = "";
                    document.getElementById("orgaoEmail").value = "";
                    document.getElementById("orgaoStatus").value = "true";
                    document.getElementById("modalOrgao").classList.add("active");
                }
            }

            async editarOrgao(id) {
                const { data: orgao } = await supabaseClient
                    .from("orgaos")
                    .select("*")
                    .eq("id", id)
                    .single();

                if (orgao) {
                    document.getElementById("orgaoId").value = orgao.id;
                    document.getElementById("orgaoNome").value = orgao.nome || "";
                    document.getElementById("orgaoSigla").value = orgao.sigla || "";
                    document.getElementById("orgaoCnpj").value = orgao.cnpj || "";
                    document.getElementById("orgaoEndereco").value = orgao.endereco || "";
                    document.getElementById("orgaoTelefone").value = orgao.telefone || "";
                    document.getElementById("orgaoEmail").value = orgao.email || "";
                    document.getElementById("orgaoStatus").value = orgao.ativo ? "true" : "false";
                    document.getElementById("modalOrgao").classList.add("active");
                }
            }

            async salvarOrgao() {
                const id = document.getElementById("orgaoId").value;
                const dados = {
                    nome: document.getElementById("orgaoNome").value,
                    sigla: document.getElementById("orgaoSigla").value,
                    cnpj: document.getElementById("orgaoCnpj").value || null,
                    endereco: document.getElementById("orgaoEndereco").value || null,
                    telefone: document.getElementById("orgaoTelefone").value || null,
                    email: document.getElementById("orgaoEmail").value || null,
                    ativo: document.getElementById("orgaoStatus").value === "true",
                };

                try {
                    let error;
                    if (id) {
                        ({ error } = await supabaseClient.from("orgaos").update(dados).eq("id", id));
                    } else {
                        ({ error } = await supabaseClient.from("orgaos").insert(dados));
                    }

                    if (error) throw error;

                    alert(id ? "‚úÖ √ìrg√£o atualizado!" : "‚úÖ √ìrg√£o cadastrado!");
                    this.fecharModalOrgao();
                    await this.carregarOrgaos();
                    await this.carregarTabelaOrgaos();
                    await this.carregarSelectOrgaos("usuarioOrgao", this.usuarioAtual?.orgao_id);
                    await this.carregarSelectOrgaos("autarquiaConsumo");
                    await this.carregarFiltros();
                } catch (error) {
                    alert("Erro: " + error.message);
                }
            }

            async toggleStatusOrgao(id) {
                const { data: orgao } = await supabaseClient
                    .from("orgaos")
                    .select("ativo")
                    .eq("id", id)
                    .single();

                if (orgao) {
                    const novoStatus = !orgao.ativo;
                    if (confirm(`${novoStatus ? "Ativar" : "Desativar"} este √≥rg√£o?`)) {
                        const { error } = await supabaseClient
                            .from("orgaos")
                            .update({ ativo: novoStatus })
                            .eq("id", id);

                        if (!error) {
                            await this.carregarTabelaOrgaos();
                            await this.carregarOrgaos();
                        }
                    }
                }
            }

            fecharModalOrgao() {
                document.getElementById("modalOrgao").classList.remove("active");
            }

            // ===== FILTROS =====
            async carregarFiltros() {
                const selectFornecedor = document.getElementById("filtroFornecedor");
                if (selectFornecedor) {
                    selectFornecedor.innerHTML = '<option value="todos">Todos os fornecedores</option>';
                    const { data: fornecedores } = await supabaseClient
                        .from("fornecedores")
                        .select("razao_social")
                        .order("razao_social");
                    fornecedores?.forEach(f => {
                        const option = document.createElement("option");
                        option.value = f.razao_social;
                        option.textContent = f.razao_social;
                        selectFornecedor.appendChild(option);
                    });
                }

                await this.carregarSelectOrgaos("filtroOrgao");
                await this.carregarSelectOrgaos("usuarioOrgao", this.usuarioAtual?.orgao_id);
                await this.carregarSelectOrgaos("autarquiaConsumo");

                // Carregar filtros da gest√£o
                await this.carregarFiltrosGestao();
            }

            async carregarFiltrosGestao() {
                const selectFornecedor = document.getElementById("filtroGestaoFornecedor");
                if (selectFornecedor) {
                    selectFornecedor.innerHTML = '<option value="todos">Todos os fornecedores</option>';
                    const { data: fornecedores } = await supabaseClient
                        .from("fornecedores")
                        .select("razao_social")
                        .order("razao_social");
                    fornecedores?.forEach(f => {
                        const option = document.createElement("option");
                        option.value = f.razao_social;
                        option.textContent = f.razao_social;
                        selectFornecedor.appendChild(option);
                    });
                }

                await this.carregarSelectOrgaos("filtroGestaoOrgao");
            }

            // ===== ATAS =====
            async carregarAtas() {
                const container = document.getElementById("atasLista");
                container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Carregando atas...</div>';

                let query = supabaseClient.from("atas").select(`
                    *,
                    fornecedor:fornecedores(razao_social, cnpj),
                    itens:itens_ata(*)
                `);

                const statusFiltro = document.getElementById("filtroStatus")?.value;
                if (statusFiltro && statusFiltro !== "todos") {
                    query = query.eq("situacao", statusFiltro);
                } else {
                    query = query.not("situacao", "eq", "VENCIDA");
                }

                const { data: atas } = await query.order("data_inicio_vigencia", { ascending: false });
                let atasFiltradas = atas || [];

                const fornecedorFiltro = document.getElementById("filtroFornecedor")?.value;
                if (fornecedorFiltro && fornecedorFiltro !== "todos") {
                    atasFiltradas = atasFiltradas.filter(a => a.fornecedor?.razao_social === fornecedorFiltro);
                }

                const busca = document.getElementById("buscaInput")?.value?.toLowerCase();
                if (busca) {
                    atasFiltradas = atasFiltradas.filter(ata => 
                        ata.itens?.some(item => item.descricao?.toLowerCase().includes(busca))
                    );
                }

                if (atasFiltradas.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;">Nenhuma ata encontrada</div>';
                    return;
                }

                container.innerHTML = atasFiltradas.map(ata => this.renderCardAta(ata)).join("");
            }

            renderCardAta(ata) {
                const totalItens = ata.itens?.length || 0;
                const statusClass = {
                    ATIVA: "status-ativa",
                    PROXIMA: "status-proxima",
                    VENCIDA: "status-vencida",
                }[ata.situacao] || "status-ativa";

                return `<div class="ata-card" onclick="sistema.abrirDetalhes(${ata.id})">
                    <div class="ata-header">
                        <div class="ata-status">
                            <span class="status-badge ${statusClass}">${ata.situacao || "ATIVA"}</span>
                            <span style="font-size: 0.75rem;"><i class="fas fa-box"></i> ${totalItens}</span>
                        </div>
                        <div class="ata-numero">Ata n¬∫ ${ata.numero_ata || ""}</div>
                        <div class="ata-fornecedor"><i class="fas fa-building"></i> ${ata.fornecedor?.razao_social || "N/I"}</div>
                        <div style="font-size: 0.8rem;"><i class="fas fa-calendar"></i> ${this.formatarData(ata.data_inicio_vigencia)}</div>
                    </div>
                    <div class="ata-footer">
                        <span style="font-weight:600; font-size: 0.9rem;">${this.formatarMoeda(ata.valor_global || 0)}</span>
                        <button class="btn-visualizar" onclick="event.stopPropagation(); sistema.abrirDetalhes(${ata.id})">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </div>
                </div>`;
            }

            async abrirDetalhes(ataId) {
                const { data: ata } = await supabaseClient
                    .from("atas")
                    .select(`*, fornecedor:fornecedores(*), itens:itens_ata(*)`)
                    .eq("id", ataId)
                    .single();

                this.ataSelecionada = ata;

                const { data: consumos } = await supabaseClient
                    .from("consumos")
                    .select("valor_total")
                    .eq("ata_id", ataId);

                const valorConsumido = consumos?.reduce((sum, c) => sum + (c.valor_total || 0), 0) || 0;
                const saldoAta = (ata.valor_global || 0) - valorConsumido;

                document.getElementById("modalTituloAta").innerHTML = `
                    <i class="fas fa-file-contract"></i> Ata n¬∫ ${ata.numero_ata}
                    <div style="font-size: 0.85rem; margin-top: 4px; color: var(--neutral-500);">
                        Vig√™ncia: De ${this.formatarData(ata.data_inicio_vigencia)} at√© ${this.formatarData(ata.data_fim_vigencia)}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                        <span style="background: var(--success-100); padding: 3px 8px; border-radius: 20px; font-size: 0.8rem;">
                            <strong>Valor:</strong> ${this.formatarMoeda(ata.valor_global || 0)}
                        </span>
                        <span style="background: var(--warning-100); padding: 3px 8px; border-radius: 20px; font-size: 0.8rem;">
                            <strong>Consumido:</strong> ${this.formatarMoeda(valorConsumido)}
                        </span>
                        <span style="background: var(--primary-100); padding: 3px 8px; border-radius: 20px; font-size: 0.8rem;">
                            <strong>Saldo:</strong> ${this.formatarMoeda(saldoAta)}
                        </span>
                    </div>
                `;

                document.getElementById("modalConteudo").innerHTML = await this.renderDetalhesAta(ata);
                document.getElementById("modalDetalhes").classList.add("active");
            }

            async renderDetalhesAta(ata) {
                const { data: consumos } = await supabaseClient
                    .from("consumos")
                    .select("*, orgao:orgaos(*)")
                    .eq("ata_id", ata.id);

                const consumosPorItem = {};
                consumos?.forEach(c => {
                    if (!consumosPorItem[c.item_ata_id]) {
                        consumosPorItem[c.item_ata_id] = [];
                    }
                    consumosPorItem[c.item_ata_id].push(c);
                });

                const podeConsumir = this.usuarioAtual?.perfil === "ADMIN" || this.usuarioAtual?.perfil === "ESTAGIARIO";
                const podePedir = this.usuarioAtual?.perfil === "ADMIN" || this.usuarioAtual?.perfil === "SECRETARIO" || this.usuarioAtual?.perfil === "SOLICITANTE";

                return `
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Fornecedor</span><span class="info-value">${ata.fornecedor?.razao_social || ""}</span></div>
                        <div class="info-item"><span class="info-label">CNPJ</span><span class="info-value">${ata.fornecedor?.cnpj || ""}</span></div>
                        <div class="info-item"><span class="info-label">Processo</span><span class="info-value">${ata.processo_administrativo || ""}</span></div>
                        <div class="info-item"><span class="info-label">Status</span><span class="status-badge ${ata.situacao === "ATIVA" ? "status-ativa" : "status-vencida"}">${ata.situacao || "ATIVA"}</span></div>
                    </div>
                    <h3 style="margin-bottom: 12px; font-size: 1rem;">Itens da Ata</h3>
                    <div class="tabela-container">
                        <table class="tabela-itens">
                            <thead>
                                <tr>
                                    <th>N¬∫</th>
                                    <th>Lote</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Qtd</th>
                                    <th>Valor Unit.</th>
                                    <th>Valor Total</th>
                                    <th>Saldo</th>
                                    <th>%</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ata.itens.map(item => {
                                    const consumosItem = consumosPorItem[item.id] || [];
                                    const qtdConsumida = consumosItem.reduce((sum, c) => sum + c.quantidade, 0);
                                    const saldo = item.saldo_quantidade || 0;
                                    const percentual = item.quantidade_contratada > 0 
                                        ? (((item.quantidade_contratada - saldo) / item.quantidade_contratada) * 100).toFixed(1) 
                                        : 0;
                                    const lote = item.lote_numero || "N/I";
                                    const saldoClass = saldo <= 0 
                                        ? "saldo-zerado" 
                                        : saldo <= item.quantidade_contratada * 0.1 
                                        ? "saldo-baixo" 
                                        : "saldo-alto";

                                    return `<tr>
                                        <td>${item.item_numero || ""}</td>
                                        <td><span class="lote-tag">${lote}</span></td>
                                        <td>${item.descricao || ""}</td>
                                        <td class="numeric">${item.quantidade_contratada || 0}</td>
                                        <td class="numeric">${this.formatarMoeda(item.valor_unitario)}</td>
                                        <td class="numeric">${this.formatarMoeda(item.valor_total)}</td>
                                        <td class="numeric ${saldoClass}">${saldo}</td>
                                        <td><div class="progresso-container"><div class="progresso-bar" style="width:${percentual}%;"></div></div>${percentual}%</td>
                                        <td>
                                            <div class="acoes-item">
                                                ${podeConsumir && saldo > 0 ? `<button class="btn-consumo" onclick="event.stopPropagation(); sistema.abrirModalConsumo(${ata.id}, ${item.id})"><i class="fas fa-pen"></i> Consumo</button>` : ""}
                                                ${podePedir && saldo > 0 ? `
                                                    <div style="display:flex; flex-direction:column; gap:3px;">
                                                        <input type="number" id="qtd-${ata.id}-${item.id}" min="1" max="${saldo}" placeholder="Qtd" style="width:60px; padding:3px; border: 1px solid var(--neutral-200); border-radius: var(--border-radius-sm); font-size: 0.8rem;">
                                                        <button class="btn-pedido" onclick="sistema.adicionarAoCarrinho(${ata.id}, ${item.id})"><i class="fas fa-cart-plus"></i> Pedido</button>
                                                    </div>
                                                ` : ""}
                                                ${saldo <= 0 ? '<span style="color: var(--error-600); font-size: 0.7rem;">ESGOTADO</span>' : ""}
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join("")}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // ===== GEST√ÉO DE ITENS =====
            async carregarSelectsGestao() {
                const select = document.getElementById("selectAtaGestao");
                if (!select) return;

                select.innerHTML = '<option value="">üîç Selecione...</option>';
                const { data: atas } = await supabaseClient
                    .from("atas")
                    .select("id, numero_ata, situacao, fornecedor:fornecedores(razao_social)")
                    .order("numero_ata");

                atas?.forEach(ata => {
                    const option = document.createElement("option");
                    option.value = ata.id;
                    option.textContent = `${ata.numero_ata} - ${ata.fornecedor?.razao_social || ""}`;
                    select.appendChild(option);
                });
            }

            async carregarItensGestao() {
                const ataId = document.getElementById("selectAtaGestao").value;
                if (!ataId) {
                    document.getElementById("itensGestaoContainer").innerHTML = "";
                    this.atualizarStatsGestao(null);
                    document.getElementById("statusEditorContainer").style.display = "none";
                    return;
                }

                const { data: ata } = await supabaseClient
                    .from("atas")
                    .select("*, itens:itens_ata(*)")
                    .eq("id", ataId)
                    .single();

                this.ataSelecionada = ata;

                document.getElementById("statusEditorContainer").style.display = "flex";
                document.getElementById("statusAtaSelect").value = ata.situacao || "ATIVA";

                this.atualizarStatsGestao(ata);
                this.filtrarItensGestao();
            }

            atualizarStatsGestao(ata) {
                if (!ata) {
                    document.getElementById("gestaoAtaNome").innerHTML = "Nenhuma";
                    document.getElementById("gestaoTotalItens").innerHTML = "0";
                    document.getElementById("gestaoItensComSaldo").innerHTML = "0";
                    document.getElementById("gestaoItensCriticos").innerHTML = "0";
                    return;
                }

                document.getElementById("gestaoAtaNome").innerHTML = `${ata.numero_ata}`;
                document.getElementById("gestaoTotalItens").innerHTML = ata.itens.length;

                let comSaldo = 0, criticos = 0;
                ata.itens.forEach(item => {
                    if (item.saldo_quantidade > 0) comSaldo++;
                    if (item.saldo_quantidade > 0 && item.saldo_quantidade <= item.quantidade_contratada * 0.1) criticos++;
                });

                document.getElementById("gestaoItensComSaldo").innerHTML = comSaldo;
                document.getElementById("gestaoItensCriticos").innerHTML = criticos;
            }

            filtrarItensGestao() {
                if (!this.ataSelecionada) return;

                const filtro = document.getElementById("filtroStatusGestao")?.value || "todos";
                let itens = [...this.ataSelecionada.itens];

                if (filtro === "disponivel") itens = itens.filter(i => i.saldo_quantidade > 0);
                else if (filtro === "critico") itens = itens.filter(i => i.saldo_quantidade > 0 && i.saldo_quantidade <= i.quantidade_contratada * 0.1);
                else if (filtro === "esgotado") itens = itens.filter(i => i.saldo_quantidade <= 0);

                this.renderizarItensGestao(itens);
            }

            filtrarGestao() {
                if (!this.ataSelecionada) return;

                this.filtrosGestaoAtivos.busca = document.getElementById("buscaGestao").value.toLowerCase();
                this.filtrosGestaoAtivos.fornecedor = document.getElementById("filtroGestaoFornecedor").value;
                this.filtrosGestaoAtivos.orgao = document.getElementById("filtroGestaoOrgao").value;
                this.filtrosGestaoAtivos.statusAta = document.getElementById("filtroGestaoStatusAta").value;
                this.filtrosGestaoAtivos.saldo = document.getElementById("filtroGestaoSaldo").value;
                this.filtrosGestaoAtivos.ocultarZerados = document.getElementById("ocultarZerados").checked;
                this.filtrosGestaoAtivos.apenas30dias = document.getElementById("apenas30dias").checked;

                this.aplicarFiltrosGestao();
            }

            async aplicarFiltrosGestao() {
                if (!this.ataSelecionada) return;

                let itens = [...this.ataSelecionada.itens];

                if (this.filtrosGestaoAtivos.busca) {
                    itens = itens.filter(i => 
                        i.descricao.toLowerCase().includes(this.filtrosGestaoAtivos.busca) ||
                        (i.lote_numero && i.lote_numero.toLowerCase().includes(this.filtrosGestaoAtivos.busca))
                    );
                }

                if (this.filtrosGestaoAtivos.saldo === "disponivel") {
                    itens = itens.filter(i => i.saldo_quantidade > 0);
                } else if (this.filtrosGestaoAtivos.saldo === "critico") {
                    itens = itens.filter(i => i.saldo_quantidade > 0 && i.saldo_quantidade <= i.quantidade_contratada * 0.1);
                } else if (this.filtrosGestaoAtivos.saldo === "zerado") {
                    itens = itens.filter(i => i.saldo_quantidade <= 0);
                }

                if (this.filtrosGestaoAtivos.ocultarZerados) {
                    itens = itens.filter(i => i.saldo_quantidade > 0);
                }

                this.renderizarItensGestao(itens);
            }

            limparFiltrosGestao() {
                document.getElementById("buscaGestao").value = "";
                document.getElementById("filtroGestaoFornecedor").value = "todos";
                document.getElementById("filtroGestaoOrgao").value = "todos";
                document.getElementById("filtroGestaoStatusAta").value = "todos";
                document.getElementById("filtroGestaoSaldo").value = "todos";
                document.getElementById("ocultarZerados").checked = false;
                document.getElementById("apenas30dias").checked = false;

                this.filtrosGestaoAtivos = {
                    busca: "",
                    fornecedor: "todos",
                    orgao: "todos",
                    statusAta: "todos",
                    saldo: "todos",
                    ocultarZerados: false,
                    apenas30dias: false,
                };

                this.filtrarGestao();
            }

            exportarListaGestao() {
                if (!this.ataSelecionada) {
                    alert("Selecione uma ata primeiro");
                    return;
                }

                const itens = this.ataSelecionada.itens;
                const cabecalho = ["Item", "Lote", "Descri√ß√£o", "Qtd Contratada", "Saldo", "Valor Unit√°rio", "Valor Total"];
                const linhas = itens.map(item => [
                    item.item_numero,
                    item.lote_numero || "N/I",
                    item.descricao,
                    item.quantidade_contratada,
                    item.saldo_quantidade,
                    this.formatarMoeda(item.valor_unitario),
                    this.formatarMoeda(item.valor_total),
                ]);

                const csvContent = [cabecalho.join(","), ...linhas.map(l => l.join(","))].join("\n");

                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `itens_ata_${this.ataSelecionada.numero_ata}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async alterarStatusAta() {
                if (!this.ataSelecionada) return;

                const novoStatus = document.getElementById("statusAtaSelect").value;
                const statusAntigo = this.ataSelecionada.situacao;

                if (statusAntigo === novoStatus) {
                    alert("O status j√° √© " + novoStatus);
                    return;
                }

                if (!confirm(`Deseja alterar o status da ata de ${statusAntigo} para ${novoStatus}?`)) {
                    return;
                }

                try {
                    const { error } = await supabaseClient
                        .from("atas")
                        .update({ situacao: novoStatus })
                        .eq("id", this.ataSelecionada.id);

                    if (error) throw error;

                    alert("‚úÖ Status atualizado com sucesso!");
                    this.ataSelecionada.situacao = novoStatus;

                    await this.carregarAtas();
                } catch (error) {
                    alert("Erro ao atualizar status: " + error.message);
                }
            }

            renderizarItensGestao(itens) {
                const container = document.getElementById("itensGestaoContainer");

                if (!itens.length) {
                    container.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-box-open" style="font-size:3rem; color: var(--neutral-400);"></i><h3 style="margin-top:15px; color: var(--neutral-500); font-size: 0.9rem;">Nenhum item encontrado com os filtros aplicados</h3></div>';
                    return;
                }

                const podeConsumir = this.usuarioAtual?.perfil === "ADMIN" || this.usuarioAtual?.perfil === "ESTAGIARIO";

                container.innerHTML = `<table class="gestao-tabela">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Lote</th>
                            <th>Descri√ß√£o</th>
                            <th>Contratado</th>
                            <th>Saldo</th>
                            <th>Valor Unit.</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itens.map(item => {
                            const saldo = item.saldo_quantidade || 0;
                            const lote = item.lote_numero || "N/I";
                            const isCritico = saldo > 0 && saldo <= item.quantidade_contratada * 0.1;

                            return `<tr>
                                <td>${item.item_numero}</td>
                                <td><span class="lote-tag">${lote}</span></td>
                                <td>${item.descricao}</td>
                                <td class="numeric">${item.quantidade_contratada}</td>
                                <td class="numeric ${saldo <= 0 ? "saldo-zerado" : isCritico ? "saldo-baixo" : "saldo-alto"}">${saldo}</td>
                                <td class="numeric">${this.formatarMoeda(item.valor_unitario)}</td>
                                <td>
                                    <span class="status-badge" style="background: ${saldo <= 0 ? "var(--error-100)" : isCritico ? "var(--warning-100)" : "var(--success-100)"}; color: ${saldo <= 0 ? "var(--error-800)" : isCritico ? "var(--warning-800)" : "var(--success-800)"};">
                                        ${saldo <= 0 ? "Esgotado" : isCritico ? "Cr√≠tico" : "Normal"}
                                    </span>
                                </td>
                                <td>
                                    ${saldo > 0 && podeConsumir ? `<button class="btn-lancar-rapido" onclick="sistema.abrirModalConsumo(${this.ataSelecionada.id}, ${item.id})"><i class="fas fa-pen"></i> Consumo</button>` : ""}
                                </td>
                            </tr>`;
                        }).join("")}
                    </tbody>
                </table>`;
            }

            // ===== CONSUMO =====
            async abrirModalConsumo(ataId, itemId) {
                const { data: item } = await supabaseClient
                    .from("itens_ata")
                    .select("*")
                    .eq("id", itemId)
                    .single();

                const saldo = item.saldo_quantidade || 0;

                await this.carregarSelectOrgaos("autarquiaConsumo");

                document.getElementById("modalConsumoConteudo").innerHTML = `
                    <div>
                        <div style="background: var(--neutral-50); padding: 12px; border-radius: var(--border-radius-lg); margin-bottom: 16px;">
                            <p style="font-size: 0.85rem;"><strong>Ata:</strong> ${this.ataSelecionada?.numero_ata}</p>
                            <p style="font-size: 0.85rem;"><strong>Item:</strong> ${item.descricao}</p>
                            <p style="font-size: 0.85rem;"><strong>Lote:</strong> <span class="lote-tag">${item.lote_numero || "N/I"}</span></p>
                            <p style="font-size: 0.85rem;"><strong>Saldo:</strong> <span style="color: var(--success-600); font-weight:700;">${saldo}</span></p>
                        </div>
                        <div class="filtro-grupo" style="margin-bottom: 12px;"><label style="font-size: 0.75rem;">√ìrg√£o</label>
                            <select id="autarquiaConsumo" class="filtro-select" style="padding: 6px 10px;" required></select>
                        </div>
                        <div class="filtro-grupo" style="margin-bottom: 12px;"><label style="font-size: 0.75rem;">Quantidade</label>
                            <input type="number" id="quantidadeConsumo" class="filtro-input" style="padding: 6px 10px;" min="1" max="${saldo}" placeholder="Quantidade" required>
                        </div>
                        <div class="filtro-grupo" style="margin-bottom: 16px;"><label style="font-size: 0.75rem;">Observa√ß√£o</label>
                            <input type="text" id="obsConsumo" class="filtro-input" style="padding: 6px 10px;" placeholder="Opcional">
                        </div>
                        <div style="display:flex; gap: 10px; justify-content:flex-end;">
                            <button class="btn" style="background: var(--neutral-200); padding: 6px 14px; border:none; border-radius: var(--border-radius-md); font-size: 0.85rem;" onclick="sistema.fecharModalConsumo()">Cancelar</button>
                            <button class="btn-consumo" style="padding: 6px 14px; font-size: 0.85rem;" onclick="sistema.registrarConsumo(${ataId}, ${itemId})"><i class="fas fa-save"></i> Registrar</button>
                        </div>
                    </div>
                `;

                document.getElementById("modalConsumo").classList.add("active");
            }

            async registrarConsumo(ataId, itemId) {
                const quantidade = parseInt(document.getElementById("quantidadeConsumo").value);
                const orgaoId = parseInt(document.getElementById("autarquiaConsumo").value);
                const obs = document.getElementById("obsConsumo").value;

                if (!quantidade || quantidade <= 0) {
                    alert("Quantidade inv√°lida!");
                    return;
                }

                if (!orgaoId) {
                    alert("Selecione um √≥rg√£o!");
                    return;
                }

                try {
                    const { error } = await supabaseClient.rpc("sp_registrar_consumo", {
                        p_usuario_id: this.usuarioAtual.id,
                        p_ata_id: ataId,
                        p_item_ata_id: itemId,
                        p_orgao_id: orgaoId,
                        p_quantidade: quantidade,
                        p_observacao: obs,
                    });

                    if (error) throw error;

                    alert("‚úÖ Consumo registrado!");
                    this.fecharModalConsumo();
                    if (this.ataSelecionada?.id === ataId) this.abrirDetalhes(ataId);
                    await this.carregarAtas();
                    if (this.ataSelecionada?.id === ataId) {
                        this.atualizarStatsGestao(this.ataSelecionada);
                        this.filtrarItensGestao();
                    }
                } catch (error) {
                    alert("Erro: " + error.message);
                }
            }

            // ===== CARRINHO =====
            carregarCarrinhoStorage() {
                const stored = localStorage.getItem("carrinhoAtas");
                if (stored) {
                    try {
                        this.carrinho = JSON.parse(stored);
                    } catch (e) {
                        this.carrinho = [];
                    }
                }
                this.atualizarCarrinhoUI();
            }

            salvarCarrinhoStorage() {
                localStorage.setItem("carrinhoAtas", JSON.stringify(this.carrinho));
                this.atualizarCarrinhoUI();
            }

            atualizarCarrinhoUI() {
                const count = this.carrinho.length;
                document.getElementById("carrinhoCount").innerHTML = count;
                const indicator = document.getElementById("carrinhoIndicator");

                if (count > 0 && (this.usuarioAtual?.perfil === "ADMIN" || this.usuarioAtual?.perfil === "SECRETARIO" || this.usuarioAtual?.perfil === "SOLICITANTE")) {
                    indicator.style.display = "flex";
                } else {
                    indicator.style.display = "none";
                }
            }

            adicionarAoCarrinho(ataId, itemId) {
                const qtdInput = document.getElementById(`qtd-${ataId}-${itemId}`);
                if (!qtdInput) return;

                const quantidade = parseInt(qtdInput.value);
                if (!quantidade || quantidade <= 0) {
                    alert("Quantidade inv√°lida!");
                    return;
                }

                const ata = this.ataSelecionada;
                const item = ata.itens.find(i => i.id === itemId);

                if (!item) return;
                if (quantidade > (item.saldo_quantidade || 0)) {
                    alert(`Saldo insuficiente (${item.saldo_quantidade})!`);
                    return;
                }

                const numeroPedido = `PED-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 9000 + 1000))}`;

                this.carrinho.push({
                    id: `${ataId}-${itemId}-${Date.now()}`,
                    ataId: ata.id,
                    ataNumero: ata.numero_ata,
                    fornecedorId: ata.fornecedor_id,
                    fornecedorRazao: ata.fornecedor?.razao_social,
                    fornecedorCnpj: ata.fornecedor?.cnpj,
                    processo: ata.processo_administrativo,
                    objeto: ata.objeto,
                    itemId: item.id,
                    itemNumero: item.item_numero,
                    itemDescricao: item.descricao,
                    lote: item.lote_numero || "N/I",
                    quantidade: quantidade,
                    valorUnitario: item.valor_unitario,
                    valorTotal: item.valor_unitario * quantidade,
                    numeroPedido: numeroPedido,
                    data: new Date().toISOString().split("T")[0],
                    solicitante: this.usuarioAtual?.nome,
                    orgaoId: this.usuarioAtual?.orgao_id,
                });

                qtdInput.value = "";
                this.salvarCarrinhoStorage();
                alert("‚úÖ Item adicionado ao carrinho!");
            }

            removerDoCarrinho(itemId) {
                this.carrinho = this.carrinho.filter(i => i.id !== itemId);
                this.salvarCarrinhoStorage();
                this.abrirCarrinho();
            }

            limparCarrinho() {
                if (confirm("Limpar carrinho?")) {
                    this.carrinho = [];
                    this.salvarCarrinhoStorage();
                    this.fecharModalCarrinho();
                }
            }

            abrirCarrinho() {
                if (this.carrinho.length === 0) {
                    alert("Carrinho vazio");
                    return;
                }

                const pedidosPorAta = {};
                this.carrinho.forEach(item => {
                    if (!pedidosPorAta[item.ataId]) {
                        pedidosPorAta[item.ataId] = {
                            ataNumero: item.ataNumero,
                            fornecedorId: item.fornecedorId,
                            fornecedorRazao: item.fornecedorRazao,
                            fornecedorCnpj: item.fornecedorCnpj,
                            processo: item.processo,
                            objeto: item.objeto,
                            itens: [],
                        };
                    }
                    pedidosPorAta[item.ataId].itens.push(item);
                });

                let html = "";
                for (const [ataId, pedido] of Object.entries(pedidosPorAta)) {
                    const totalPedido = pedido.itens.reduce((s, i) => s + i.valorTotal, 0);

                    html += `<div style="background: var(--neutral-50); padding: 16px; border-radius: var(--border-radius-lg); margin-bottom: 16px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 12px;">
                            <div>
                                <h3 style="color: var(--neutral-900); font-size: 1rem;">Ata ${pedido.ataNumero}</h3>
                                <p style="color: var(--neutral-600); font-size: 0.8rem;">${pedido.fornecedorRazao || ""}</p>
                            </div>
                            <span style="background: var(--primary-600); color:white; padding: 6px 12px; border-radius: var(--border-radius-lg); font-size: 0.85rem;">Total: ${this.formatarMoeda(totalPedido)}</span>
                        </div>
                        <div class="tabela-container">
                            <table style="width:100%; font-size: 0.8rem;">
                                <thead>
                                    <tr style="background: var(--neutral-800); color: white;">
                                        <th style="padding: 8px;">Item</th>
                                        <th>Lote</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd</th>
                                        <th>Valor Unit.</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pedido.itens.map(i => `
                                        <tr>
                                            <td style="padding: 6px 8px;">${i.itemNumero}</td>
                                            <td><span class="lote-tag">${i.lote}</span></td>
                                            <td>${i.itemDescricao}</td>
                                            <td class="numeric">${i.quantidade}</td>
                                            <td class="numeric">${this.formatarMoeda(i.valorUnitario)}</td>
                                            <td class="numeric">${this.formatarMoeda(i.valorTotal)}</td>
                                            <td>
                                                <button onclick="sistema.removerDoCarrinho('${i.id}')" style="color: var(--error-600); background:none; border:none; cursor:pointer;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join("")}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                }

                html += `<div style="display:flex; gap: 10px; justify-content:flex-end;">
                    <button class="btn" style="background: var(--neutral-200); padding: 8px 16px; border:none; border-radius: var(--border-radius-md); font-size: 0.85rem;" onclick="sistema.limparCarrinho()"><i class="fas fa-trash"></i> Limpar</button>
                    <button class="btn-gerar-pedido" style="padding: 8px 16px; font-size: 0.85rem;" onclick="sistema.gerarPedidos()"><i class="fas fa-file-invoice"></i> Gerar Pedido</button>
                </div>`;

                document.getElementById("modalCarrinhoConteudo").innerHTML = html;
                document.getElementById("modalCarrinho").classList.add("active");
            }

            // ===== PEDIDOS =====
            async gerarPedidos() {
                if (this.carrinho.length === 0) return;

                const pedidosPorAta = {};
                this.carrinho.forEach(item => {
                    if (!pedidosPorAta[item.ataId]) {
                        pedidosPorAta[item.ataId] = {
                            ataNumero: item.ataNumero,
                            fornecedorId: item.fornecedorId,
                            fornecedorRazao: item.fornecedorRazao,
                            fornecedorCnpj: item.fornecedorCnpj,
                            processo: item.processo,
                            objeto: item.objeto,
                            itens: [],
                        };
                    }
                    pedidosPorAta[item.ataId].itens.push(item);
                });

                let pedidosHtml = "";
                const dataAtual = new Date().toISOString().split("T")[0];
                const dataExibicao = new Date().toLocaleDateString("pt-BR");
                this.pdfData = [];

                for (const [ataId, pedido] of Object.entries(pedidosPorAta)) {
                    const totalPedido = pedido.itens.reduce((s, i) => s + i.valorTotal, 0);
                    const numeroPedido = `PED-${new Date().getFullYear()}-${String(Date.now()).slice(-4)}-${String(Math.floor(Math.random() * 1000)).padStart(3, "0")}`;

                    this.pdfData.push({
                        numeroPedido,
                        data: dataExibicao,
                        pedido,
                        solicitante: this.usuarioAtual?.nome,
                        orgao: this.usuarioAtual?.orgao?.nome,
                        totalPedido,
                    });

                    try {
                        console.log("üìù Inserindo pedido...", {
                            numero_pedido: numeroPedido,
                            usuario_id: this.usuarioAtual.id,
                            ata_id: parseInt(ataId),
                            orgao_solicitante_id: this.usuarioAtual.orgao_id,
                            fornecedor_id: pedido.fornecedorId,
                            valor_total: totalPedido,
                        });

                        const { data: pedidoData, error: pedidoError } = await supabaseClient
                            .from("pedidos")
                            .insert({
                                numero_pedido: numeroPedido,
                                numero_requisicao: null,
                                usuario_id: this.usuarioAtual.id,
                                ata_id: parseInt(ataId),
                                orgao_solicitante_id: this.usuarioAtual.orgao_id,
                                fornecedor_id: pedido.fornecedorId,
                                data_solicitacao: dataAtual,
                                data_autorizacao: null,
                                status: "PEDIDO_REALIZADO",
                                observacoes: "Pedido gerado automaticamente via sistema",
                                justificativa: null,
                                valor_total: totalPedido,
                            })
                            .select()
                            .single();

                        if (pedidoError) {
                            console.error("‚ùå Erro ao inserir pedido:", pedidoError);
                            throw pedidoError;
                        }

                        console.log("‚úÖ Pedido inserido com ID:", pedidoData.id);

                        if (pedidoData && pedido.itens.length > 0) {
                            console.log(`üì¶ Inserindo ${pedido.itens.length} itens para o pedido ${pedidoData.id}...`);

                            for (const item of pedido.itens) {
                                const itemData = {
                                    pedido_id: pedidoData.id,
                                    item_ata_id: item.itemId,
                                    lote_numero: item.lote || "N/I",
                                    quantidade_solicitada: item.quantidade,
                                    valor_unitario: item.valorUnitario,
                                    valor_total: item.valorTotal,
                                };

                                console.log("Inserindo item:", itemData);

                                const { error: itemError } = await supabaseClient
                                    .from("itens_pedido")
                                    .insert(itemData);

                                if (itemError) {
                                    console.error("‚ùå Erro ao inserir item:", itemError);
                                    throw itemError;
                                }
                            }

                            console.log("‚úÖ Todos os itens inseridos com sucesso!");
                        }
                    } catch (e) {
                        console.error("‚ùå Erro ao gerar pedido:", e);
                        alert("‚ùå Erro ao gerar pedido: " + e.message);
                        return;
                    }

                    pedidosHtml += `<div class="pedido-container">
                        <div class="pedido-header">
                            <div>
                                <h2 class="pedido-titulo">PEDIDO N¬∫ ${numeroPedido}</h2>
                                <p class="pedido-subtitulo" style="font-size: 0.85rem;">${dataExibicao} | Ata: ${pedido.ataNumero}</p>
                            </div>
                            <span class="status-badge" style="background: var(--success-100); color: var(--success-800); font-size: 0.75rem;">
                                <i class="fas fa-check-circle"></i> PEDIDO REALIZADO
                            </span>
                        </div>
                        <div class="pedido-info-grid">
                            <div>
                                <p style="font-weight:700; font-size: 0.8rem;">FORNECEDOR</p>
                                <p style="font-size: 0.85rem;">${pedido.fornecedorRazao || ""}</p>
                                <p style="font-size: 0.75rem;">CNPJ: ${pedido.fornecedorCnpj || ""}</p>
                            </div>
                            <div>
                                <p style="font-weight:700; font-size: 0.8rem;">SOLICITANTE</p>
                                <p style="font-size: 0.85rem;">${this.usuarioAtual?.nome || ""}</p>
                                <p style="font-size: 0.75rem;">${this.usuarioAtual?.orgao?.nome || ""}</p>
                            </div>
                        </div>
                        <h4 style="margin-bottom: 12px; font-size: 0.9rem;">Itens do Pedido</h4>
                        <div class="tabela-container">
                            <table style="width:100%; font-size: 0.8rem;">
                                <thead>
                                    <tr style="background: var(--neutral-800); color:white;">
                                        <th style="padding: 8px;">Item</th>
                                        <th>Lote</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd</th>
                                        <th>Valor Unit.</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pedido.itens.map(i => `
                                        <tr>
                                            <td style="padding: 6px 8px;">${i.itemNumero}</td>
                                            <td><span class="lote-tag">${i.lote}</span></td>
                                            <td>${i.itemDescricao}</td>
                                            <td class="numeric">${i.quantidade}</td>
                                            <td class="numeric">${this.formatarMoeda(i.valorUnitario)}</td>
                                            <td class="numeric">${this.formatarMoeda(i.valorTotal)}</td>
                                        </tr>
                                    `).join("")}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" style="text-align:right; font-weight:700; padding: 10px;">TOTAL</td>
                                        <td style="color: var(--success-600); font-weight:700; text-align:right;">${this.formatarMoeda(totalPedido)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>`;
                }

                pedidosHtml += `<div style="display:flex; gap: 10px; justify-content:flex-end;">
                    <button class="btn" style="background: var(--neutral-200); padding: 8px 16px; border:none; border-radius: var(--border-radius-md); font-size: 0.85rem;" onclick="sistema.fecharModalPedido()">Fechar</button>
                    <button class="btn-pdf" style="padding: 8px 16px; font-size: 0.85rem;" onclick="sistema.visualizarPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>`;

                document.getElementById("modalPedidoConteudo").innerHTML = pedidosHtml;
                this.fecharModalCarrinho();
                document.getElementById("modalPedido").classList.add("active");

                this.carrinho = [];
                this.salvarCarrinhoStorage();
                await this.carregarPedidos();
            }

            async carregarPedidos() {
                const container = document.getElementById("pedidosLista");

                if (!this.usuarioAtual?.id) {
                    container.innerHTML = '<div style="text-align:center; padding: 40px;">Usu√°rio n√£o logado</div>';
                    return;
                }

                try {
                    console.log("Carregando pedidos para usu√°rio:", this.usuarioAtual.id);

                    const { data: pedidos, error } = await supabaseClient
                        .from("pedidos")
                        .select("*")
                        .eq("usuario_id", this.usuarioAtual.id)
                        .order("created_at", { ascending: false });

                    if (error) {
                        console.error("Erro ao carregar pedidos:", error);
                        throw error;
                    }

                    console.log("Pedidos carregados:", pedidos);

                    if (!pedidos?.length) {
                        container.innerHTML = '<div style="text-align:center; padding: 40px;"><i class="fas fa-file-invoice" style="font-size: 3rem; color: var(--neutral-400);"></i><h3 style="margin-top: 15px; color: var(--neutral-600); font-size: 1rem;">Nenhum pedido encontrado</h3><p style="color: var(--neutral-500); font-size: 0.85rem;">Os pedidos aparecer√£o aqui ap√≥s serem gerados</p></div>';
                        return;
                    }

                    const pedidosCompletos = await Promise.all(
                        pedidos.map(async (pedido) => {
                            const [usuarioResult, ataResult, fornecedorResult, orgaoResult, itensResult] = await Promise.all([
                                supabaseClient.from("usuarios").select("nome").eq("id", pedido.usuario_id).single(),
                                supabaseClient.from("atas").select("numero_ata, processo_administrativo").eq("id", pedido.ata_id).single(),
                                supabaseClient.from("fornecedores").select("razao_social, cnpj").eq("id", pedido.fornecedor_id).single(),
                                supabaseClient.from("orgaos").select("nome, sigla").eq("id", pedido.orgao_solicitante_id).single(),
                                supabaseClient.from("itens_pedido").select("*").eq("pedido_id", pedido.id),
                            ]);

                            const itensCompletos = [];
                            if (itensResult.data && itensResult.data.length > 0) {
                                for (const item of itensResult.data) {
                                    const { data: itemAta } = await supabaseClient
                                        .from("itens_ata")
                                        .select("descricao, item_numero")
                                        .eq("id", item.item_ata_id)
                                        .single();

                                    itensCompletos.push({
                                        ...item,
                                        descricao: itemAta?.descricao || "Descri√ß√£o n√£o encontrada",
                                        item_numero: itemAta?.item_numero || item.item_ata_id,
                                    });
                                }
                            }

                            return {
                                ...pedido,
                                usuario: usuarioResult.data || { nome: "N/I" },
                                ata: ataResult.data || { numero_ata: "N/I", processo_administrativo: "" },
                                fornecedor: fornecedorResult.data || { razao_social: "N/I", cnpj: "" },
                                orgao_solicitante: orgaoResult.data || { nome: "N/I", sigla: "" },
                                itens_pedido: itensCompletos,
                            };
                        })
                    );

                    container.innerHTML = pedidosCompletos.map(p => {
                        const totalCalculado = p.itens_pedido?.reduce((s, i) => s + (i.valor_total || 0), 0) || 0;
                        const valorExibicao = p.valor_total || totalCalculado;

                        return `<div style="background:white; border-radius: var(--border-radius-lg); padding: 16px; border:1px solid var(--neutral-200); margin-bottom: 16px; box-shadow: var(--shadow-sm);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px; flex-wrap:wrap;">
                                <div style="display:flex; align-items:center; gap: 10px; flex-wrap:wrap;">
                                    <span style="background: var(--primary-600); color:white; padding: 4px 10px; border-radius: 40px; font-weight:600; font-size: 0.75rem;">
                                        ${p.numero_pedido || "N/I"}
                                    </span>
                                    <span style="color: var(--neutral-500); font-size:0.8rem;">
                                        <i class="fas fa-calendar"></i> ${this.formatarData(p.data_solicitacao)}
                                    </span>
                                </div>
                                <span style="background: var(--success-100); color: var(--success-800); padding: 4px 10px; border-radius: 40px; font-weight:600; font-size: 0.75rem;">
                                    <i class="fas fa-check-circle"></i> ${p.status || "PEDIDO REALIZADO"}
                                </span>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; background: var(--neutral-50); padding: 12px; border-radius: var(--border-radius-lg);">
                                <div>
                                    <p style="font-size:0.65rem; text-transform:uppercase; color: var(--neutral-500); margin-bottom: 2px;">ATA</p>
                                    <p style="font-weight:600; margin-bottom: 2px; font-size: 0.85rem;">${p.ata?.numero_ata || "N/I"}</p>
                                    <p style="font-size:0.7rem; color: var(--neutral-600);">Proc: ${p.ata?.processo_administrativo || ""}</p>
                                </div>
                                <div>
                                    <p style="font-size:0.65rem; text-transform:uppercase; color: var(--neutral-500); margin-bottom: 2px;">FORNECEDOR</p>
                                    <p style="font-weight:600; margin-bottom: 2px; font-size: 0.85rem;">${p.fornecedor?.razao_social || "N/I"}</p>
                                    <p style="font-size:0.7rem; color: var(--neutral-600);">${p.fornecedor?.cnpj || ""}</p>
                                </div>
                                <div>
                                    <p style="font-size:0.65rem; text-transform:uppercase; color: var(--neutral-500); margin-bottom: 2px;">√ìRG√ÉO</p>
                                    <p style="font-weight:600; font-size: 0.85rem;">${p.orgao_solicitante?.nome || "N/I"}</p>
                                    <p style="font-size:0.7rem; color: var(--neutral-600);">${p.orgao_solicitante?.sigla || ""}</p>
                                </div>
                            </div>
                            
                            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap: 10px;">
                                <div>
                                    <p style="font-size:0.65rem; text-transform:uppercase; color: var(--neutral-500); margin-bottom: 2px;">VALOR TOTAL</p>
                                    <p style="font-weight:700; color: var(--success-600); font-size:1rem;">${this.formatarMoeda(valorExibicao)}</p>
                                </div>
                                <div style="display:flex; gap: 8px;">
                                    <button class="btn-visualizar" onclick="sistema.visualizarPedidoCompleto(${p.id})" style="padding: 6px 12px; font-size: 0.75rem;">
                                        <i class="fas fa-eye"></i> Ver Itens
                                    </button>
                                    <button class="btn-pdf" onclick="sistema.gerarPDFPedido(${p.id})" style="padding: 6px 12px; font-size: 0.75rem; background: var(--primary-600);">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-top: 12px; padding-top: 10px; border-top:1px solid var(--neutral-200); font-size:0.75rem; color: var(--neutral-500); display:flex; justify-content:space-between; flex-wrap:wrap;">
                                <span><i class="fas fa-user"></i> Solicitante: ${p.usuario?.nome || "N/I"}</span>
                                <span><i class="fas fa-boxes"></i> ${p.itens_pedido?.length || 0} item(ns)</span>
                            </div>
                        </div>`;
                    }).join("");
                } catch (error) {
                    console.error("Erro ao carregar pedidos:", error);
                    container.innerHTML = `<div style="text-align:center; padding: 30px; color: var(--error-600);">
                        <i class="fas fa-exclamation-triangle" style="font-size:2rem;"></i>
                        <h3 style="font-size: 0.9rem;">Erro ao carregar pedidos</h3>
                        <p style="font-size: 0.8rem;">${error.message}</p>
                    </div>`;
                }
            }

            async visualizarPedidoCompleto(pedidoId) {
                try {
                    console.log("Buscando pedido completo ID:", pedidoId);

                    const { data: pedido, error: pedidoError } = await supabaseClient
                        .from("pedidos")
                        .select("*")
                        .eq("id", pedidoId)
                        .single();

                    if (pedidoError || !pedido) {
                        console.error("Erro ao buscar pedido:", pedidoError);
                        alert("Pedido n√£o encontrado");
                        return;
                    }

                    console.log("Pedido encontrado:", pedido);

                    const [usuarioResult, ataResult, fornecedorResult, orgaoResult, itensResult] = await Promise.all([
                        supabaseClient.from("usuarios").select("nome").eq("id", pedido.usuario_id).single(),
                        supabaseClient.from("atas").select("numero_ata, processo_administrativo, objeto, data_inicio_vigencia, data_fim_vigencia").eq("id", pedido.ata_id).single(),
                        supabaseClient.from("fornecedores").select("razao_social, cnpj").eq("id", pedido.fornecedor_id).single(),
                        supabaseClient.from("orgaos").select("nome, sigla, cnpj").eq("id", pedido.orgao_solicitante_id).single(),
                        supabaseClient.from("itens_pedido").select("*").eq("pedido_id", pedido.id),
                    ]);

                    console.log("Itens do pedido (brutos):", itensResult.data);

                    const itensComDescricao = [];

                    if (itensResult.data && itensResult.data.length > 0) {
                        for (const item of itensResult.data) {
                            const { data: itemAta } = await supabaseClient
                                .from("itens_ata")
                                .select("descricao, item_numero, lote_numero")
                                .eq("id", item.item_ata_id)
                                .single();

                            itensComDescricao.push({
                                ...item,
                                descricao: itemAta?.descricao || "Descri√ß√£o n√£o encontrada",
                                item_numero: itemAta?.item_numero || item.item_ata_id,
                                lote_numero: itemAta?.lote_numero || item.lote_numero,
                            });
                        }
                    }

                    console.log("Itens com descri√ß√£o:", itensComDescricao);

                    const pedidoCompleto = {
                        ...pedido,
                        usuario: usuarioResult.data || { nome: "N/I" },
                        ata: ataResult.data || { numero_ata: "N/I", processo_administrativo: "", objeto: "", data_inicio_vigencia: null, data_fim_vigencia: null },
                        fornecedor: fornecedorResult.data || { razao_social: "N/I", cnpj: "" },
                        orgao_solicitante: orgaoResult.data || { nome: "N/I", sigla: "", cnpj: "" },
                        itens_pedido: itensComDescricao,
                    };

                    const totalPedido = pedidoCompleto.itens_pedido?.reduce((s, i) => s + (i.valor_total || 0), 0) || 0;

                    let html = `<div class="pedido-container">
                        <div class="pedido-header">
                            <div>
                                <h2 class="pedido-titulo">PEDIDO N¬∫ ${pedidoCompleto.numero_pedido}</h2>
                                <p class="pedido-subtitulo" style="font-size: 0.85rem;">${this.formatarData(pedidoCompleto.data_solicitacao)}</p>
                            </div>
                            <span class="status-badge" style="background: var(--success-100); color: var(--success-800); font-size: 0.75rem;">
                                <i class="fas fa-check-circle"></i> ${pedidoCompleto.status || "PEDIDO REALIZADO"}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <h3 style="color: var(--primary-700); margin-bottom: 8px; font-size: 0.9rem;">DADOS DA ATA</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; background: var(--neutral-50); padding: 12px; border-radius: var(--border-radius-lg);">
                                <div>
                                    <strong style="font-size: 0.8rem;">Ata n¬∫:</strong> <span style="font-size: 0.85rem;">${pedidoCompleto.ata?.numero_ata || "N/I"}</span><br>
                                    <strong style="font-size: 0.8rem;">Processo:</strong> <span style="font-size: 0.85rem;">${pedidoCompleto.ata?.processo_administrativo || "N/I"}</span><br>
                                    <strong style="font-size: 0.8rem;">Objeto:</strong> <span style="font-size: 0.85rem;">${pedidoCompleto.ata?.objeto || "N/I"}</span>
                                </div>
                                <div>
                                    <strong style="font-size: 0.8rem;">Vig√™ncia:</strong> <span style="font-size: 0.85rem;">${this.formatarData(pedidoCompleto.ata?.data_inicio_vigencia)} at√© ${this.formatarData(pedidoCompleto.ata?.data_fim_vigencia)}</span><br>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="background: var(--neutral-50); padding: 12px; border-radius: var(--border-radius-lg);">
                                <h4 style="color: var(--primary-700); margin-bottom: 6px; font-size: 0.85rem;">FORNECEDOR</h4>
                                <p style="font-size: 0.8rem;"><strong>Raz√£o Social:</strong> ${pedidoCompleto.fornecedor?.razao_social || "N/I"}</p>
                                <p style="font-size: 0.8rem;"><strong>CNPJ:</strong> ${pedidoCompleto.fornecedor?.cnpj || "N/I"}</p>
                            </div>
                            
                            <div style="background: var(--neutral-50); padding: 12px; border-radius: var(--border-radius-lg);">
                                <h4 style="color: var(--primary-700); margin-bottom: 6px; font-size: 0.85rem;">SOLICITANTE</h4>
                                <p style="font-size: 0.8rem;"><strong>√ìrg√£o:</strong> ${pedidoCompleto.orgao_solicitante?.nome || "N/I"} (${pedidoCompleto.orgao_solicitante?.sigla || ""})</p>
                                <p style="font-size: 0.8rem;"><strong>CNPJ:</strong> ${pedidoCompleto.orgao_solicitante?.cnpj || "N/I"}</p>
                                <p style="font-size: 0.8rem;"><strong>Solicitante:</strong> ${pedidoCompleto.usuario?.nome || "N/I"}</p>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 10px; font-size: 0.9rem;">ITENS DO PEDIDO</h4>
                        <div class="tabela-container">
                            <table style="width:100%; border-collapse: collapse; font-size: 0.75rem;">
                                <thead>
                                    <tr style="background: var(--neutral-800); color:white;">
                                        <th style="padding: 8px; text-align:left;">Item</th>
                                        <th style="padding: 8px; text-align:left;">Lote</th>
                                        <th style="padding: 8px; text-align:left;">Descri√ß√£o</th>
                                        <th style="padding: 8px; text-align:right;">Qtd</th>
                                        <th style="padding: 8px; text-align:right;">Valor Unit.</th>
                                        <th style="padding: 8px; text-align:right;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pedidoCompleto.itens_pedido?.map(i => `
                                        <tr>
                                            <td style="padding: 6px 8px; border-bottom:1px solid var(--neutral-200);">${i.item_numero || i.item_ata_id}</td>
                                            <td style="padding: 6px 8px; border-bottom:1px solid var(--neutral-200);"><span class="lote-tag">${i.lote_numero || ""}</span></td>
                                            <td style="padding: 6px 8px; border-bottom:1px solid var(--neutral-200);">${i.descricao || "Descri√ß√£o n√£o dispon√≠vel"}</td>
                                            <td style="padding: 6px 8px; text-align:right; border-bottom:1px solid var(--neutral-200);">${i.quantidade_solicitada || 0}</td>
                                            <td style="padding: 6px 8px; text-align:right; border-bottom:1px solid var(--neutral-200);">${this.formatarMoeda(i.valor_unitario)}</td>
                                            <td style="padding: 6px 8px; text-align:right; border-bottom:1px solid var(--neutral-200);">${this.formatarMoeda(i.valor_total)}</td>
                                        </tr>
                                    `).join("")}
                                </tbody>
                                <tfoot>
                                    <tr style="background: var(--neutral-50);">
                                        <td colspan="5" style="padding: 10px; text-align:right; font-weight:700;">TOTAL DO PEDIDO</td>
                                        <td style="padding: 10px; text-align:right; font-weight:700; color: var(--success-600);">${this.formatarMoeda(totalPedido)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; font-size: 0.7rem; color: var(--neutral-500); font-style: italic; text-align: center; border-top: 1px solid var(--neutral-200); padding-top: 12px;">
                            <p>Este documento foi gerado eletronicamente pelo Sistema de Gest√£o de Atas em ${new Date().toLocaleString("pt-BR")}.</p>
                            <p>√â de responsabilidade do solicitante a confer√™ncia dos dados e saldos apresentados.</p>
                            <p>Em caso de diverg√™ncia entre as informa√ß√µes deste documento e o processo licitat√≥rio original, prevalecem os dados constantes no processo administrativo e na ata de registro de pre√ßos.</p>
                            <p style="margin-top: 6px;">Sistema desenvolvido por [NOME DA EMPRESA/√ìRG√ÉO] - Vers√£o 1.0</p>
                        </div>
                        
                        <div style="display:flex; gap: 10px; justify-content:flex-end; margin-top:16px;">
                            <button class="btn" style="background: var(--neutral-200); padding: 6px 14px; border:none; border-radius: var(--border-radius-md); cursor:pointer; font-size: 0.8rem;" onclick="sistema.fecharModalVisualizarPedido()">Fechar</button>
                            <button class="btn-pdf" style="background: var(--primary-600); color:white; padding: 6px 14px; border:none; border-radius: var(--border-radius-md); cursor:pointer; font-size: 0.8rem;" onclick="sistema.gerarPDFPedido(${pedido.id})"><i class="fas fa-file-pdf"></i> PDF</button>
                        </div>
                    </div>`;

                    document.getElementById("modalVisualizarPedidoConteudo").innerHTML = html;
                    document.getElementById("modalVisualizarPedido").classList.add("active");
                } catch (error) {
                    console.error("Erro ao visualizar pedido:", error);
                    alert("Erro ao carregar detalhes do pedido: " + error.message);
                }
            }

            async gerarPDFPedido(pedidoId) {
                try {
                    const pedido = await this.carregarPedidoCompleto(pedidoId);

                    if (!pedido) {
                        alert("‚ùå Pedido n√£o encontrado!");
                        return;
                    }

                    const total = pedido.itens_pedido.reduce((s, i) => s + (i.valor_total || 0), 0);

                    this.pdfData = [{
                        numeroPedido: pedido.numero_pedido,
                        data: new Date(pedido.data_solicitacao).toLocaleDateString("pt-BR"),
                        pedido: {
                            fornecedorRazao: pedido.fornecedor?.razao_social,
                            fornecedorCnpj: pedido.fornecedor?.cnpj,
                            orgaoNome: pedido.orgao_solicitante?.nome,
                            orgaoCnpj: pedido.orgao_solicitante?.cnpj,
                            ataNumero: pedido.ata?.numero_ata,
                            ataProcesso: pedido.ata?.processo_administrativo,
                            ataObjeto: pedido.ata?.objeto,
                            ataVigenciaInicio: pedido.ata?.data_inicio_vigencia,
                            ataVigenciaFim: pedido.ata?.data_fim_vigencia,
                            itens: pedido.itens_pedido.map(item => ({
                                itemNumero: item.item_numero,
                                lote: item.lote_numero || "",
                                itemDescricao: item.descricao,
                                quantidade: item.quantidade_solicitada,
                                valorUnitario: item.valor_unitario,
                                valorTotal: item.valor_total,
                            })),
                        },
                        solicitante: pedido.usuario?.nome,
                        orgao: pedido.orgao_solicitante?.nome,
                        totalPedido: total,
                    }];

                    this.baixarPDF();
                } catch (error) {
                    alert("‚ùå Erro: " + error.message);
                }
            }

            async carregarPedidoCompleto(pedidoId) {
                try {
                    console.log("Carregando pedido ID:", pedidoId);

                    const { data: pedido, error: erroPedido } = await supabaseClient
                        .from("pedidos")
                        .select("*")
                        .eq("id", pedidoId)
                        .single();

                    if (erroPedido || !pedido) {
                        console.error("Pedido n√£o encontrado:", pedidoId);
                        return null;
                    }

                    const [usuarioResult, ataResult, fornecedorResult, orgaoResult, itensResult] = await Promise.all([
                        supabaseClient.from("usuarios").select("nome").eq("id", pedido.usuario_id).single(),
                        supabaseClient.from("atas").select("numero_ata, processo_administrativo, objeto, data_inicio_vigencia, data_fim_vigencia").eq("id", pedido.ata_id).single(),
                        supabaseClient.from("fornecedores").select("razao_social, cnpj").eq("id", pedido.fornecedor_id).single(),
                        supabaseClient.from("orgaos").select("nome, sigla, cnpj").eq("id", pedido.orgao_solicitante_id).single(),
                        supabaseClient.from("itens_pedido").select("*").eq("pedido_id", pedidoId),
                    ]);

                    const itensCompletos = [];
                    if (itensResult.data && itensResult.data.length > 0) {
                        for (const item of itensResult.data) {
                            const { data: itemAta } = await supabaseClient
                                .from("itens_ata")
                                .select("descricao, item_numero, lote_numero")
                                .eq("id", item.item_ata_id)
                                .single();

                            itensCompletos.push({
                                ...item,
                                descricao: itemAta?.descricao || "Descri√ß√£o n√£o encontrada",
                                item_numero: itemAta?.item_numero || item.item_ata_id,
                                lote_numero: itemAta?.lote_numero || item.lote_numero,
                            });
                        }
                    }

                    return {
                        ...pedido,
                        usuario: usuarioResult.data || { nome: "N/I" },
                        ata: ataResult.data || { numero_ata: "N/I", processo_administrativo: "", objeto: "", data_inicio_vigencia: null, data_fim_vigencia: null },
                        fornecedor: fornecedorResult.data || { razao_social: "N/I", cnpj: "" },
                        orgao_solicitante: orgaoResult.data || { nome: "N/I", sigla: "", cnpj: "" },
                        itens_pedido: itensCompletos,
                    };
                } catch (error) {
                    console.error("Erro:", error);
                    return null;
                }
            }

            // ===== USU√ÅRIOS =====
            async carregarTabelaUsuarios() {
                const tbody = document.getElementById("tabelaUsuariosBody");
                if (!tbody) return;

                await this.carregarOrgaos();

                const { data: usuarios } = await supabaseClient
                    .from("usuarios")
                    .select("*, orgao:orgaos(*)")
                    .eq("ativo", true)
                    .order("nome");

                if (!usuarios?.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Nenhum usu√°rio</td></tr>';
                    return;
                }

                tbody.innerHTML = usuarios.map(user => {
                    const perfilClass = {
                        ADMIN: "perfil-admin",
                        SECRETARIO: "perfil-secretario",
                        SOLICITANTE: "perfil-solicitante",
                        ESTAGIARIO: "perfil-estagiario",
                    }[user.perfil];

                    return `<tr>
                        <td><strong style="font-size: 0.85rem;">${user.nome}</strong></td>
                        <td style="font-size: 0.8rem;">${user.email}</td>
                        <td style="font-size: 0.8rem;">${user.orgao?.nome || ""}</td>
                        <td><span class="badge-perfil ${perfilClass}" style="font-size: 0.65rem;">${user.perfil}</span></td>
                        <td><span class="badge-perfil status-ativo" style="font-size: 0.65rem;"><i class="fas fa-circle"></i> Ativo</span></td>
                        <td>
                            ${user.perfil === "ADMIN" ? `
                                <button class="btn-editar-usuario" onclick="sistema.editarUsuario(${user.id})" style="padding: 4px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ""}
                            ${user.id !== this.usuarioAtual?.id && user.perfil !== "ADMIN" ? `<button class="btn-desativar-usuario" onclick="sistema.desativarUsuario(${user.id})" style="padding: 4px;"><i class="fas fa-trash"></i></button>` : ""}
                        </td>
                    </tr>`;
                }).join("");
            }

            abrirModalUsuario(usuarioId = null) {
                if (this.usuarioAtual?.perfil !== "ADMIN") {
                    alert("Apenas administradores");
                    return;
                }

                this.carregarSelectOrgaos("usuarioOrgao");

                if (usuarioId) {
                    document.getElementById("modalUsuarioTitulo").innerHTML = '<i class="fas fa-edit"></i> Editar Usu√°rio';
                    this.editarUsuario(usuarioId);
                } else {
                    document.getElementById("modalUsuarioTitulo").innerHTML = '<i class="fas fa-user-plus"></i> Novo Usu√°rio';
                    document.getElementById("usuarioId").value = "";
                    document.getElementById("usuarioNome").value = "";
                    document.getElementById("usuarioEmail").value = "";
                    document.getElementById("usuarioSenha").value = "";
                    document.getElementById("usuarioPerfil").value = "SOLICITANTE";
                    document.getElementById("modalUsuario").classList.add("active");
                }
            }

            async editarUsuario(id) {
                const { data: usuario } = await supabaseClient
                    .from("usuarios")
                    .select("*")
                    .eq("id", id)
                    .single();

                if (usuario) {
                    document.getElementById("usuarioId").value = usuario.id;
                    document.getElementById("usuarioNome").value = usuario.nome || "";
                    document.getElementById("usuarioEmail").value = usuario.email || "";
                    document.getElementById("usuarioSenha").value = "";
                    document.getElementById("usuarioPerfil").value = usuario.perfil || "SOLICITANTE";

                    await this.carregarSelectOrgaos("usuarioOrgao", usuario.orgao_id);

                    document.getElementById("modalUsuario").classList.add("active");
                }
            }

            fecharModalUsuario() {
                document.getElementById("modalUsuario").classList.remove("active");
            }

            async salvarUsuario() {
                const id = document.getElementById("usuarioId").value;
                const nome = document.getElementById("usuarioNome").value;
                const email = document.getElementById("usuarioEmail").value;
                const senha = document.getElementById("usuarioSenha").value;
                const orgaoId = parseInt(document.getElementById("usuarioOrgao").value);
                const perfil = document.getElementById("usuarioPerfil").value;

                if (!nome || !email || !orgaoId) {
                    alert("Preencha todos os campos obrigat√≥rios");
                    return;
                }

                try {
                    if (id) {
                        const { error: updateError } = await supabaseClient
                            .from("usuarios")
                            .update({
                                nome,
                                email,
                                perfil,
                                orgao_id: orgaoId,
                            })
                            .eq("id", id);

                        if (updateError) throw updateError;
                        alert("‚úÖ Usu√°rio atualizado!");
                    } else {
                        if (!senha || senha.length < 6) {
                            alert("Senha deve ter no m√≠nimo 6 caracteres");
                            return;
                        }

                        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                            email,
                            password: senha,
                            options: { data: { name: nome } },
                        });

                        if (authError) throw authError;

                        const { error: insertError } = await supabaseClient
                            .from("usuarios")
                            .insert({
                                uuid: authData.user.id,
                                nome,
                                email,
                                perfil,
                                orgao_id: orgaoId,
                                ativo: true,
                            });

                        if (insertError) throw insertError;
                        alert("‚úÖ Usu√°rio criado!");
                    }

                    this.fecharModalUsuario();
                    await this.carregarTabelaUsuarios();
                } catch (error) {
                    alert("Erro: " + error.message);
                }
            }

            async desativarUsuario(id) {
                if (!confirm("Desativar usu√°rio?")) return;

                const { error } = await supabaseClient
                    .from("usuarios")
                    .update({ ativo: false })
                    .eq("id", id);

                if (!error) {
                    alert("‚úÖ Usu√°rio desativado");
                    await this.carregarTabelaUsuarios();
                }
            }

            // ===== CADASTRO DE ATAS =====
            adicionarItemCadastro() {
                this.itensCadastroTemp.push({
                    id: Date.now(),
                    numero: this.itensCadastroTemp.length + 1,
                    lote: "",
                    descricao: "",
                    quantidade: 0,
                    valor_unitario: 0,
                    valor_total: 0,
                });
                this.renderizarItensCadastro();
            }

            removerItemCadastro(id) {
                this.itensCadastroTemp = this.itensCadastroTemp.filter(i => i.id !== id);
                this.itensCadastroTemp.forEach((item, idx) => item.numero = idx + 1);
                this.renderizarItensCadastro();
            }

            calcularTotaisItem() {
                this.itensCadastroTemp.forEach(item => {
                    item.valor_total = (item.quantidade || 0) * (item.valor_unitario || 0);
                });
                this.renderizarItensCadastro();
            }

            renderizarItensCadastro() {
                const tbody = document.getElementById("itensCadastroBody");
                if (!tbody) return;

                tbody.innerHTML = this.itensCadastroTemp.map(item => `<tr>
                    <td><input type="text" value="${item.numero}" onchange="sistema.atualizarItemCadastro(${item.id}, 'numero', this.value)" style="width:60px; font-size: 0.8rem;"></td>
                    <td><input type="text" value="${item.lote}" onchange="sistema.atualizarItemCadastro(${item.id}, 'lote', this.value)" placeholder="Lote" style="width:100px; font-size: 0.8rem;" required></td>
                    <td><input type="text" value="${item.descricao}" onchange="sistema.atualizarItemCadastro(${item.id}, 'descricao', this.value)" placeholder="Descri√ß√£o" style="width:100%; font-size: 0.8rem;" required></td>
                    <td><input type="number" value="${item.quantidade}" onchange="sistema.atualizarItemCadastro(${item.id}, 'quantidade', parseInt(this.value)||0); sistema.calcularTotaisItem();" min="0" style="width:70px; font-size: 0.8rem;" required></td>
                    <td><input type="number" value="${item.valor_unitario}" onchange="sistema.atualizarItemCadastro(${item.id}, 'valor_unitario', parseFloat(this.value)||0); sistema.calcularTotaisItem();" min="0" step="0.01" style="width:90px; font-size: 0.8rem;" required></td>
                    <td style="text-align:right; font-weight:600; font-size: 0.8rem;">${this.formatarMoeda(item.valor_total)}</td>
                    <td><button type="button" class="btn-remover-item" onclick="sistema.removerItemCadastro(${item.id})" style="padding: 4px;"><i class="fas fa-trash"></i></button></td>
                </tr>`).join("");

                document.getElementById("totalItensCadastro").innerHTML = this.itensCadastroTemp.length;
                const totalAta = this.itensCadastroTemp.reduce((s, i) => s + (i.valor_total || 0), 0);
                document.getElementById("valorTotalAta").innerHTML = this.formatarMoeda(totalAta);
            }

            atualizarItemCadastro(id, campo, valor) {
                const item = this.itensCadastroTemp.find(i => i.id === id);
                if (item) item[campo] = valor;
            }

            async salvarAta() {
                if (this.itensCadastroTemp.length === 0) {
                    alert("Adicione pelo menos um item");
                    return;
                }

                for (const item of this.itensCadastroTemp) {
                    if (!item.lote?.trim()) {
                        alert(`Item ${item.numero}: Lote obrigat√≥rio`);
                        return;
                    }
                    if (!item.descricao?.trim()) {
                        alert(`Item ${item.numero}: Descri√ß√£o obrigat√≥ria`);
                        return;
                    }
                    if (item.quantidade <= 0) {
                        alert(`Item ${item.numero}: Quantidade > 0`);
                        return;
                    }
                    if (item.valor_unitario <= 0) {
                        alert(`Item ${item.numero}: Valor unit√°rio > 0`);
                        return;
                    }
                }

                try {
                    let fornecedorId = null;
                    const { data: fornecedorExistente } = await supabaseClient
                        .from("fornecedores")
                        .select("id")
                        .eq("cnpj", document.getElementById("fornecedorCnpj").value)
                        .maybeSingle();

                    if (fornecedorExistente) {
                        fornecedorId = fornecedorExistente.id;
                    } else {
                        const { data: novoFornecedor } = await supabaseClient
                            .from("fornecedores")
                            .insert({
                                razao_social: document.getElementById("fornecedorRazao").value,
                                cnpj: document.getElementById("fornecedorCnpj").value,
                            })
                            .select()
                            .single();
                        fornecedorId = novoFornecedor.id;
                    }

                    const { data: ata } = await supabaseClient
                        .from("atas")
                        .insert({
                            numero_ata: document.getElementById("ataNumero").value,
                            processo_administrativo: document.getElementById("processoNumero").value,
                            pregao_numero: document.getElementById("pregaoNumero").value,
                            data_assinatura: document.getElementById("dataAssinatura").value,
                            data_inicio_vigencia: document.getElementById("vigenciaInicio").value,
                            data_fim_vigencia: document.getElementById("vigenciaFim").value,
                            objeto: document.getElementById("objeto").value,
                            fornecedor_id: fornecedorId,
                            situacao: "ATIVA",
                            valor_global: this.itensCadastroTemp.reduce((s, i) => s + (i.valor_total || 0), 0),
                            usuario_cadastro_id: this.usuarioAtual.id,
                        })
                        .select()
                        .single();

                    for (const item of this.itensCadastroTemp) {
                        await supabaseClient.from("itens_ata").insert({
                            ata_id: ata.id,
                            item_numero: item.numero,
                            descricao: item.descricao,
                            quantidade_contratada: item.quantidade,
                            saldo_quantidade: item.quantidade,
                            valor_unitario: item.valor_unitario,
                            valor_total: item.valor_total,
                            lote_numero: item.lote,
                            categoria: "Geral",
                        });
                    }

                    alert("‚úÖ Ata cadastrada!");
                    this.itensCadastroTemp = [];
                    this.renderizarItensCadastro();
                    document.getElementById("formCadastroAta").reset();
                    this.ativarTab("consulta");
                    await this.carregarAtas();
                } catch (error) {
                    alert("Erro: " + error.message);
                }
            }

            executarExtracaoPDF() {
                alert("Extra√ß√£o de PDF (em breve)");
            }

            // ===== PDF =====
            visualizarPDF() {
                if (!this.pdfData?.length) {
                    alert("Nenhum pedido");
                    return;
                }

                let pdfHtml = "";
                this.pdfData.forEach(item => {
                    const pedido = item.pedido;
                    const total = pedido.itens.reduce((s, i) => s + i.valorTotal, 0);

                    pdfHtml += `<div class="pdf-pagina" style="font-family: Arial, sans-serif;">
                        <h2 style="text-align:center; color: var(--neutral-900); margin-bottom:16px; font-size: 1.2rem;">PEDIDO DE COMPRA</h2>
                        <p style="text-align:center; font-weight:600; margin-bottom:16px; font-size: 0.9rem;">N¬∫ ${item.numeroPedido}</p>
                        
                        <div style="margin-bottom: 16px;">
                            <h3 style="color: var(--primary-700); margin-bottom: 8px; font-size: 0.9rem;">DADOS DA ATA</h3>
                            <p style="font-size: 0.8rem;"><strong>Ata n¬∫:</strong> ${pedido.ataNumero || "N/I"}</p>
                            <p style="font-size: 0.8rem;"><strong>Processo:</strong> ${pedido.ataProcesso || "N/I"}</p>
                            <p style="font-size: 0.8rem;"><strong>Objeto:</strong> ${pedido.ataObjeto || "N/I"}</p>
                            <p style="font-size: 0.8rem;"><strong>Vig√™ncia:</strong> ${pedido.ataVigenciaInicio ? this.formatarData(pedido.ataVigenciaInicio) : "N/I"} at√© ${pedido.ataVigenciaFim ? this.formatarData(pedido.ataVigenciaFim) : "N/I"}</p>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div style="border: 1px solid var(--neutral-200); padding: 10px; border-radius: var(--border-radius-lg);">
                                <h4 style="color: var(--primary-700); margin-bottom: 6px; font-size: 0.85rem;">FORNECEDOR</h4>
                                <p style="font-size: 0.8rem;"><strong>Raz√£o Social:</strong> ${pedido.fornecedorRazao || "N/I"}</p>
                                <p style="font-size: 0.8rem;"><strong>CNPJ:</strong> ${pedido.fornecedorCnpj || "N/I"}</p>
                            </div>
                            
                            <div style="border: 1px solid var(--neutral-200); padding: 10px; border-radius: var(--border-radius-lg);">
                                <h4 style="color: var(--primary-700); margin-bottom: 6px; font-size: 0.85rem;">SOLICITANTE</h4>
                                <p style="font-size: 0.8rem;"><strong>√ìrg√£o:</strong> ${pedido.orgaoNome || "N/I"}</p>
                                <p style="font-size: 0.8rem;"><strong>CNPJ:</strong> ${pedido.orgaoCnpj || "N/I"}</p>
                                <p style="font-size: 0.8rem;"><strong>Solicitante:</strong> ${item.solicitante || "N/I"}</p>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 10px; font-size: 0.85rem;">ITENS DO PEDIDO</h4>
                        <table style="width:100%; border-collapse:collapse; margin-top:8px; font-size: 0.7rem;">
                            <thead>
                                <tr style="background: var(--neutral-900); color:white;">
                                    <th style="padding: 6px;">Item</th>
                                    <th>Lote</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Qtd</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pedido.itens.map(i => `
                                    <tr>
                                        <td style="padding: 4px; border-bottom:1px solid var(--neutral-200);">${i.itemNumero}</td>
                                        <td style="border-bottom:1px solid var(--neutral-200);">${i.lote}</td>
                                        <td style="border-bottom:1px solid var(--neutral-200);">${i.itemDescricao}</td>
                                        <td style="text-align:right; border-bottom:1px solid var(--neutral-200);">${i.quantidade}</td>
                                        <td style="text-align:right; border-bottom:1px solid var(--neutral-200);">${this.formatarMoeda(i.valorUnitario)}</td>
                                        <td style="text-align:right; border-bottom:1px solid var(--neutral-200);">${this.formatarMoeda(i.valorTotal)}</td>
                                    </tr>
                                `).join("")}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" style="text-align:right; font-weight:700; padding: 6px;">TOTAL DO PEDIDO</td>
                                    <td style="color: var(--success-600); font-weight:700; text-align:right;">${this.formatarMoeda(total)}</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div style="margin-top: 16px; font-size: 0.65rem; color: var(--neutral-500); font-style: italic; text-align: center; border-top: 1px solid var(--neutral-200); padding-top: 8px;">
                            <p>Este documento foi gerado eletronicamente pelo Sistema de Gest√£o de Atas em ${new Date().toLocaleString("pt-BR")}.</p>
                            <p>√â de responsabilidade do solicitante a confer√™ncia dos dados e saldos apresentados.</p>
                            <p>Em caso de diverg√™ncia entre as informa√ß√µes deste documento e o processo licitat√≥rio original, prevalecem os dados constantes no processo administrativo e na ata de registro de pre√ßos.</p>
                            <p style="margin-top: 4px;">Sistema desenvolvido por [NOME DA EMPRESA/√ìRG√ÉO] - Vers√£o 1.0</p>
                        </div>
                    </div>`;
                });

                document.getElementById("pdfConteudo").innerHTML = pdfHtml;
                document.getElementById("pdfVisualizador").classList.add("active");
            }

            baixarPDF() {
                if (!this.pdfData || this.pdfData.length === 0) {
                    alert("Nenhum dado para gerar PDF");
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    let yOffset = 15;
                    const pageHeight = doc.internal.pageSize.height;
                    const pageWidth = doc.internal.pageSize.width;

                    this.pdfData.forEach((item, index) => {
                        if (index > 0) {
                            doc.addPage();
                            yOffset = 15;
                        }

                        const pedido = item.pedido;
                        const total = pedido.itens.reduce((s, i) => s + i.valorTotal, 0);

                        doc.setFontSize(14);
                        doc.text("PEDIDO DE COMPRA", pageWidth / 2, yOffset, { align: "center" });
                        yOffset += 8;

                        doc.setFontSize(11);
                        doc.text(`N¬∫ ${item.numeroPedido}`, pageWidth / 2, yOffset, { align: "center" });
                        yOffset += 10;

                        doc.setFontSize(10);
                        doc.setTextColor(79, 70, 229);
                        doc.text("DADOS DA ATA", 15, yOffset);
                        yOffset += 6;

                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Ata n¬∫: ${pedido.ataNumero || "N/I"}`, 15, yOffset);
                        yOffset += 5;
                        doc.text(`Processo: ${pedido.ataProcesso || "N/I"}`, 15, yOffset);
                        yOffset += 5;

                        const objeto = pedido.ataObjeto || "N/I";
                        const linhasObjeto = doc.splitTextToSize(`Objeto: ${objeto}`, pageWidth - 30);
                        doc.text(linhasObjeto[0], 15, yOffset);
                        yOffset += 5;

                        for (let i = 1; i < linhasObjeto.length; i++) {
                            doc.text(linhasObjeto[i], 15, yOffset);
                            yOffset += 5;
                        }

                        doc.text(
                            `Vig√™ncia: ${pedido.ataVigenciaInicio ? this.formatarData(pedido.ataVigenciaInicio) : "N/I"} at√© ${pedido.ataVigenciaFim ? this.formatarData(pedido.ataVigenciaFim) : "N/I"}`,
                            15,
                            yOffset
                        );
                        yOffset += 8;

                        doc.setFontSize(10);
                        doc.setTextColor(79, 70, 229);
                        doc.text("FORNECEDOR", 15, yOffset);
                        yOffset += 6;

                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Raz√£o Social: ${pedido.fornecedorRazao || "N/I"}`, 15, yOffset);
                        yOffset += 5;
                        doc.text(`CNPJ: ${pedido.fornecedorCnpj || "N/I"}`, 15, yOffset);
                        yOffset += 8;

                        doc.setFontSize(10);
                        doc.setTextColor(79, 70, 229);
                        doc.text("SOLICITANTE", 15, yOffset);
                        yOffset += 6;

                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`√ìrg√£o: ${pedido.orgaoNome || "N/I"}`, 15, yOffset);
                        yOffset += 5;
                        doc.text(`CNPJ: ${pedido.orgaoCnpj || "N/I"}`, 15, yOffset);
                        yOffset += 5;
                        doc.text(`Solicitante: ${item.solicitante || "N/I"}`, 15, yOffset);
                        yOffset += 8;

                        const tableData = pedido.itens.map(i => [
                            i.itemNumero,
                            i.lote,
                            i.itemDescricao.substring(0, 40) + (i.itemDescricao.length > 40 ? "..." : ""),
                            i.quantidade.toString(),
                            this.formatarMoeda(i.valorUnitario).replace('R$', '').trim(),
                            this.formatarMoeda(i.valorTotal).replace('R$', '').trim(),
                        ]);

                        doc.autoTable({
                            startY: yOffset,
                            head: [["Item", "Lote", "Descri√ß√£o", "Qtd", "Valor Unit.", "Total"]],
                            body: tableData,
                            foot: [[
                                { content: "TOTAL DO PEDIDO", colSpan: 5, styles: { halign: "right", fontStyle: "bold", fontSize: 9 } },
                                { content: this.formatarMoeda(total).replace('R$', '').trim(), styles: { fontStyle: "bold", fontSize: 9, halign: "right" } },
                            ]],
                            theme: "striped",
                            headStyles: { fillColor: [79, 70, 229], textColor: 255, fontSize: 8, halign: "center" },
                            footStyles: { fillColor: [241, 245, 249], textColor: [79, 70, 229], fontStyle: "bold", fontSize: 9 },
                            columnStyles: {
                                0: { cellWidth: 10, halign: "center" },
                                1: { cellWidth: 15, halign: "center" },
                                2: { cellWidth: 75, halign: "left" },
                                3: { cellWidth: 12, halign: "right" },
                                4: { cellWidth: 20, halign: "right" },
                                5: { cellWidth: 20, halign: "right" },
                            },
                            styles: { fontSize: 7, cellPadding: 1.5, overflow: 'linebreak' },
                            margin: { left: 15, right: 15 },
                            tableWidth: 'auto',
                        });

                        yOffset = doc.lastAutoTable.finalY + 10;

                        if (yOffset > pageHeight - 30) {
                            doc.addPage();
                            yOffset = 15;
                        }

                        doc.setFontSize(7);
                        doc.setTextColor(100, 116, 139);

                        const rodape = [
                            "Este documento foi gerado eletronicamente pelo Sistema de Gest√£o de Atas.",
                            "√â de responsabilidade do solicitante a confer√™ncia dos dados e saldos apresentados.",
                            "Em caso de diverg√™ncia entre as informa√ß√µes deste documento e o processo licitat√≥rio original,",
                            "prevalecem os dados constantes no processo administrativo e na ata de registro de pre√ßos.",
                            "Sistema desenvolvido por [NOME DA EMPRESA/√ìRG√ÉO] - Vers√£o 1.0"
                        ];

                        rodape.forEach((linha) => {
                            doc.text(linha, pageWidth / 2, yOffset, { align: "center" });
                            yOffset += 3.5;
                        });
                    });

                    const dataAtual = new Date().toLocaleDateString("pt-BR").replace(/\//g, "-");
                    doc.save(`pedido_${dataAtual}.pdf`);

                    alert("‚úÖ PDF gerado com sucesso!");
                } catch (error) {
                    console.error("Erro ao gerar PDF:", error);
                    alert("‚ùå Erro ao gerar PDF: " + error.message);
                }
            }

            fecharPdfVisualizador() {
                document.getElementById("pdfVisualizador").classList.remove("active");
            }

            // ===== FILTROS =====
            filtrarAtas() {
                this.carregarAtas();
            }

            // ===== FECHAMENTO DE MODAIS =====
            fecharModal() {
                document.getElementById("modalDetalhes").classList.remove("active");
                this.ataSelecionada = null;
            }

            fecharModalConsumo() {
                document.getElementById("modalConsumo").classList.remove("active");
            }

            fecharModalCarrinho() {
                document.getElementById("modalCarrinho").classList.remove("active");
            }

            fecharModalPedido() {
                document.getElementById("modalPedido").classList.remove("active");
                this.pdfData = null;
            }

            fecharModalVisualizarPedido() {
                document.getElementById("modalVisualizarPedido").classList.remove("active");
            }

            // ===== UTILIT√ÅRIOS =====
            formatarMoeda(valor) {
                return (valor || 0).toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                });
            }

            formatarData(dataISO) {
                try {
                    if (!dataISO) return "N/I";
                    return new Date(dataISO).toLocaleDateString("pt-BR");
                } catch {
                    return "N/I";
                }
            }
        }

        // =====================================================
        // INICIALIZA√á√ÉO
        // =====================================================
        const sistema = new SistemaGestaoAtas();
        window.sistema = sistema;
    </script>
</body>
</html>

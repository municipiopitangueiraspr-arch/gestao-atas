<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìã Sistema de Gest√£o de Atas - Pedido com Lote</title>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- SUPABASE JS - ADICIONADO -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      /* ========================================= */
      /* SISTEMA DE GEST√ÉO DE ATAS - PEDIDO COM LOTE */
      /* ========================================= */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: #f1f5f9;
        color: #0f172a;
      }

      .app {
        max-width: 1440px;
        margin: 0 auto;
        padding: 20px;
      }

      /* ===== TELA DE LOGIN ===== */
      .login-container {
        max-width: 400px;
        margin: 80px auto;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .login-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .login-header h1 {
        font-size: 1.8rem;
        color: #0f172a;
        margin-bottom: 10px;
      }

      .login-header i {
        color: #2563eb;
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .login-form .form-group {
        margin-bottom: 20px;
      }

      .login-form label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        margin-bottom: 5px;
        text-transform: uppercase;
      }

      .login-form input,
      .login-form select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s;
      }

      .login-form input:focus,
      .login-form select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn-login {
        width: 100%;
        padding: 14px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 10px;
      }

      .btn-login:hover {
        background: #1d4ed8;
      }

      .login-info {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #475569;
        border-left: 4px solid #2563eb;
      }

      .login-error {
        color: #dc2626;
        margin-top: 15px;
        text-align: center;
        padding: 10px;
        background: #fee2e2;
        border-radius: 8px;
        display: none;
      }

      /* ===== HEADER ===== */
      .header {
        background: linear-gradient(135deg, #0f172a, #1e293b);
        color: white;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header h1 {
        font-size: 1.8rem;
        font-weight: 600;
      }

      .header h1 i {
        color: #fbbf24;
        margin-right: 10px;
      }

      .badge-prototipo {
        background: #fbbf24;
        color: #0f172a;
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.85rem;
      }

      /* ===== HEADER COM USU√ÅRIO ===== */
      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 20px;
        border-radius: 50px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        background: #fbbf24;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0f172a;
        font-weight: 700;
      }

      .user-details {
        line-height: 1.4;
      }

      .user-name {
        font-weight: 600;
      }

      .user-role {
        font-size: 0.8rem;
        color: #cbd5e1;
      }

      .btn-logout {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-logout:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* ===== SELETOR DE PERFIL (MANTIDO PARA COMPATIBILIDADE) ===== */
      .perfil-selector {
        background: white;
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .perfil-label {
        font-weight: 600;
        color: #475569;
      }

      .perfil-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn-perfil {
        padding: 10px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        font-weight: 600;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-perfil.active {
        background: #2563eb;
        border-color: #2563eb;
        color: white;
      }

      .btn-perfil i {
        font-size: 1rem;
      }

      .carrinho-indicator {
        margin-left: auto;
        background: #fef3c7;
        padding: 10px 20px;
        border-radius: 50px;
        color: #92400e;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* ===== TABS PRINCIPAIS ===== */
      .tabs-principais {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-bottom: 30px;
        background: white;
        padding: 10px;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .tab-principal {
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .tab-principal.active {
        background: #2563eb;
        color: white;
      }

      .tab-principal:not(.active):hover {
        background: #f3f4f6;
      }

      .tab-principal i {
        font-size: 1rem;
      }

      /* ===== GEST√ÉO DE USU√ÅRIOS ===== */
      .usuarios-container {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .usuarios-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .btn-novo-usuario {
        background: #059669;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tabela-usuarios {
        width: 100%;
        border-collapse: collapse;
      }

      .tabela-usuarios th {
        background: #f8fafc;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
      }

      .tabela-usuarios td {
        padding: 15px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
      }

      .badge-perfil {
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
      }

      .perfil-admin {
        background: #fee2e2;
        color: #991b1b;
      }
      .perfil-secretario {
        background: #dcfce7;
        color: #166534;
      }
      .perfil-solicitante {
        background: #dbeafe;
        color: #1e40af;
      }
      .perfil-estagiario {
        background: #fef9c3;
        color: #854d0e;
      }

      .btn-editar,
      .btn-desativar {
        background: none;
        border: none;
        cursor: pointer;
        margin: 0 5px;
      }

      .btn-editar {
        color: #2563eb;
      }
      .btn-desativar {
        color: #dc2626;
      }

      /* ===== FILTROS ===== */
      .filtros-container {
        background: white;
        padding: 25px;
        border-radius: 16px;
        margin-bottom: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .filtros-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .filtro-grupo {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filtro-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filtro-input,
      .filtro-select {
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s;
      }

      .filtro-input:focus,
      .filtro-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      /* ===== LISTA DE ATAS ===== */
      .atas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .ata-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
        cursor: pointer;
      }

      .ata-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .ata-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .ata-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-ativa {
        background: #dcfce7;
        color: #166534;
      }

      .status-proxima {
        background: #fef9c3;
        color: #854d0e;
      }

      .status-vencida {
        background: #fee2e2;
        color: #991b1b;
      }

      .ata-numero {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 8px;
      }

      .ata-fornecedor {
        color: #475569;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .ata-vigencia {
        font-size: 0.8rem;
        color: #64748b;
      }

      .ata-footer {
        padding: 15px 20px;
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn-visualizar {
        background: #2563eb;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-visualizar:hover {
        background: #1d4ed8;
      }

      /* ===== MODAL ===== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        padding: 20px;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 1300px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
      }

      .modal-titulo {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0f172a;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
        padding: 10px;
      }

      /* ===== DETALHES DA ATA ===== */
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .info-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #0f172a;
      }

      /* ===== TABELA DE ITENS ===== */
      .tabela-container {
        overflow-x: auto;
        margin-bottom: 30px;
        width: 100%;
      }

      .tabela-itens {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .tabela-itens th {
        background: #f8fafc;
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
      }

      .tabela-itens td {
        padding: 15px 10px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
      }

      .tabela-itens tr:hover {
        background: #f8fafc;
      }

      .numeric {
        text-align: right;
      }

      .saldo-alto {
        color: #059669;
        font-weight: 600;
      }

      .saldo-baixo {
        color: #d97706;
        font-weight: 600;
      }

      .saldo-zerado {
        color: #dc2626;
        font-weight: 600;
      }

      .progresso-container {
        width: 100px;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progresso-bar {
        height: 100%;
        background: #2563eb;
        border-radius: 4px;
      }

      .consumo-autarquias {
        display: flex;
        gap: 20px;
        font-size: 0.8rem;
        color: #64748b;
      }

      .consumo-item {
        display: flex;
        flex-direction: column;
      }

      .consumo-label {
        font-weight: 600;
        color: #475569;
      }

      /* ===== LOTE TAG ===== */
      .lote-tag {
        background: #e0f2fe;
        color: #0369a1;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
      }

      /* ===== A√á√ïES POR PERFIL ===== */
      .acoes-item {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .btn-consumo,
      .btn-pedido {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-consumo {
        background: #d97706;
        color: white;
      }

      .btn-consumo:hover {
        background: #b45309;
      }

      .btn-pedido {
        background: #2563eb;
        color: white;
      }

      .btn-pedido:hover {
        background: #1d4ed8;
      }

      .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ===== CARRINHO ===== */
      .carrinho-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 450px;
        max-width: 90vw;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        overflow: hidden;
        display: none;
        z-index: 1001;
      }

      .carrinho-container.active {
        display: block;
      }

      .carrinho-header {
        background: #0f172a;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .carrinho-header h3 {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .carrinho-items {
        max-height: 400px;
        overflow-y: auto;
        padding: 20px;
      }

      .carrinho-footer {
        padding: 20px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
      }

      .btn-gerar-pedido {
        width: 100%;
        padding: 12px;
        background: #059669;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }

      /* ===== PEDIDO GERADO ===== */
      .pedido-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .pedido-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px dashed #2563eb;
      }

      .pedido-titulo {
        font-size: 1.3rem;
        font-weight: 700;
        color: #0f172a;
      }

      .pedido-subtitulo {
        color: #475569;
        margin-top: 5px;
      }

      .pedido-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .btn-pdf {
        background: #dc2626;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
      }

      .btn-pdf:hover {
        background: #b91c1c;
      }

      /* ===== VISUALIZADOR DE PDF ALTERNATIVO ===== */
      .pdf-visualizador {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .pdf-visualizador.active {
        display: flex;
      }

      .pdf-content {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        position: relative;
      }

      .pdf-pagina {
        background: white;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
        padding: 30px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      /* ===== FORMUL√ÅRIO DE CADASTRO ===== */
      .cadastro-container {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .cadastro-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
      }

      .cadastro-titulo {
        font-size: 1.3rem;
        font-weight: 700;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .btn-extracao {
        background: linear-gradient(135deg, #7e22ce, #6b21a8);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .btn-extracao:hover {
        background: linear-gradient(135deg, #6b21a8, #581c87);
        transform: translateY(-2px);
      }

      .btn-extracao i {
        font-size: 1.1rem;
      }

      .btn-extracao.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .cadastro-secao {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #e2e8f0;
      }

      .secao-titulo {
        font-size: 1rem;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 10px;
        border-bottom: 1px solid #cbd5e1;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-group label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      .form-group .input-icone {
        position: relative;
      }

      .form-group .input-icone i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
      }

      .form-group .input-icone input {
        padding-left: 35px;
      }

      .itens-cadastro-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .btn-adicionar-item {
        background: #059669;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .btn-adicionar-item:hover {
        background: #047857;
      }

      .tabela-itens-cadastro {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      .tabela-itens-cadastro th {
        background: #e2e8f0;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #334155;
      }

      .tabela-itens-cadastro td {
        padding: 12px;
        border-bottom: 1px solid #cbd5e1;
        vertical-align: middle;
      }

      .tabela-itens-cadastro input {
        width: 100%;
        padding: 6px;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
      }

      .btn-remover-item {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
        font-size: 1rem;
        padding: 5px;
      }

      .btn-remover-item:hover {
        color: #b91c1c;
      }

      .btn-salvar-ata {
        background: #2563eb;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        width: 100%;
        margin-top: 20px;
        transition: all 0.2s;
      }

      .btn-salvar-ata:hover {
        background: #1d4ed8;
      }

      .mensagem-sucesso {
        background: #d1fae5;
        color: #065f46;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #059669;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .mensagem-erro {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #dc2626;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* ===== GEST√ÉO DE ITENS - CORRIGIDO PARA OCUPAR 100% ===== */
      .gestao-container {
        width: 100%;
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .gestao-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .gestao-titulo {
        font-size: 1.2rem;
        font-weight: 700;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .gestao-filtros {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .gestao-select {
        min-width: 300px;
        padding: 10px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        background: white;
      }

      .gestao-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .gestao-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .gestao-stat-item {
        display: flex;
        flex-direction: column;
      }

      .gestao-stat-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.5px;
      }

      .gestao-stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #0f172a;
      }

      .gestao-tabela-wrapper {
        width: 100%;
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        margin-top: 20px;
      }

      .gestao-tabela {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      .gestao-tabela th {
        background: #f1f5f9;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #cbd5e1;
        white-space: nowrap;
      }

      .gestao-tabela td {
        padding: 16px 12px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
      }

      .gestao-tabela tr:last-child td {
        border-bottom: none;
      }

      .gestao-tabela tr:hover {
        background: #f8fafc;
      }

      .btn-lancar-rapido {
        background: #d97706;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .btn-lancar-rapido:hover {
        background: #b45309;
      }

      /* ===== MODAL DE USU√ÅRIO ===== */
      .modal-usuario .modal-content {
        max-width: 600px;
      }

      /* ===== RESPONSIVO ===== */
      @media (max-width: 768px) {
        .atas-grid {
          grid-template-columns: 1fr;
        }

        .perfil-selector {
          flex-direction: column;
          align-items: flex-start;
        }

        .tabs-principais {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .carrinho-indicator {
          margin-left: 0;
        }

        .gestao-filtros {
          flex-direction: column;
          width: 100%;
        }

        .gestao-select {
          width: 100%;
        }

        .user-info {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- ===== TELA DE LOGIN ===== -->
    <div id="loginScreen" class="login-container">
      <div class="login-header">
        <i class="fas fa-file-contract"></i>
        <h1>Gest√£o de Atas</h1>
        <p style="color: #64748b; margin-top: 5px">
          Fa√ßa login para acessar o sistema
        </p>
      </div>

      <div class="login-form">
        <div class="form-group">
          <label>E-mail</label>
          <select id="loginEmail" class="filtro-select">
            <option value="admin@pitangueiras.pr.gov.br">üëë Administrador</option>
            <option value="secretario@pitangueiras.pr.gov.br">üìã Secret√°rio</option>
            <option value="solicitante@pitangueiras.pr.gov.br">üìù Solicitante</option>
            <option value="estagiario@pitangueiras.pr.gov.br">üîß Estagi√°rio</option>
          </select>
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input
            type="password"
            id="loginSenha"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            value="123456"
          />
        </div>
        <button class="btn-login" onclick="sistema.fazerLogin()">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
        <div id="loginError" class="login-error"></div>

        <div class="login-info">
          <strong><i class="fas fa-info-circle"></i> Contas para teste:</strong
          ><br />
          ‚Ä¢ admin@pitangueiras.pr.gov.br (ADMIN) - Senha: 123456<br />
          ‚Ä¢ secretario@pitangueiras.pr.gov.br (SECRET√ÅRIO) - Senha: 123456<br />
          ‚Ä¢ solicitante@pitangueiras.pr.gov.br (SOLICITANTE) - Senha: 123456<br />
          ‚Ä¢ estagiario@pitangueiras.pr.gov.br (ESTAGI√ÅRIO) - Senha: 123456
        </div>
      </div>
    </div>

    <!-- ===== SISTEMA PRINCIPAL ===== -->
    <div id="mainSystem" class="app" style="display: none">
      <!-- ===== HEADER COM USU√ÅRIO ===== -->
      <header class="header">
        <div>
          <h1>
            <i class="fas fa-file-contract"></i> Gest√£o de Atas de Registro de
            Pre√ßos
          </h1>
          <p style="color: #cbd5e1; margin-top: 5px">
            Sistema com controle de LOTE e gera√ß√£o de PDF
          </p>
        </div>
        <div style="display: flex; align-items: center; gap: 15px">
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">SC</div>
            <div class="user-details">
              <div class="user-name" id="userName">Carregando...</div>
              <div class="user-role" id="userRole">...</div>
            </div>
          </div>
          <button class="btn-logout" onclick="sistema.fazerLogout()">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>
      </header>

      <!-- ===== SELETOR DE PERFIL (MANTIDO PARA COMPATIBILIDADE) ===== -->
      <div class="perfil-selector">
        <span class="perfil-label"
          ><i class="fas fa-user-tag"></i> Simular perfil (apenas para
          teste):</span
        >
        <div class="perfil-buttons">
          <button
            class="btn-perfil"
            onclick="sistema.alternarPerfil('admin', event)"
          >
            <i class="fas fa-user-cog"></i> Administrador
          </button>
          <button
            class="btn-perfil"
            onclick="sistema.alternarPerfil('secretario', event)"
          >
            <i class="fas fa-user-tie"></i> Secret√°rio
          </button>
          <button
            class="btn-perfil"
            onclick="sistema.alternarPerfil('solicitante', event)"
          >
            <i class="fas fa-user"></i> Solicitante
          </button>
          <button
            class="btn-perfil"
            onclick="sistema.alternarPerfil('estagiario', event)"
          >
            <i class="fas fa-user-graduate"></i> Estagi√°rio
          </button>
        </div>
        <div
          id="carrinhoIndicator"
          class="carrinho-indicator"
          style="display: none"
        >
          <i class="fas fa-shopping-cart"></i>
          <span id="carrinhoCount">0</span> itens no carrinho
          <button
            onclick="sistema.abrirCarrinho()"
            style="
              margin-left: 10px;
              background: none;
              border: none;
              color: #92400e;
              cursor: pointer;
            "
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- ===== TABS PRINCIPAIS ===== -->
      <div class="tabs-principais" id="mainTabs">
        <div
          id="tabConsulta"
          class="tab-principal active"
          onclick="sistema.ativarTab('consulta')"
        >
          <i class="fas fa-search"></i> Consulta de Atas
        </div>
        <div
          id="tabGestao"
          class="tab-principal"
          onclick="sistema.ativarTab('gestao')"
        >
          <i class="fas fa-boxes"></i> Gest√£o de Itens
        </div>
        <div
          id="tabCadastro"
          class="tab-principal"
          onclick="sistema.ativarTab('cadastro')"
        >
          <i class="fas fa-plus-circle"></i> Cadastrar Ata
        </div>
        <div
          id="tabPedidos"
          class="tab-principal"
          onclick="sistema.ativarTab('pedidos')"
        >
          <i class="fas fa-file-invoice"></i> Pedidos Gerados
        </div>
        <div
          id="tabUsuarios"
          class="tab-principal"
          style="display: none"
          onclick="sistema.ativarTab('usuarios')"
        >
          <i class="fas fa-users-cog"></i> Usu√°rios
        </div>
      </div>

      <!-- ===== CONTE√öDO CONSULTA ===== -->
      <div id="consultaContent">
        <!-- FILTROS -->
        <div class="filtros-container">
          <div class="filtros-grid">
            <div class="filtro-grupo">
              <label class="filtro-label"
                ><i class="fas fa-search"></i> Buscar</label
              >
              <input
                type="text"
                id="buscaInput"
                class="filtro-input"
                placeholder="Buscar por descri√ß√£o do item..."
                onkeyup="sistema.filtrarAtas()"
              />
            </div>
            <div class="filtro-grupo">
              <label class="filtro-label"
                ><i class="fas fa-building"></i> Fornecedor</label
              >
              <select
                id="filtroFornecedor"
                class="filtro-select"
                onchange="sistema.filtrarAtas()"
              >
                <option value="todos">Todos os fornecedores</option>
              </select>
            </div>
            <div class="filtro-grupo">
              <label class="filtro-label"
                ><i class="fas fa-university"></i> Autarquia</label
              >
              <select
                id="filtroAutarquia"
                class="filtro-select"
                onchange="sistema.filtrarAtas()"
              >
                <option value="todos">Todas as autarquias</option>
                <option value="Prefeitura">Prefeitura</option>
                <option value="C√¢mara">C√¢mara</option>
                <option value="SAAE">SAAE</option>
              </select>
            </div>
            <div class="filtro-grupo">
              <label class="filtro-label"
                ><i class="fas fa-tag"></i> Status</label
              >
              <select
                id="filtroStatus"
                class="filtro-select"
                onchange="sistema.filtrarAtas()"
              >
                <option value="todos">Todos</option>
                <option value="ATIVA">Ativa</option>
                <option value="PROXIMA">Pr√≥xima do vencimento</option>
                <option value="VENCIDA">Vencida</option>
              </select>
            </div>
          </div>
        </div>

        <!-- LISTA DE ATAS -->
        <div id="atasLista" class="atas-grid"></div>
      </div>

      <!-- ===== CONTE√öDO GEST√ÉO ===== -->
      <div id="gestaoContent" style="display: none">
        <div class="gestao-container">
          <!-- HEADER DA GEST√ÉO -->
          <div class="gestao-header">
            <div class="gestao-titulo">
              <i class="fas fa-boxes"></i> Gest√£o de Itens - Lan√ßamento R√°pido
            </div>
            <div class="gestao-filtros">
              <select
                id="selectAtaGestao"
                class="gestao-select"
                onchange="sistema.carregarItensGestao()"
              >
                <option value="">üîç Selecione uma ata...</option>
              </select>
              <select
                id="filtroStatusGestao"
                class="gestao-select"
                onchange="sistema.filtrarItensGestao()"
              >
                <option value="todos">üì¶ Todos os itens</option>
                <option value="disponivel">‚úÖ Apenas com saldo</option>
                <option value="critico">‚ö†Ô∏è Saldo cr√≠tico (&lt;10%)</option>
                <option value="esgotado">‚ùå Esgotados</option>
              </select>
            </div>
          </div>

          <!-- STATS R√ÅPIDOS -->
          <div id="gestaoStats" class="gestao-stats">
            <div class="gestao-stat-item">
              <span class="gestao-stat-label">Ata selecionada</span>
              <span id="gestaoAtaNome" class="gestao-stat-value">Nenhuma</span>
            </div>
            <div class="gestao-stat-item">
              <span class="gestao-stat-label">Total de itens</span>
              <span id="gestaoTotalItens" class="gestao-stat-value">0</span>
            </div>
            <div class="gestao-stat-item">
              <span class="gestao-stat-label">Itens com saldo</span>
              <span id="gestaoItensComSaldo" class="gestao-stat-value">0</span>
            </div>
            <div class="gestao-stat-item">
              <span class="gestao-stat-label">Itens cr√≠ticos</span>
              <span id="gestaoItensCriticos" class="gestao-stat-value">0</span>
            </div>
          </div>

          <!-- TABELA DE ITENS - OCUPANDO 100% -->
          <div id="itensGestaoContainer" class="gestao-tabela-wrapper">
            <!-- Conte√∫do ser√° inserido via JavaScript -->
          </div>
        </div>
      </div>

      <!-- ===== CONTE√öDO CADASTRO ===== -->
      <div id="cadastroContent" style="display: none">
        <div class="cadastro-container">
          <div class="cadastro-header">
            <div class="cadastro-titulo">
              <i class="fas fa-file-signature"></i> Cadastro de Nova Ata
            </div>
            <button
              id="btnExtracao"
              class="btn-extracao"
              onclick="sistema.executarExtracaoPDF()"
            >
              <i class="fas fa-file-pdf"></i> Extrair dados do PDF
            </button>
          </div>

          <div id="mensagemCadastro"></div>

          <form
            id="formCadastroAta"
            onsubmit="event.preventDefault(); sistema.salvarAta();"
          >
            <!-- DADOS DO PROCESSO -->
            <div class="cadastro-secao">
              <div class="secao-titulo">
                <i class="fas fa-gavel"></i> Dados do Processo
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>N¬∫ Processo Administrativo</label>
                  <div class="input-icone">
                    <i class="fas fa-hashtag"></i>
                    <input
                      type="text"
                      id="processoNumero"
                      placeholder="Ex: 40/2025"
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label>N¬∫ Preg√£o</label>
                  <div class="input-icone">
                    <i class="fas fa-tag"></i>
                    <input
                      type="text"
                      id="pregaoNumero"
                      placeholder="Ex: 19/2025"
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label>N¬∫ Ata de Registro de Pre√ßos</label>
                  <div class="input-icone">
                    <i class="fas fa-file-contract"></i>
                    <input
                      type="text"
                      id="ataNumero"
                      placeholder="Ex: 59/2025"
                    />
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Data da Assinatura</label>
                  <div class="input-icone">
                    <i class="fas fa-calendar"></i>
                    <input type="date" id="dataAssinatura" />
                  </div>
                </div>
                <div class="form-group">
                  <label>Data de In√≠cio da Vig√™ncia</label>
                  <div class="input-icone">
                    <i class="fas fa-calendar-check"></i>
                    <input type="date" id="vigenciaInicio" />
                  </div>
                </div>
                <div class="form-group">
                  <label>Data de Fim da Vig√™ncia</label>
                  <div class="input-icone">
                    <i class="fas fa-calendar-times"></i>
                    <input type="date" id="vigenciaFim" />
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Objeto da Licita√ß√£o</label>
                  <textarea
                    id="objeto"
                    rows="3"
                    placeholder="Descreva o objeto da licita√ß√£o..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- DADOS DO MUNIC√çPIO/√ìRG√ÉO GESTOR -->
            <div class="cadastro-secao">
              <div class="secao-titulo">
                <i class="fas fa-city"></i> Dados do √ìrg√£o Gestor
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Munic√≠pio</label>
                  <input
                    type="text"
                    id="municipio"
                    placeholder="Ex: Pitangueiras"
                  />
                </div>
                <div class="form-group">
                  <label>UF</label>
                  <select id="uf">
                    <option value="">Selecione</option>
                    <option value="PR">PR</option>
                    <option value="SP">SP</option>
                    <option value="SC">SC</option>
                    <option value="RS">RS</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>CNPJ do Munic√≠pio</label>
                  <input
                    type="text"
                    id="municipioCnpj"
                    placeholder="00.000.000/0001-00"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Nome do Prefeito</label>
                  <input
                    type="text"
                    id="prefeitoNome"
                    placeholder="Nome completo"
                  />
                </div>
                <div class="form-group">
                  <label>RG do Prefeito</label>
                  <input
                    type="text"
                    id="prefeitoRg"
                    placeholder="Ex: 0.000.000-0"
                  />
                </div>
                <div class="form-group">
                  <label>CPF do Prefeito</label>
                  <input
                    type="text"
                    id="prefeitoCpf"
                    placeholder="000.000.000-00"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Endere√ßo da Prefeitura</label>
                  <input
                    type="text"
                    id="municipioEndereco"
                    placeholder="Rua, n√∫mero, bairro"
                  />
                </div>
                <div class="form-group">
                  <label>Telefone</label>
                  <input
                    type="text"
                    id="municipioTelefone"
                    placeholder="(00) 0000-0000"
                  />
                </div>
                <div class="form-group">
                  <label>E-mail</label>
                  <input
                    type="email"
                    id="municipioEmail"
                    placeholder="contato@municipio.gov.br"
                  />
                </div>
              </div>
            </div>

            <!-- DADOS DO FORNECEDOR -->
            <div class="cadastro-secao">
              <div class="secao-titulo">
                <i class="fas fa-building"></i> Dados do Fornecedor
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Raz√£o Social</label>
                  <input
                    type="text"
                    id="fornecedorRazao"
                    placeholder="Raz√£o social completa"
                  />
                </div>
                <div class="form-group">
                  <label>CNPJ</label>
                  <input
                    type="text"
                    id="fornecedorCnpj"
                    placeholder="00.000.000/0001-00"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Endere√ßo</label>
                  <input
                    type="text"
                    id="fornecedorEndereco"
                    placeholder="Rua, n√∫mero"
                  />
                </div>
                <div class="form-group">
                  <label>Bairro</label>
                  <input
                    type="text"
                    id="fornecedorBairro"
                    placeholder="Bairro"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Cidade</label>
                  <input
                    type="text"
                    id="fornecedorCidade"
                    placeholder="Cidade"
                  />
                </div>
                <div class="form-group">
                  <label>UF</label>
                  <select id="fornecedorUf">
                    <option value="">Selecione</option>
                    <option value="PR">PR</option>
                    <option value="SP">SP</option>
                    <option value="SC">SC</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>CEP</label>
                  <input
                    type="text"
                    id="fornecedorCep"
                    placeholder="00000-000"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Telefone</label>
                  <input
                    type="text"
                    id="fornecedorTelefone"
                    placeholder="(00) 0000-0000"
                  />
                </div>
                <div class="form-group">
                  <label>Whatsapp</label>
                  <input
                    type="text"
                    id="fornecedorWhatsapp"
                    placeholder="(00) 00000-0000"
                  />
                </div>
                <div class="form-group">
                  <label>E-mail</label>
                  <input
                    type="email"
                    id="fornecedorEmail"
                    placeholder="contato@fornecedor.com.br"
                  />
                </div>
              </div>
            </div>

            <!-- DADOS DO REPRESENTANTE -->
            <div class="cadastro-secao">
              <div class="secao-titulo">
                <i class="fas fa-user-tie"></i> Representante do Fornecedor
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Nome do Representante</label>
                  <input
                    type="text"
                    id="representanteNome"
                    placeholder="Nome completo"
                  />
                </div>
                <div class="form-group">
                  <label>RG</label>
                  <input
                    type="text"
                    id="representanteRg"
                    placeholder="0.000.000-0"
                  />
                </div>
                <div class="form-group">
                  <label>CPF</label>
                  <input
                    type="text"
                    id="representanteCpf"
                    placeholder="000.000.000-00"
                  />
                </div>
              </div>
            </div>

            <!-- ITENS DA ATA -->
            <div class="cadastro-secao">
              <div class="secao-titulo">
                <i class="fas fa-boxes"></i> Itens da Ata
              </div>

              <div class="itens-cadastro-header">
                <span style="color: #475569"
                  >Total de itens: <span id="totalItensCadastro">0</span></span
                >
                <button
                  type="button"
                  class="btn-adicionar-item"
                  onclick="sistema.adicionarItemCadastro()"
                >
                  <i class="fas fa-plus"></i> Adicionar Item
                </button>
              </div>

              <div class="tabela-container">
                <table class="tabela-itens-cadastro" id="tabelaItensCadastro">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Descri√ß√£o</th>
                      <th>Qtd Pref</th>
                      <th>Qtd SAAE</th>
                      <th>Qtd C√¢mara</th>
                      <th>Qtd Total</th>
                      <th>Valor Unit.</th>
                      <th>Valor Total</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="itensCadastroBody"></tbody>
                  <tfoot>
                    <tr style="background: #f8fafc; font-weight: 700">
                      <td colspan="7" style="text-align: right">
                        VALOR TOTAL DA ATA:
                      </td>
                      <td
                        id="valorTotalAta"
                        style="text-align: right; color: #059669"
                      >
                        R$ 0,00
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <button type="submit" class="btn-salvar-ata">
              <i class="fas fa-save"></i> Salvar Ata
            </button>
          </form>
        </div>
      </div>

      <!-- ===== CONTE√öDO PEDIDOS ===== -->
      <div id="pedidosContent" style="display: none">
        <div id="pedidosLista" class="atas-grid"></div>
      </div>

      <!-- ===== CONTE√öDO USU√ÅRIOS ===== -->
      <div id="usuariosContent" style="display: none">
        <div class="usuarios-container">
          <div class="usuarios-header">
            <h3>
              <i class="fas fa-users-cog"></i> Gest√£o de Usu√°rios e Permiss√µes
            </h3>
            <button
              class="btn-novo-usuario"
              onclick="sistema.abrirModalUsuario()"
            >
              <i class="fas fa-user-plus"></i> Novo Usu√°rio
            </button>
          </div>

          <table class="tabela-usuarios">
            <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>√ìrg√£o</th>
                <th>Perfil</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaUsuariosBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ===== MODAIS ===== -->
      <div id="modalDetalhes" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-titulo" id="modalTituloAta"></h2>
            <button class="modal-close" onclick="sistema.fecharModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="modalConteudo"></div>
        </div>
      </div>

      <div id="modalConsumo" class="modal">
        <div class="modal-content" style="max-width: 500px">
          <div class="modal-header">
            <h2 class="modal-titulo">
              <i class="fas fa-pen"></i> Lan√ßar Consumo
            </h2>
            <button class="modal-close" onclick="sistema.fecharModalConsumo()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="modalConsumoConteudo"></div>
        </div>
      </div>

      <div id="modalCarrinho" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-titulo">
              <i class="fas fa-shopping-cart"></i> Carrinho de Pedidos
            </h2>
            <button class="modal-close" onclick="sistema.fecharModalCarrinho()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="modalCarrinhoConteudo"></div>
        </div>
      </div>

      <div id="modalPedido" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-titulo">
              <i class="fas fa-file-invoice"></i> Pedido de Compra Gerado
            </h2>
            <button class="modal-close" onclick="sistema.fecharModalPedido()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="modalPedidoConteudo"></div>
        </div>
      </div>

      <!-- ===== MODAL DE USU√ÅRIO ===== -->
      <div id="modalUsuario" class="modal modal-usuario">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-titulo" id="modalUsuarioTitulo">
              <i class="fas fa-user-plus"></i> Novo Usu√°rio
            </h2>
            <button class="modal-close" onclick="sistema.fecharModalUsuario()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <form
            id="formUsuario"
            onsubmit="event.preventDefault(); sistema.salvarUsuario();"
          >
            <input type="hidden" id="usuarioId" />

            <div class="form-group" style="margin-bottom: 15px">
              <label>Nome Completo</label>
              <input
                type="text"
                id="usuarioNome"
                class="filtro-input"
                style="width: 100%"
                required
              />
            </div>

            <div class="form-group" style="margin-bottom: 15px">
              <label>E-mail</label>
              <input
                type="email"
                id="usuarioEmail"
                class="filtro-input"
                style="width: 100%"
                required
              />
            </div>

            <div class="form-group" style="margin-bottom: 15px">
              <label>Senha</label>
              <input
                type="password"
                id="usuarioSenha"
                class="filtro-input"
                style="width: 100%"
                placeholder="M√≠nimo 6 caracteres"
                required
              />
            </div>

            <div class="form-group" style="margin-bottom: 15px">
              <label>√ìrg√£o / Secretaria</label>
              <select
                id="usuarioOrgao"
                class="filtro-select"
                style="width: 100%"
              >
                <option value="1">Prefeitura Municipal</option>
                <option value="2">C√¢mara Municipal</option>
                <option value="3">SAAE</option>
                <option value="4">Secretaria de Educa√ß√£o</option>
                <option value="5">Secretaria de Sa√∫de</option>
                <option value="6">Secretaria de Administra√ß√£o</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 15px">
              <label>Perfil de Acesso</label>
              <select
                id="usuarioPerfil"
                class="filtro-select"
                style="width: 100%"
              >
                <option value="ADMIN">Administrador</option>
                <option value="SECRETARIO">Secret√°rio</option>
                <option value="SOLICITANTE">Solicitante (Faz Pedidos)</option>
                <option value="ESTAGIARIO">Estagi√°rio</option>
              </select>
            </div>

            <div
              style="
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                margin-top: 25px;
              "
            >
              <button
                type="button"
                class="btn"
                style="background: #e2e8f0; padding: 10px 20px"
                onclick="sistema.fecharModalUsuario()"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="btn"
                style="background: #2563eb; color: white; padding: 10px 20px"
              >
                <i class="fas fa-save"></i> Salvar Usu√°rio
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="pdfVisualizador" class="pdf-visualizador">
        <div class="pdf-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="color: #0f172a">
              <i class="fas fa-file-pdf"></i> Visualiza√ß√£o do Pedido
            </h2>
            <button
              onclick="sistema.fecharPdfVisualizador()"
              style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #64748b;
              "
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="pdfConteudo"></div>
          <div
            style="
              display: flex;
              gap: 10px;
              justify-content: flex-end;
              margin-top: 20px;
            "
          >
            <button
              class="btn"
              onclick="sistema.fecharPdfVisualizador()"
              style="background: #e2e8f0"
            >
              Fechar
            </button>
            <button
              class="btn-pdf"
              onclick="sistema.baixarPDF()"
              style="margin-top: 0"
            >
              <i class="fas fa-download"></i> Baixar PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // =========================================
      // SUPABASE CLIENT - CONFIGURA√á√ÉO REAL
      // =========================================
      const SUPABASE_URL = 'https://qgkjnzcqjhhqdgxmvtew.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_gbXPIpkbYvf3YKITplkjpg_eKrPHhYw';
      
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // =========================================
      // SISTEMA PRINCIPAL - CORRIGIDO COM SUPABASE
      // =========================================
      class SistemaGestaoAtas {
        constructor() {
          this.usuarioAtual = null;
          this.perfilAtual = "secretario"; // Mantido para compatibilidade
          this.ataSelecionada = null;
          this.itemSelecionado = null;
          this.carrinho = [];
          this.pedidosGerados = [];
          this.pdfData = null;
          this.atas = [];
          this.usuarios = [];
          
          this.init();
        }

        async init() {
          // Verificar sess√£o ativa
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session) {
            await this.carregarUsuario(session.user.id);
          }
        }

        // ===== LOGIN/LOGOUT REAL COM SUPABASE =====
        async fazerLogin() {
          const errorDiv = document.getElementById('loginError');
          errorDiv.style.display = 'none';
          
          const email = document.getElementById('loginEmail').value;
          const senha = document.getElementById('loginSenha').value;

          try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
              email: email,
              password: senha
            });

            if (error) throw error;

            await this.carregarUsuario(data.user.id);

          } catch (error) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = '‚ùå ' + error.message;
          }
        }

        async carregarUsuario(uuid) {
          const { data: usuario, error } = await supabaseClient
            .from('usuarios')
            .select('*, orgao:orgaos(*)')
            .eq('uuid', uuid)
            .single();

          if (error || !usuario) {
            console.error('Usu√°rio n√£o encontrado');
            return;
          }

          this.usuarioAtual = usuario;
          this.perfilAtual = usuario.perfil.toLowerCase();

          // Atualizar header
          document.getElementById('userName').innerHTML = usuario.nome;
          document.getElementById('userRole').innerHTML = usuario.perfil;

          // Avatar
          const iniciais = usuario.nome
            .split(' ')
            .map(n => n[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
          document.getElementById('userAvatar').innerHTML = iniciais;

          // Esconder login, mostrar sistema
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainSystem').style.display = 'block';

          // Inicializar sistema
          await this.carregarFiltros();
          await this.carregarAtas();
          await this.carregarSelectsGestao();
          await this.carregarTabelaUsuarios();
          await this.carregarPedidos();
          this.configurarPermissoes();
          this.ativarTab('consulta');
        }

        async fazerLogout() {
          await supabaseClient.auth.signOut();
          this.usuarioAtual = null;
          this.perfilAtual = "secretario";
          document.getElementById('loginScreen').style.display = 'block';
          document.getElementById('mainSystem').style.display = 'none';
        }

        // ===== CONFIGURA√á√ÉO DE PERMISS√ïES =====
        configurarPermissoes() {
          const perfil = this.usuarioAtual?.perfil;

          // Esconder todas as abas especiais primeiro
          document.getElementById('tabUsuarios').style.display = 'none';
          document.getElementById('tabGestao').style.display = 'none';
          document.getElementById('tabCadastro').style.display = 'none';
          document.getElementById('tabPedidos').style.display = 'block';
          document.getElementById('tabConsulta').style.display = 'block';

          // Configurar permiss√µes por perfil
          switch (perfil) {
            case 'ADMIN':
              document.getElementById('tabUsuarios').style.display = 'block';
              document.getElementById('tabGestao').style.display = 'block';
              document.getElementById('tabCadastro').style.display = 'block';
              break;

            case 'SECRETARIO':
            case 'SOLICITANTE':
              // J√° est√£o configurados
              break;

            case 'ESTAGIARIO':
              document.getElementById('tabGestao').style.display = 'block';
              document.getElementById('tabCadastro').style.display = 'block';
              document.getElementById('tabPedidos').style.display = 'none';
              break;
          }

          // Garantir que as tabs principais est√£o todas vis√≠veis
          const tabsPrincipais = document.querySelectorAll(
            ".tabs-principais .tab-principal"
          );
          tabsPrincipais.forEach((tab) => {
            if (tab.id !== "tabUsuarios") {
              // N√£o mexe na visibilidade aqui
            }
          });
        }

        // ===== TABS =====
        ativarTab(tab) {
          // Verificar permiss√µes baseado no perfil
          if (
            tab === "cadastro" &&
            this.usuarioAtual?.perfil !== "ADMIN" &&
            this.usuarioAtual?.perfil !== "ESTAGIARIO"
          ) {
            alert(
              "Acesso negado! Apenas Administradores e Estagi√°rios podem cadastrar atas."
            );
            return;
          }

          if (
            tab === "gestao" &&
            this.usuarioAtual?.perfil !== "ADMIN" &&
            this.usuarioAtual?.perfil !== "ESTAGIARIO"
          ) {
            alert(
              "Acesso negado! Apenas Administradores e Estagi√°rios podem acessar a Gest√£o de Itens."
            );
            return;
          }

          if (tab === "usuarios" && this.usuarioAtual?.perfil !== "ADMIN") {
            alert(
              "Acesso negado! Apenas Administradores podem gerenciar usu√°rios."
            );
            return;
          }

          document.querySelectorAll(".tab-principal").forEach((t) => {
            t.classList.remove("active");
          });
          document
            .getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`)
            .classList.add("active");

          document.getElementById("consultaContent").style.display =
            tab === "consulta" ? "block" : "none";
          document.getElementById("gestaoContent").style.display =
            tab === "gestao" ? "block" : "none";
          document.getElementById("cadastroContent").style.display =
            tab === "cadastro" ? "block" : "none";
          document.getElementById("pedidosContent").style.display =
            tab === "pedidos" ? "block" : "none";
          document.getElementById("usuariosContent").style.display =
            tab === "usuarios" ? "block" : "none";

          if (tab === "consulta") this.carregarAtas();
          if (tab === "gestao") this.carregarSelectsGestao();
          if (tab === "pedidos") this.carregarPedidos();
          if (tab === "usuarios") this.carregarTabelaUsuarios();
        }

        // ===== CARREGAMENTO DE DADOS REAIS =====
        async carregarFiltros() {
          const fornecedorSelect = document.getElementById("filtroFornecedor");
          if (!fornecedorSelect) return;
          
          fornecedorSelect.innerHTML =
            '<option value="todos">Todos os fornecedores</option>';

          const { data: fornecedores } = await supabaseClient
            .from('fornecedores')
            .select('razao_social')
            .order('razao_social');

          fornecedores?.forEach((fornecedor) => {
            const option = document.createElement("option");
            option.value = fornecedor.razao_social;
            option.textContent = fornecedor.razao_social;
            fornecedorSelect.appendChild(option);
          });
        }

        async carregarAtas() {
          const container = document.getElementById("atasLista");
          container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Carregando atas...</div>';
          
          const busca =
            document.getElementById("buscaInput")?.value?.toLowerCase() || "";
          const fornecedorFiltro =
            document.getElementById("filtroFornecedor")?.value || "todos";
          const autarquiaFiltro =
            document.getElementById("filtroAutarquia")?.value || "todos";
          const statusFiltro =
            document.getElementById("filtroStatus")?.value || "todos";

          let query = supabaseClient
            .from('atas')
            .select(`
              *,
              fornecedor:fornecedores(razao_social),
              itens:itens_ata(*)
            `);

          if (statusFiltro !== 'todos') {
            query = query.eq('situacao', statusFiltro);
          }

          const { data: atas } = await query.order('data_inicio_vigencia', { ascending: false });

          let atasFiltradas = atas || [];

          if (fornecedorFiltro !== 'todos') {
            atasFiltradas = atasFiltradas.filter((ata) =>
              ata.fornecedor?.razao_social === fornecedorFiltro
            );
          }

          if (busca) {
            atasFiltradas = atasFiltradas.filter((ata) =>
              ata.itens?.some((item) =>
                item.descricao?.toLowerCase().includes(busca)
              )
            );
          }

          if (autarquiaFiltro !== 'todos') {
            // Este filtro ser√° implementado com consumos
          }

          if (atasFiltradas.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px;">Nenhuma ata encontrada</div>';
            return;
          }

          container.innerHTML = atasFiltradas
            .map((ata) => this.renderCardAta(ata))
            .join("");
        }

        renderCardAta(ata) {
          const totalItens = ata.itens?.length || 0;
          const valorTotal = ata.valor_global || 0;
          
          const statusMap = {
            'ATIVA': 'status-ativa',
            'PROXIMA': 'status-proxima',
            'VENCIDA': 'status-vencida'
          };

          return `
            <div class="ata-card" onclick="sistema.abrirDetalhes(${ata.id})">
              <div class="ata-header">
                <div class="ata-status">
                  <span class="status-badge ${statusMap[ata.situacao] || 'status-ativa'}">
                    ${ata.situacao || 'ATIVA'}
                  </span>
                  <span style="font-size: 0.8rem; color: #64748b;">
                    <i class="fas fa-box"></i> ${totalItens} itens
                  </span>
                </div>
                <div class="ata-numero">Ata n¬∫ ${ata.numero_ata || ''}</div>
                <div class="ata-fornecedor">
                  <i class="fas fa-building"></i> ${ata.fornecedor?.razao_social || 'Fornecedor n√£o informado'}
                </div>
                <div class="ata-vigencia">
                  <i class="fas fa-calendar"></i> Vig√™ncia: ${this.formatarData(ata.data_inicio_vigencia)} at√© ${this.formatarData(ata.data_fim_vigencia)}
                </div>
              </div>
              <div class="ata-footer">
                <span style="font-weight: 600; color: #0f172a;">
                  ${this.formatarMoeda(valorTotal)}
                </span>
                <button class="btn-visualizar" onclick="event.stopPropagation(); sistema.abrirDetalhes(${ata.id})">
                  <i class="fas fa-eye"></i> Visualizar
                </button>
              </div>
            </div>
          `;
        }

        // ===== DETALHES DA ATA =====
        async abrirDetalhes(ataId) {
          const { data: ata } = await supabaseClient
            .from('atas')
            .select(`
              *,
              fornecedor:fornecedores(*),
              itens:itens_ata(*)
            `)
            .eq('id', ataId)
            .single();

          this.ataSelecionada = ata;

          document.getElementById("modalTituloAta").innerHTML = `
            <i class="fas fa-file-contract"></i> Ata n¬∫ ${ata.numero_ata}
          `;

          document.getElementById("modalConteudo").innerHTML =
            await this.renderDetalhesAta(ata);

          document.getElementById("modalDetalhes").classList.add("active");
        }

        async renderDetalhesAta(ata) {
          const { data: consumos } = await supabaseClient
            .from('consumos')
            .select('*, orgao:orgaos(*)')
            .eq('ata_id', ata.id);

          const consumosPorItem = {};
          consumos?.forEach(c => {
            if (!consumosPorItem[c.item_ata_id]) consumosPorItem[c.item_ata_id] = [];
            consumosPorItem[c.item_ata_id].push(c);
          });

          const valorTotal = ata.valor_global || 0;
          const podeConsumir =
            this.usuarioAtual?.perfil === "ADMIN" ||
            this.usuarioAtual?.perfil === "ESTAGIARIO";
          const podePedir =
            this.usuarioAtual?.perfil === "SECRETARIO" ||
            this.usuarioAtual?.perfil === "SOLICITANTE";

          return `
            <!-- DADOS GERAIS -->
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Fornecedor</span>
                <span class="info-value">${ata.fornecedor?.razao_social || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">CNPJ</span>
                <span class="info-value">${ata.fornecedor?.cnpj || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Processo</span>
                <span class="info-value">${ata.processo_administrativo || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Vig√™ncia</span>
                <span class="info-value">${this.formatarData(ata.data_inicio_vigencia)} at√© ${this.formatarData(ata.data_fim_vigencia)}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Status</span>
                <span class="status-badge ${ata.situacao === 'ATIVA' ? 'status-ativa' : ata.situacao === 'PROXIMA' ? 'status-proxima' : 'status-vencida'}" style="display: inline-block; width: fit-content;">
                  ${ata.situacao || 'ATIVA'}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Valor Total</span>
                <span class="info-value">${this.formatarMoeda(valorTotal)}</span>
              </div>
            </div>

            <!-- LISTA DE ITENS -->
            <h3 style="margin-bottom: 15px;"><i class="fas fa-boxes"></i> Itens da Ata</h3>

            <div class="tabela-container">
              <table class="tabela-itens">
                <thead>
                  <tr>
                    <th>N¬∫ Item</th>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th>Lote</th>
                    <th class="numeric">Qtd Registrada</th>
                    <th class="numeric">Valor Unit.</th>
                    <th class="numeric">Valor Total</th>
                    <th class="numeric">Qtd Consumida</th>
                    <th class="numeric">Saldo</th>
                    <th>Progresso</th>
                    <th>Consumo por Autarquia</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  ${ata.itens.map(item => this.renderItemAta(ata, item, consumosPorItem[item.id] || [])).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

        renderItemAta(ata, item, consumosItem) {
          const qtdConsumida = consumosItem.reduce((sum, c) => sum + c.quantidade, 0);
          const saldo = item.saldo_quantidade || 0;
          const percentual = item.quantidade_contratada > 0 
            ? ((item.quantidade_contratada - saldo) / item.quantidade_contratada * 100).toFixed(1) 
            : 0;
          const lote = item.lote_numero || this.gerarLote(ata.numero_ata, item.item_numero);

          // Consumo por autarquia
          const consumoPrefeitura = consumosItem.filter(c => c.orgao_solicitante_id === 1).reduce((sum, c) => sum + c.quantidade, 0);
          const consumoCamara = consumosItem.filter(c => c.orgao_solicitante_id === 2).reduce((sum, c) => sum + c.quantidade, 0);
          const consumoSAAE = consumosItem.filter(c => c.orgao_solicitante_id === 3).reduce((sum, c) => sum + c.quantidade, 0);

          let saldoClass = 'saldo-alto';
          if (saldo <= 0) saldoClass = 'saldo-zerado';
          else if (saldo <= item.quantidade_contratada * 0.1) saldoClass = 'saldo-baixo';

          const podeConsumir =
            this.usuarioAtual?.perfil === "ADMIN" ||
            this.usuarioAtual?.perfil === "ESTAGIARIO";
          const podePedir =
            this.usuarioAtual?.perfil === "SECRETARIO" ||
            this.usuarioAtual?.perfil === "SOLICITANTE";

          return `
            <tr>
              <td class="numeric">${item.item_numero || ''}</td>
              <td style="max-width: 250px;">${item.descricao || ''}</td>
              <td>${item.categoria || 'Geral'}</td>
              <td>
                <span class="lote-tag">
                  <i class="fas fa-tag"></i> ${lote}
                </span>
              </td>
              <td class="numeric">${item.quantidade_contratada || 0}</td>
              <td class="numeric">${this.formatarMoeda(item.valor_unitario)}</td>
              <td class="numeric">${this.formatarMoeda(item.valor_total || (item.quantidade_contratada * item.valor_unitario))}</td>
              <td class="numeric">${qtdConsumida}</td>
              <td class="numeric ${saldoClass}">${saldo}</td>
              <td>
                <div class="progresso-container">
                  <div class="progresso-bar" style="width: ${percentual}%;"></div>
                </div>
                <span style="font-size: 0.7rem;">${percentual}%</span>
              </td>
              <td>
                <div class="consumo-autarquias">
                  ${consumoPrefeitura > 0 ? `<div class="consumo-item"><span class="consumo-label">Pref:</span> ${consumoPrefeitura}</div>` : ''}
                  ${consumoCamara > 0 ? `<div class="consumo-item"><span class="consumo-label">C√¢m:</span> ${consumoCamara}</div>` : ''}
                  ${consumoSAAE > 0 ? `<div class="consumo-item"><span class="consumo-label">SAAE:</span> ${consumoSAAE}</div>` : ''}
                </div>
              </td>
              <td>
                <div class="acoes-item">
                  ${podeConsumir && saldo > 0 ? `
                    <button class="btn-consumo" onclick="event.stopPropagation(); sistema.abrirModalConsumo(${ata.id}, ${item.id})">
                      <i class="fas fa-pen"></i> Lan√ßar Consumo
                    </button>
                  ` : ''}

                  ${podePedir && saldo > 0 ? `
                    <div style="display: flex; gap: 5px; flex-direction: column;">
                      <input type="number" id="qtd-${ata.id}-${item.id}" min="1" max="${saldo}" 
                             placeholder="Qtd" style="width: 80px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                      <button class="btn-pedido" onclick="sistema.adicionarAoCarrinho(${ata.id}, ${item.id})">
                        <i class="fas fa-cart-plus"></i> Adicionar
                      </button>
                    </div>
                  ` : ''}
                </div>
              </td>
            </tr>
          `;
        }

        // ===== GEST√ÉO DE ITENS =====
        async carregarSelectsGestao() {
          const select = document.getElementById("selectAtaGestao");
          if (!select) return;

          select.innerHTML =
            '<option value="">üîç Selecione uma ata...</option>';

          const { data: atas } = await supabaseClient
            .from('atas')
            .select('id, numero_ata, fornecedor:fornecedores(razao_social)')
            .in('situacao', ['ATIVA', 'PROXIMA'])
            .order('numero_ata');

          atas?.forEach((ata) => {
            const option = document.createElement("option");
            option.value = ata.id;
            option.textContent = `${ata.numero_ata} - ${ata.fornecedor?.razao_social || ''}`;
            select.appendChild(option);
          });
        }

        async carregarItensGestao() {
          const select = document.getElementById("selectAtaGestao");
          const ataId = select.value;

          if (!ataId) {
            document.getElementById("itensGestaoContainer").innerHTML = "";
            this.atualizarStatsGestao(null);
            return;
          }

          const { data: ata } = await supabaseClient
            .from('atas')
            .select('*, itens:itens_ata(*)')
            .eq('id', ataId)
            .single();

          this.ataSelecionada = ata;
          this.atualizarStatsGestao(ata);
          this.filtrarItensGestao();
        }

        atualizarStatsGestao(ata) {
          if (!ata) {
            document.getElementById("gestaoAtaNome").innerHTML = "Nenhuma";
            document.getElementById("gestaoTotalItens").innerHTML = "0";
            document.getElementById("gestaoItensComSaldo").innerHTML = "0";
            document.getElementById("gestaoItensCriticos").innerHTML = "0";
            return;
          }

          document.getElementById(
            "gestaoAtaNome"
          ).innerHTML = `${ata.numero_ata} - ${ata.fornecedor?.razao_social || ''}`;
          document.getElementById("gestaoTotalItens").innerHTML =
            ata.itens.length;

          let itensComSaldo = 0;
          let itensCriticos = 0;

          ata.itens.forEach((item) => {
            if (item.saldo_quantidade > 0) itensComSaldo++;
            if (item.saldo_quantidade > 0 && item.saldo_quantidade <= item.quantidade_contratada * 0.1)
              itensCriticos++;
          });

          document.getElementById("gestaoItensComSaldo").innerHTML =
            itensComSaldo;
          document.getElementById("gestaoItensCriticos").innerHTML =
            itensCriticos;
        }

        filtrarItensGestao() {
          if (!this.ataSelecionada) return;

          const filtro =
            document.getElementById("filtroStatusGestao")?.value || "todos";

          let itensFiltrados = [...this.ataSelecionada.itens];

          if (filtro === "disponivel") {
            itensFiltrados = itensFiltrados.filter((item) => {
              return item.saldo_quantidade > 0;
            });
          } else if (filtro === "critico") {
            itensFiltrados = itensFiltrados.filter((item) => {
              return item.saldo_quantidade > 0 && item.saldo_quantidade <= item.quantidade_contratada * 0.1;
            });
          } else if (filtro === "esgotado") {
            itensFiltrados = itensFiltrados.filter((item) => {
              return item.saldo_quantidade <= 0;
            });
          }

          this.renderizarItensGestao(itensFiltrados);
        }

        renderizarItensGestao(itens) {
          const container = document.getElementById("itensGestaoContainer");

          if (itens.length === 0) {
            container.innerHTML = `
              <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
                <i class="fas fa-box-open" style="font-size: 4rem; color: #94a3b8; margin-bottom: 20px;"></i>
                <h3 style="margin-bottom: 10px;">Nenhum item encontrado</h3>
                <p style="color: #64748b;">Tente outro filtro ou selecione outra ata</p>
              </div>
            `;
            return;
          }

          container.innerHTML = `
            <table class="gestao-tabela">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Descri√ß√£o</th>
                  <th>Lote</th>
                  <th class="numeric">Contratado</th>
                  <th class="numeric">Consumido</th>
                  <th class="numeric">Saldo</th>
                  <th class="numeric">Valor Unit.</th>
                  <th class="numeric">Valor Total</th>
                  <th>Status</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                ${itens.map((item) => {
                  const saldo = item.saldo_quantidade || 0;
                  const consumido = (item.quantidade_contratada || 0) - saldo;
                  const lote = item.lote_numero || this.gerarLote(this.ataSelecionada.numero_ata, item.item_numero);
                  const isCritico = saldo > 0 && saldo <= (item.quantidade_contratada * 0.1);
                  const percentual = item.quantidade_contratada > 0 ? (((item.quantidade_contratada - saldo) / item.quantidade_contratada) * 100).toFixed(1) : 0;

                  let statusClass = "saldo-alto";
                  let statusText = "Normal";
                  if (saldo <= 0) {
                    statusClass = "saldo-zerado";
                    statusText = "Esgotado";
                  } else if (isCritico) {
                    statusClass = "saldo-baixo";
                    statusText = "Cr√≠tico";
                  }

                  const podeConsumir =
                    this.usuarioAtual?.perfil === "ADMIN" ||
                    this.usuarioAtual?.perfil === "ESTAGIARIO";

                  return `
                    <tr>
                      <td class="numeric" style="font-weight: 600;">${item.item_numero || ''}</td>
                      <td style="max-width: 400px;">${item.descricao || ''}</td>
                      <td><span class="lote-tag">${lote}</span></td>
                      <td class="numeric">${item.quantidade_contratada || 0}</td>
                      <td class="numeric">${consumido}</td>
                      <td class="numeric ${statusClass}" style="font-weight: 700;">${saldo}</td>
                      <td class="numeric">${this.formatarMoeda(item.valor_unitario)}</td>
                      <td class="numeric">${this.formatarMoeda(item.valor_total || (item.quantidade_contratada * item.valor_unitario))}</td>
                      <td>
                        <span class="status-badge ${statusClass}" style="background: ${saldo <= 0 ? '#fee2e2' : isCritico ? '#fef9c3' : '#dcfce7'};">
                          ${statusText} (${percentual}%)
                        </span>
                      </td>
                      <td>
                        ${saldo > 0 && podeConsumir ? `
                          <button class="btn-lancar-rapido" onclick="sistema.abrirModalConsumo(${this.ataSelecionada.id}, ${item.id})">
                            <i class="fas fa-pen"></i> Lan√ßar Consumo
                          </button>
                        ` : saldo <= 0 ? `
                          <span style="color: #dc2626; font-size: 0.85rem; font-weight: 600;">üî¥ ESGOTADO</span>
                        ` : ''}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }

        // ===== LAN√áAMENTO DE CONSUMO =====
        async abrirModalConsumo(ataId, itemId) {
          const { data: item } = await supabaseClient
            .from('itens_ata')
            .select('*')
            .eq('id', itemId)
            .single();

          const saldo = item.saldo_quantidade || 0;

          document.getElementById("modalConsumoConteudo").innerHTML = `
            <div style="margin-bottom: 25px;">
              <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Ata:</strong> ${this.ataSelecionada.numero_ata} - ${this.ataSelecionada.fornecedor?.razao_social}</p>
                <p><strong>Item:</strong> ${item.descricao}</p>
                <p><strong>Lote:</strong> <span class="lote-tag">${item.lote_numero || this.gerarLote(this.ataSelecionada.numero_ata, item.item_numero)}</span></p>
                <p><strong>Saldo dispon√≠vel:</strong> <span style="color: #059669; font-weight: 700;">${saldo} unidades</span></p>
                <p><strong>Valor unit√°rio:</strong> ${this.formatarMoeda(item.valor_unitario)}</p>
              </div>

              <div class="filtro-grupo" style="margin-bottom: 15px;">
                <label class="filtro-label">Autarquia</label>
                <select id="autarquiaConsumo" class="filtro-select">
                  <option value="1">Prefeitura</option>
                  <option value="2">C√¢mara</option>
                  <option value="3">SAAE</option>
                </select>
              </div>

              <div class="filtro-grupo" style="margin-bottom: 15px;">
                <label class="filtro-label">Quantidade</label>
                <input type="number" id="quantidadeConsumo" class="filtro-input" min="1" max="${saldo}" placeholder="Digite a quantidade">
              </div>

              <div class="filtro-grupo" style="margin-bottom: 15px;">
                <label class="filtro-label">Observa√ß√£o (opcional)</label>
                <input type="text" id="obsConsumo" class="filtro-input" placeholder="Ex: Protocolo, requisi√ß√£o...">
              </div>

              <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button class="btn" style="background: #e2e8f0;" onclick="sistema.fecharModalConsumo()">Cancelar</button>
                <button class="btn-consumo" onclick="sistema.registrarConsumo(${ataId}, ${itemId})">
                  <i class="fas fa-save"></i> Registrar Consumo
                </button>
              </div>
            </div>
          `;

          document.getElementById("modalConsumo").classList.add("active");
        }

        async registrarConsumo(ataId, itemId) {
          const quantidade = parseInt(
            document.getElementById("quantidadeConsumo").value
          );
          const orgaoId = parseInt(document.getElementById("autarquiaConsumo").value);
          const obs = document.getElementById("obsConsumo").value;

          if (!quantidade || quantidade <= 0) {
            alert("Por favor, informe uma quantidade v√°lida!");
            return;
          }

          try {
            const { data, error } = await supabaseClient
              .rpc('sp_registrar_consumo', {
                p_usuario_id: this.usuarioAtual.id,
                p_ata_id: ataId,
                p_item_ata_id: itemId,
                p_orgao_id: orgaoId,
                p_quantidade: quantidade,
                p_observacao: obs
              });

            if (error) throw error;

            alert("‚úÖ Consumo registrado com sucesso!");

            // Atualizar interface
            this.fecharModalConsumo();
            if (this.ataSelecionada?.id === ataId) {
              this.abrirDetalhes(ataId);
            }
            await this.carregarAtas();

            if (this.ataSelecionada?.id === ataId) {
              this.atualizarStatsGestao(this.ataSelecionada);
              this.filtrarItensGestao();
            }
          } catch (error) {
            alert("Erro ao registrar consumo: " + error.message);
          }
        }

        // ===== CARRINHO E PEDIDOS =====
        adicionarAoCarrinho(ataId, itemId) {
          const quantidadeInput = document.getElementById(
            `qtd-${ataId}-${itemId}`
          );
          if (!quantidadeInput) return;

          const quantidade = parseInt(quantidadeInput.value);

          if (!quantidade || quantidade <= 0) {
            alert("Informe uma quantidade v√°lida!");
            return;
          }

          const ata = this.ataSelecionada;
          const item = ata.itens.find(i => i.id === itemId);
          const saldo = item.saldo_quantidade || 0;

          if (quantidade > saldo) {
            alert(
              `Quantidade maior que o saldo dispon√≠vel (${saldo} unidades)!`
            );
            return;
          }

          const numeroPedido = `PED-${new Date().getFullYear()}-${String(
            this.pedidosGerados.length + 1
          ).padStart(4, "0")}`;

          this.carrinho.push({
            id: `${ataId}-${itemId}-${Date.now()}`,
            ataId: ata.id,
            ataNumero: ata.numero_ata,
            fornecedor: ata.fornecedor_id,
            fornecedorCnpj: ata.fornecedor?.cnpj,
            fornecedorEndereco: ata.fornecedor?.endereco,
            fornecedorTelefone: ata.fornecedor?.telefone,
            fornecedorEmail: ata.fornecedor?.email,
            processo: ata.processo_administrativo,
            objeto: ata.objeto,
            itemId: item.id,
            itemDescricao: item.descricao,
            itemCategoria: item.categoria,
            lote: item.lote_numero || this.gerarLote(ata.numero_ata, item.item_numero),
            quantidade: quantidade,
            valorUnitario: item.valor_unitario,
            valorTotal: item.valor_unitario * quantidade,
            numeroPedido: numeroPedido,
            data: new Date().toISOString().split("T")[0],
            solicitante: this.usuarioAtual?.nome || "Usu√°rio",
            orgao_solicitante: this.usuarioAtual?.orgao?.nome || "N√£o informado",
          });

          quantidadeInput.value = "";

          this.atualizarCarrinho();

          alert("‚úÖ Item adicionado ao carrinho!");
        }

        atualizarCarrinho() {
          document.getElementById("carrinhoCount").innerHTML =
            this.carrinho.length;
          document.getElementById("carrinhoIndicator").style.display =
            this.carrinho.length > 0 &&
            (this.usuarioAtual?.perfil === "SECRETARIO" ||
              this.usuarioAtual?.perfil === "SOLICITANTE")
              ? "flex"
              : "none";
        }

        abrirCarrinho() {
          const pedidosPorAta = {};

          this.carrinho.forEach((item) => {
            if (!pedidosPorAta[item.ataId]) {
              pedidosPorAta[item.ataId] = {
                ataNumero: item.ataNumero,
                fornecedor: item.fornecedor,
                fornecedorCnpj: item.fornecedorCnpj,
                fornecedorEndereco: item.fornecedorEndereco,
                fornecedorTelefone: item.fornecedorTelefone,
                fornecedorEmail: item.fornecedorEmail,
                processo: item.processo,
                objeto: item.objeto,
                itens: [],
              };
            }
            pedidosPorAta[item.ataId].itens.push(item);
          });

          let html = "";

          for (const [ataId, pedido] of Object.entries(pedidosPorAta)) {
            const totalPedido = pedido.itens.reduce(
              (sum, item) => sum + item.valorTotal,
              0
            );

            html += `
              <div style="background: #f8fafc; padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <div>
                    <h3 style="color: #0f172a; margin-bottom: 8px;">
                      <i class="fas fa-file-contract"></i> Ata n¬∫ ${pedido.ataNumero}
                    </h3>
                    <p style="color: #475569;"><strong>Fornecedor:</strong> ${pedido.fornecedor}</p>
                    <p style="color: #475569;"><strong>CNPJ:</strong> ${pedido.fornecedorCnpj}</p>
                    <p style="color: #475569; font-size: 0.9rem;">${pedido.objeto}</p>
                  </div>
                  <div style="text-align: right;">
                    <span style="background: #2563eb; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700;">
                      Total: ${this.formatarMoeda(totalPedido)}
                    </span>
                  </div>
                </div>

                <div class="tabela-container">
                  <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                      <tr style="background: #e2e8f0;">
                        <th style="padding: 12px; text-align: left;">N¬∫ Item</th>
                        <th style="padding: 12px; text-align: left;">Lote</th>
                        <th style="padding: 12px; text-align: left;">Descri√ß√£o</th>
                        <th style="padding: 12px; text-align: right;">Quantidade</th>
                        <th style="padding: 12px; text-align: right;">Valor Unit.</th>
                        <th style="padding: 12px; text-align: right;">Valor Total</th>
                        <th style="padding: 12px; text-align: center;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      ${pedido.itens.map((item) => `
                        <tr>
                          <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${item.itemId}</td>
                          <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                            <span class="lote-tag">${item.lote}</span>
                          </td>
                          <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${item.itemDescricao}</td>
                          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${item.quantidade}</td>
                          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${this.formatarMoeda(item.valorUnitario)}</td>
                          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${this.formatarMoeda(item.valorTotal)}</td>
                          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0;">
                            <button onclick="sistema.removerDoCarrinho('${item.id}')" 
                                    style="background: none; border: none; color: #dc2626; cursor: pointer;">
                              <i class="fas fa-trash"></i>
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }

          html += `
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button class="btn" style="background: #e2e8f0;" onclick="sistema.limparCarrinho()">
                <i class="fas fa-trash"></i> Limpar Carrinho
              </button>
              <button class="btn-gerar-pedido" onclick="sistema.gerarPedidos()">
                <i class="fas fa-file-invoice"></i> Gerar Pedido(s)
              </button>
            </div>
          `;

          document.getElementById("modalCarrinhoConteudo").innerHTML = html;
          document.getElementById("modalCarrinho").classList.add("active");
        }

        removerDoCarrinho(itemId) {
          const index = this.carrinho.findIndex((item) => item.id === itemId);
          if (index !== -1) {
            this.carrinho.splice(index, 1);
            this.atualizarCarrinho();
            this.abrirCarrinho();
          }
        }

        limparCarrinho() {
          this.carrinho = [];
          this.atualizarCarrinho();
          this.fecharModalCarrinho();
        }

        async gerarPedidos() {
          if (this.carrinho.length === 0) return;

          const pedidosPorAta = {};

          this.carrinho.forEach((item) => {
            if (!pedidosPorAta[item.ataId]) {
              pedidosPorAta[item.ataId] = {
                ataNumero: item.ataNumero,
                fornecedor: item.fornecedor,
                fornecedorCnpj: item.fornecedorCnpj,
                fornecedorEndereco: item.fornecedorEndereco,
                fornecedorTelefone: item.fornecedorTelefone,
                fornecedorEmail: item.fornecedorEmail,
                processo: item.processo,
                objeto: item.objeto,
                itens: [],
              };
            }
            pedidosPorAta[item.ataId].itens.push(item);
          });

          let pedidosHtml = "";
          const dataAtual = new Date().toLocaleDateString("pt-BR");
          this.pdfData = [];

          for (const [ataId, pedido] of Object.entries(pedidosPorAta)) {
            const totalPedido = pedido.itens.reduce(
              (sum, item) => sum + item.valorTotal,
              0
            );
            const numeroPedido = `PED-${new Date().getFullYear()}-${String(
              this.pedidosGerados.length + 1
            ).padStart(4, "0")}`;

            this.pdfData.push({
              numeroPedido,
              data: dataAtual,
              pedido,
            });

            pedidosHtml += `
              <div class="pedido-container">
                <div class="pedido-header">
                  <div>
                    <h2 class="pedido-titulo">
                      <i class="fas fa-file-invoice"></i> PEDIDO DE COMPRA N¬∫ ${numeroPedido}
                    </h2>
                    <p class="pedido-subtitulo">
                      Data: ${dataAtual} | Processo: ${pedido.processo} | Ata: ${pedido.ataNumero}
                    </p>
                  </div>
                  <span class="status-badge status-ativa" style="font-size: 0.9rem; padding: 8px 16px;">
                    AGUARDANDO AUTORIZA√á√ÉO
                  </span>
                </div>

                <div class="pedido-info-grid">
                  <div>
                    <p style="font-weight: 700; color: #475569; margin-bottom: 8px;">DADOS DA ATA</p>
                    <p><strong>Ata n¬∫:</strong> ${pedido.ataNumero}</p>
                    <p><strong>Processo:</strong> ${pedido.processo}</p>
                    <p><strong>Objeto:</strong> ${pedido.objeto}</p>
                  </div>
                  <div>
                    <p style="font-weight: 700; color: #475569; margin-bottom: 8px;">DADOS DO FORNECEDOR</p>
                    <p><strong>Raz√£o Social:</strong> ${pedido.fornecedor}</p>
                    <p><strong>CNPJ:</strong> ${pedido.fornecedorCnpj}</p>
                    <p><strong>Endere√ßo:</strong> ${pedido.fornecedorEndereco}</p>
                    <p><strong>Telefone:</strong> ${pedido.fornecedorTelefone}</p>
                    <p><strong>E-mail:</strong> ${pedido.fornecedorEmail}</p>
                  </div>
                  <div>
                    <p style="font-weight: 700; color: #475569; margin-bottom: 8px;">DADOS DO SOLICITANTE</p>
                    <p><strong>Solicitante:</strong> ${this.usuarioAtual?.nome || "Usu√°rio"}</p>
                    <p><strong>√ìrg√£o:</strong> ${this.usuarioAtual?.orgao?.nome || "N√£o informado"}</p>
                    <p><strong>Perfil:</strong> ${this.usuarioAtual?.perfil || "Usu√°rio"}</p>
                  </div>
                </div>

                <h4 style="margin-bottom: 15px; color: #0f172a;">
                  <i class="fas fa-boxes"></i> Itens do Pedido
                </h4>

                <div class="tabela-container">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #1e293b; color: white;">
                        <th style="padding: 12px; text-align: left;">N¬∫ Item</th>
                        <th style="padding: 12px; text-align: left;">Lote</th>
                        <th style="padding: 12px; text-align: left;">Descri√ß√£o</th>
                        <th style="padding: 12px; text-align: right;">Quantidade</th>
                        <th style="padding: 12px; text-align: right;">Valor Unit√°rio</th>
                        <th style="padding: 12px; text-align: right;">Valor Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${pedido.itens.map((item) => `
                        <tr>
                          <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${item.itemId}</td>
                          <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                            <span class="lote-tag">${item.lote}</span>
                          </td>
                          <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${item.itemDescricao}</td>
                          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${item.quantidade}</td>
                          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${this.formatarMoeda(item.valorUnitario)}</td>
                          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${this.formatarMoeda(item.valorTotal)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                    <tfoot>
                      <tr style="background: #f8fafc;">
                        <td colspan="5" style="padding: 15px; text-align: right; font-weight: 700; font-size: 1.1rem;">
                          VALOR TOTAL DO PEDIDO
                        </td>
                        <td style="padding: 15px; text-align: right; font-weight: 700; font-size: 1.1rem; color: #059669;">
                          ${this.formatarMoeda(totalPedido)}
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div style="margin-top: 25px; padding: 15px; background: #fff3cd; border-left: 4px solid #d97706; border-radius: 4px;">
                  <p style="color: #854d0e; margin: 0;">
                    <strong><i class="fas fa-info-circle"></i> Observa√ß√£o:</strong> 
                    Este pedido n√£o altera o saldo da ata. Consumo deve ser lan√ßado separadamente pelo perfil adequado.
                  </p>
                </div>
              </div>
            `;

            // Salvar no banco
            try {
              const { data: pedidoData, error } = await supabaseClient
                .from('pedidos')
                .insert({
                  numero_pedido: numeroPedido,
                  usuario_id: this.usuarioAtual.id,
                  orgao_solicitante_id: this.usuarioAtual.orgao_id,
                  ata_id: parseInt(ataId),
                  fornecedor_id: pedido.fornecedor,
                  data_solicitacao: new Date().toISOString().split('T')[0],
                  status: 'AGUARDANDO_APROVACAO'
                })
                .select()
                .single();

              if (!error && pedidoData) {
                for (const item of pedido.itens) {
                  await supabaseClient
                    .from('itens_pedido')
                    .insert({
                      pedido_id: pedidoData.id,
                      item_ata_id: item.itemId,
                      lote_numero: item.lote,
                      quantidade_solicitada: item.quantidade,
                      valor_unitario: item.valorUnitario,
                      valor_total: item.valorTotal
                    });
                }
              }
            } catch (error) {
              console.error('Erro ao salvar pedido:', error);
            }

            this.pedidosGerados.push({
              numero: numeroPedido,
              data: dataAtual,
              ata: pedido.ataNumero,
              fornecedor: pedido.fornecedor,
              valor: totalPedido,
              solicitante: this.usuarioAtual?.nome,
            });
          }

          pedidosHtml += `
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button class="btn" style="background: #e2e8f0;" onclick="sistema.fecharModalPedido()">
                Fechar
              </button>
              <button class="btn-pdf" onclick="sistema.visualizarPDF()">
                <i class="fas fa-file-pdf"></i> Visualizar PDF
              </button>
            </div>
          `;

          document.getElementById("modalPedidoConteudo").innerHTML =
            pedidosHtml;
          this.fecharModalCarrinho();
          document.getElementById("modalPedido").classList.add("active");

          this.carrinho = [];
          this.atualizarCarrinho();
          this.carregarPedidos();
        }

        async carregarPedidos() {
          const container = document.getElementById("pedidosLista");

          const { data: pedidos } = await supabaseClient
            .from('pedidos')
            .select('*, usuario:usuarios(nome)')
            .eq('usuario_id', this.usuarioAtual?.id)
            .order('created_at', { ascending: false });

          if (!pedidos || pedidos.length === 0) {
            container.innerHTML = `
              <div style="text-align: center; padding: 60px; background: white; border-radius: 12px; grid-column: 1/-1;">
                <i class="fas fa-file-invoice" style="font-size: 4rem; color: #94a3b8; margin-bottom: 15px;"></i>
                <h3 style="margin-bottom: 10px;">Nenhum pedido gerado</h3>
                <p style="color: #64748b;">Os pedidos aparecer√£o aqui ap√≥s serem gerados no carrinho</p>
              </div>
            `;
            return;
          }

          container.innerHTML = pedidos
            .map((pedido) => `
              <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <div>
                    <span style="background: #2563eb; color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">
                      ${pedido.numero_pedido}
                    </span>
                    <span style="margin-left: 10px; color: #64748b; font-size: 0.85rem;">
                      <i class="fas fa-calendar"></i> ${this.formatarData(pedido.data_solicitacao)}
                    </span>
                  </div>
                  <span style="background: #d1fae5; color: #065f46; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem;">
                    ${pedido.status || 'Processado'}
                  </span>
                </div>
                <p style="font-weight: 600; margin-bottom: 5px;">Ata n¬∫ ${pedido.ata_id}</p>
                <p style="color: #475569; font-size: 0.9rem; margin-bottom: 5px;">${pedido.fornecedor_id}</p>
                <p style="color: #475569; font-size: 0.8rem; margin-bottom: 10px;">
                  <i class="fas fa-user"></i> ${pedido.usuario?.nome || 'Usu√°rio'}
                </p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 700; color: #059669;">${this.formatarMoeda(pedido.valor_total)}</span>
                  <button class="btn-visualizar" onclick="sistema.visualizarPedido('${pedido.numero_pedido}')" style="padding: 5px 12px;">
                    <i class="fas fa-eye"></i> Ver Pedido
                  </button>
                </div>
              </div>
            `).join("");
        }

        visualizarPedido(numeroPedido) {
          const pedido = this.pdfData?.find(
            (p) => p.numeroPedido === numeroPedido
          );
          if (pedido) {
            this.pdfData = [pedido];
            this.visualizarPDF();
            this.pdfData = null;
          }
        }

        // ===== PDF =====
        visualizarPDF() {
          if (!this.pdfData || this.pdfData.length === 0) return;

          let pdfHtml = "";

          this.pdfData.forEach((item) => {
            const pedido = item.pedido;
            const totalPedido = pedido.itens.reduce(
              (sum, i) => sum + i.valorTotal,
              0
            );

            pdfHtml += `
              <div class="pdf-pagina">
                <div style="text-align: center; margin-bottom: 30px;">
                  <h1 style="color: #0f172a; font-size: 1.8rem; margin-bottom: 5px;">PEDIDO DE COMPRA</h1>
                  <p style="color: #475569; font-size: 1rem;">N¬∫ ${item.numeroPedido}</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                  <div>
                    <p style="font-weight: 700; color: #475569; margin-bottom: 5px;">FORNECEDOR:</p>
                    <p>${pedido.fornecedor}</p>
                    <p>CNPJ: ${pedido.fornecedorCnpj}</p>
                    <p>${pedido.fornecedorEndereco}</p>
                    <p>Tel: ${pedido.fornecedorTelefone}</p>
                    <p>E-mail: ${pedido.fornecedorEmail}</p>
                  </div>
                  <div>
                    <p style="font-weight: 700; color: #475569; margin-bottom: 5px;">DADOS DO PEDIDO:</p>
                    <p><strong>Ata:</strong> ${pedido.ataNumero}</p>
                    <p><strong>Processo:</strong> ${pedido.processo}</p>
                    <p><strong>Data:</strong> ${item.data}</p>
                    <p><strong>Solicitante:</strong> ${this.usuarioAtual?.nome || "Usu√°rio"}</p>
                    <p><strong>√ìrg√£o:</strong> ${this.usuarioAtual?.orgao?.nome || "N√£o informado"}</p>
                  </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                  <thead>
                    <tr style="background: #0f172a; color: white;">
                      <th style="padding: 12px; text-align: left;">Item</th>
                      <th style="padding: 12px; text-align: left;">Lote</th>
                      <th style="padding: 12px; text-align: left;">Descri√ß√£o</th>
                      <th style="padding: 12px; text-align: right;">Qtd</th>
                      <th style="padding: 12px; text-align: right;">Valor Unit.</th>
                      <th style="padding: 12px; text-align: right;">Valor Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pedido.itens.map(i => `
                      <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${i.itemId}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${i.lote}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${i.itemDescricao}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">${i.quantidade}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">${this.formatarMoeda(i.valorUnitario)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">${this.formatarMoeda(i.valorTotal)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="5" style="padding: 15px; text-align: right; font-weight: 700; font-size: 1.1rem;">
                        TOTAL DO PEDIDO
                      </td>
                      <td style="padding: 15px; text-align: right; font-weight: 700; font-size: 1.1rem; color: #059669;">
                        ${this.formatarMoeda(totalPedido)}
                      </td>
                    </tr>
                  </tfoot>
                </table>

                <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                  <div style="text-align: center;">
                    <p>__________________________</p>
                    <p style="font-weight: 600;">SOLICITANTE</p>
                    <p style="font-size: 0.8rem;">${this.usuarioAtual?.nome || "Usu√°rio"}</p>
                  </div>
                  <div style="text-align: center;">
                    <p>__________________________</p>
                    <p style="font-weight: 600;">AUTORIZA√á√ÉO</p>
                  </div>
                  <div style="text-align: center;">
                    <p>__________________________</p>
                    <p style="font-weight: 600;">FORNECEDOR</p>
                  </div>
                </div>
              </div>
            `;
          });

          document.getElementById("pdfConteudo").innerHTML = pdfHtml;
          document.getElementById("pdfVisualizador").classList.add("active");
        }

        baixarPDF() {
          alert(
            "‚úÖ PDF gerado com sucesso! (Simula√ß√£o - Backend necess√°rio para download real)\n\nO PDF seria baixado contendo:\n‚Ä¢ N√∫mero do pedido\n‚Ä¢ Dados do fornecedor\n‚Ä¢ Itens com lote\n‚Ä¢ Quantidades e valores\n‚Ä¢ Valor total"
          );
        }

        fecharPdfVisualizador() {
          document.getElementById("pdfVisualizador").classList.remove("active");
        }

        // ===== GEST√ÉO DE USU√ÅRIOS =====
        async carregarTabelaUsuarios() {
          const tbody = document.getElementById("tabelaUsuariosBody");
          if (!tbody) return;

          const { data: usuarios } = await supabaseClient
            .from('usuarios')
            .select('*, orgao:orgaos(*)')
            .eq('ativo', true)
            .order('nome');

          if (!usuarios || usuarios.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">Nenhum usu√°rio encontrado</td></tr>';
            return;
          }

          tbody.innerHTML = usuarios
            .map((user) => {
              const perfilClass = {
                ADMIN: "perfil-admin",
                SECRETARIO: "perfil-secretario",
                SOLICITANTE: "perfil-solicitante",
                ESTAGIARIO: "perfil-estagiario",
              }[user.perfil];

              return `
                <tr>
                  <td><strong>${user.nome}</strong></td>
                  <td>${user.email}</td>
                  <td>${user.orgao?.nome || ''}</td>
                  <td>
                    <span class="badge-perfil ${perfilClass}">
                      ${user.perfil}
                    </span>
                  </td>
                  <td>
                    <span style="color: #059669;"><i class="fas fa-circle"></i> Ativo</span>
                  </td>
                  <td>
                    ${user.id !== this.usuarioAtual?.id ? `
                      <button class="btn-desativar" onclick="sistema.desativarUsuario(${user.id})">
                        <i class="fas fa-trash"></i>
                      </button>
                    ` : ''}
                  </td>
                </tr>
              `;
            })
            .join("");
        }

        abrirModalUsuario(usuarioId = null) {
          if (usuarioId) {
            // Editar - implementar depois
          } else {
            document.getElementById("modalUsuarioTitulo").innerHTML =
              '<i class="fas fa-user-plus"></i> Novo Usu√°rio';
            document.getElementById("usuarioId").value = "";
            document.getElementById("usuarioNome").value = "";
            document.getElementById("usuarioEmail").value = "";
            document.getElementById("usuarioSenha").value = "";
            document.getElementById("usuarioOrgao").value = "1";
            document.getElementById("usuarioPerfil").value = "SOLICITANTE";
          }

          document.getElementById("modalUsuario").classList.add("active");
        }

        fecharModalUsuario() {
          document.getElementById("modalUsuario").classList.remove("active");
        }

        async salvarUsuario() {
          const nome = document.getElementById("usuarioNome").value;
          const email = document.getElementById("usuarioEmail").value;
          const senha = document.getElementById("usuarioSenha").value;
          const orgaoId = parseInt(document.getElementById("usuarioOrgao").value);
          const perfil = document.getElementById("usuarioPerfil").value;

          if (!nome || !email || !senha || !orgaoId || !perfil) {
            alert("Preencha todos os campos!");
            return;
          }

          try {
            // 1. Criar no Auth
            const { data: authData, error: authError } = await supabaseClient.auth.signUp({
              email: email,
              password: senha,
              options: {
                data: { name: nome }
              }
            });

            if (authError) throw authError;

            // 2. Inserir na tabela usuarios
            const { error: insertError } = await supabaseClient
              .from('usuarios')
              .insert({
                uuid: authData.user.id,
                nome: nome,
                email: email,
                perfil: perfil,
                orgao_id: orgaoId,
                ativo: true
              });

            if (insertError) throw insertError;

            alert("‚úÖ Usu√°rio criado com sucesso!");
            this.fecharModalUsuario();
            await this.carregarTabelaUsuarios();

          } catch (error) {
            alert("Erro ao criar usu√°rio: " + error.message);
          }
        }

        async desativarUsuario(id) {
          if (!confirm("Tem certeza que deseja desativar este usu√°rio?")) return;

          const { error } = await supabaseClient
            .from('usuarios')
            .update({ ativo: false })
            .eq('id', id);

          if (error) {
            alert("Erro ao desativar usu√°rio: " + error.message);
          } else {
            alert("‚úÖ Usu√°rio desativado com sucesso!");
            await this.carregarTabelaUsuarios();
          }
        }

        // ===== UTILIT√ÅRIOS =====
        formatarMoeda(valor) {
          if (!valor && valor !== 0) return "R$ 0,00";
          return valor.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
            minimumFractionDigits: 2,
          });
        }

        formatarData(dataISO) {
          if (!dataISO) return "";
          try {
            const data = new Date(dataISO);
            return data.toLocaleDateString("pt-BR");
          } catch {
            return "";
          }
        }

        gerarLote(ataNumero, itemId) {
          const ano = new Date().getFullYear();
          const numeroFormatado = ataNumero?.split("/")[0]?.padStart(3, "0") || "000";
          const itemFormatado = itemId?.toString().padStart(3, "0") || "000";
          return `LOTE-${ano}/${numeroFormatado}-${itemFormatado}`;
        }

        // ===== M√âTODOS DE COMPATIBILIDADE (MANTIDOS) =====
        alternarPerfil(perfil, event) {
          if (this.usuarioAtual) {
            alert(
              "O perfil √© definido pelo login. Use o menu de usu√°rio para trocar de conta."
            );
            return;
          }

          this.perfilAtual = perfil;

          document.querySelectorAll(".btn-perfil").forEach((btn) => {
            btn.classList.remove("active");
          });
          event.currentTarget.classList.add("active");

          const podeCadastrar = perfil === "admin" || perfil === "estagiario";
          const btnExtracao = document.getElementById("btnExtracao");
          if (btnExtracao) {
            btnExtracao.style.display = podeCadastrar ? "flex" : "none";
          }

          document.getElementById("carrinhoIndicator").style.display =
            perfil === "secretario" && this.carrinho.length > 0
              ? "flex"
              : "none";
        }

        filtrarAtas() {
          this.carregarAtas();
        }

        fecharModal() {
          document.getElementById("modalDetalhes").classList.remove("active");
          this.ataSelecionada = null;
        }

        fecharModalConsumo() {
          document.getElementById("modalConsumo").classList.remove("active");
        }

        fecharModalCarrinho() {
          document.getElementById("modalCarrinho").classList.remove("active");
        }

        fecharModalPedido() {
          document.getElementById("modalPedido").classList.remove("active");
          this.pdfData = null;
        }

        // ===== CADASTRO DE ATAS (MANTIDO PARA COMPATIBILIDADE) =====
        carregarItensCadastroIniciais() {}
        adicionarItemCadastro() {}
        removerItemCadastro() {}
        calcularTotaisItem() {}
        atualizarValorTotalAta() {}
        salvarAta() { alert("Cadastro de atas ser√° implementado em breve!"); }
        limparFormularioCadastro() {}
        executarExtracaoPDF() { alert("Extra√ß√£o de PDF ser√° implementada em breve!"); }
        editarUsuario() {}
      }

      // =========================================
      // INICIALIZA√á√ÉO
      // =========================================
      const sistema = new SistemaGestaoAtas();
    </script>
  </body>
</html>
